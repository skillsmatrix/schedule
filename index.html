<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Business Unit Schedule</title>
    <link rel="icon" type="image/x-icon" href="https://mgroupltd.com/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Brand */
            --brand-primary: #E91388;
            --brand-secondary: #F7941D;
            --brand-gradient: linear-gradient(135deg, #E91388 0%, #F7941D 100%);
            
            /* Neutrals - Light Mode */
            --slate-950: #0f172a;
            --slate-900: #1e293b;
            --slate-800: #1e293b;
            --slate-700: #334155;
            --slate-600: #475569;
            --slate-500: #64748b;
            --slate-400: #94a3b8;
            --slate-300: #cbd5e1;
            --slate-200: #e2e8f0;
            --slate-100: #f1f5f9;
            --slate-50: #f8fafc;
            --white: #ffffff;
            
            /* Surfaces */
            --bg-primary: var(--slate-100);
            --bg-secondary: var(--white);
            --bg-tertiary: var(--slate-50);
            --bg-header: var(--slate-900);
            --text-primary: var(--slate-900);
            --text-secondary: var(--slate-600);
            --text-muted: var(--slate-500);
            --border-color: var(--slate-200);
            --border-strong: var(--slate-300);
        }
        
        /* Dark Mode */
        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-header: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --border-strong: #475569;
            
            --slate-50: #1e293b;
            --slate-100: #334155;
            --slate-200: #475569;
            --slate-700: #cbd5e1;
            --slate-800: #e2e8f0;
            --slate-900: #f1f5f9;
            --white: #1e293b;
            
            /* Adjusted status backgrounds for dark mode */
            --status-leave-bg: rgba(16, 185, 129, 0.2);
            --status-training-bg: rgba(139, 92, 246, 0.2);
            --status-sickness-bg: rgba(244, 63, 94, 0.2);
            --status-office-bg: rgba(14, 165, 233, 0.2);
            --status-night-bg: rgba(99, 102, 241, 0.2);
            --status-rest-bg: rgba(245, 158, 11, 0.2);
            --status-wfh-bg: rgba(20, 184, 166, 0.2);
            --status-travel-bg: rgba(236, 72, 153, 0.2);
        }
            
            /* Status - Modern, distinct */
            --status-leave: #10b981;
            --status-leave-bg: #d1fae5;
            --status-training: #8b5cf6;
            --status-training-bg: #ede9fe;
            --status-sickness: #f43f5e;
            --status-sickness-bg: #ffe4e6;
            --status-office: #0ea5e9;
            --status-office-bg: #e0f2fe;
            --status-night: #6366f1;
            --status-night-bg: #e0e7ff;
            --status-rest: #f59e0b;
            --status-rest-bg: #fef3c7;
            --status-wfh: #14b8a6;
            --status-wfh-bg: #ccfbf1;
            --status-travel: #ec4899;
            --status-travel-bg: #fce7f3;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            transition: background 0.3s ease, color 0.3s ease;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* === HEADER === */
        .header {
            background: var(--brand-gradient);
            padding: 1.25rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0;
            width: 100%;
            box-sizing: border-box;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .logo-section h1 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--white);
            letter-spacing: -0.025em;
        }

        .logo-section p {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.8);
            margin-top: 0.125rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .week-navigator {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            padding: 0.375rem;
            border-radius: 0.75rem;
        }

        .week-navigator button {
            width: 2rem;
            height: 2rem;
            border: none;
            background: rgba(255,255,255,0.1);
            color: var(--white);
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            flex-shrink: 0;
        }

        .week-navigator button:hover {
            background: rgba(255,255,255,0.25);
        }

        .week-navigator .week-display {
            padding: 0 0.75rem;
            color: var(--white);
            font-weight: 600;
            font-size: 0.8125rem;
            text-align: center;
            white-space: nowrap;
        }

        .btn-today {
            background: var(--white);
            color: var(--brand-primary);
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .btn-today:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        /* === TOOLBAR === */
        .toolbar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            transition: background 0.3s ease;
        }

        .filters {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .filter-select {
            padding: 0.5rem 0.75rem;
            padding-right: 2rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 0.8125rem;
            font-family: inherit;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            transition: all 0.15s ease;
        }

        .filter-select:hover {
            border-color: var(--border-strong);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(233, 19, 136, 0.1);
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding: 0.5rem 0.75rem 0.5rem 2.25rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 0.8125rem;
            font-family: inherit;
            width: 200px;
            transition: all 0.15s ease;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .search-box input::placeholder {
            color: var(--text-muted);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(233, 19, 136, 0.1);
            width: 260px;
        }

        .search-box::before {
            content: '';
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            width: 1rem;
            height: 1rem;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='M21 21l-4.35-4.35'/%3E%3C/svg%3E");
            background-size: contain;
        }

        .toolbar-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-icon {
            width: 2.25rem;
            height: 2.25rem;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all 0.15s ease;
            padding: 0;
        }

        .btn-icon svg {
            display: block;
            flex-shrink: 0;
        }

        .btn-icon:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-strong);
        }

        .btn-icon.active {
            background: var(--brand-primary);
            border-color: var(--brand-primary);
            color: var(--white);
        }

        [data-theme="dark"] .btn-icon.active {
            color: #ffffff;
        }

        /* === LEGEND === */
        .legend {
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            padding: 0.5rem 2rem;
            display: flex;
            gap: 1.5rem;
            align-items: center;
            transition: background 0.3s ease;
        }

        .legend-label {
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .legend-items {
            display: flex;
            gap: 1rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.6875rem;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 0.5rem;
            height: 0.5rem;
            border-radius: 50%;
        }

        /* === SCHEDULE GRID === */
        .schedule-wrapper {
            padding: 1.5rem 2rem;
        }

        .schedule-container {
            background: var(--bg-secondary);
            border-radius: 1rem;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            transition: background 0.3s ease;
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: 200px repeat(5, 1fr);
            min-width: 1000px;
        }

        .schedule-grid.show-weekends {
            grid-template-columns: 200px repeat(7, 1fr);
        }

        /* Header row */
        .grid-header {
            display: contents;
        }

        .grid-header-cell {
            background: var(--bg-header);
            padding: 1rem;
            text-align: center;
            color: #ffffff;
            font-weight: 600;
        }

        .grid-header-cell:first-child {
            text-align: left;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--slate-400);
            display: flex;
            align-items: center;
        }

        .grid-header-cell.today {
            background: var(--brand-primary);
        }

        .grid-header-cell.weekend {
            background: var(--slate-700);
        }

        [data-theme="dark"] .grid-header-cell.weekend {
            background: #0f172a;
        }

        .day-name {
            font-size: 0.6875rem;
            font-weight: 500;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .day-date {
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1.2;
            margin-top: 0.125rem;
        }

        .day-month {
            font-size: 0.6875rem;
            font-weight: 500;
            opacity: 0.7;
        }

        /* Person rows */
        .person-row {
            display: contents;
        }

        .person-row:nth-child(odd) .person-cell,
        .person-row:nth-child(odd) .day-cell {
            background: var(--slate-50);
        }

        .person-row:hover .person-cell,
        .person-row:hover .day-cell {
            background: rgba(233, 19, 136, 0.03);
        }

        .person-cell {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 100px;
            cursor: pointer;
            transition: all 0.15s ease;
            position: sticky;
            left: 0;
            background: var(--bg-secondary);
            z-index: 5;
        }

        .person-row:nth-child(odd) .person-cell {
            background: var(--bg-tertiary);
        }

        .person-cell:hover {
            background: var(--slate-100) !important;
        }

        .person-name {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-primary);
            line-height: 1.3;
        }

        .person-role {
            font-size: 0.6875rem;
            color: var(--text-muted);
            margin-top: 0.125rem;
        }

        .person-meta {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.375rem;
        }

        .person-tag {
            font-size: 0.625rem;
            padding: 0.125rem 0.375rem;
            background: var(--border-color);
            color: var(--text-secondary);
            border-radius: 0.25rem;
            font-weight: 500;
        }

        /* Day cells */
        .day-cell {
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            border-left: 1px solid var(--border-color);
            min-height: 100px;
            cursor: pointer;
            transition: all 0.15s ease;
            background: var(--bg-secondary);
        }

        .day-cell:hover {
            background: var(--slate-100) !important;
        }

        .day-cell.drag-over {
            background: rgba(233, 19, 136, 0.15) !important;
            box-shadow: inset 0 0 0 2px var(--brand-primary);
        }

        /* Real-time update highlight */
        .day-cell.cell-updated {
            animation: cellHighlight 1.5s ease-out;
        }

        @keyframes cellHighlight {
            0% {
                background: rgba(233, 19, 136, 0.2);
                box-shadow: inset 0 0 0 2px var(--brand-primary);
            }
            100% {
                background: var(--bg-secondary);
                box-shadow: none;
            }
        }

        .day-cell.weekend {
            background: var(--bg-tertiary);
        }

        .person-row:nth-child(odd) .day-cell {
            background: var(--bg-tertiary);
        }

        .person-row:nth-child(odd) .day-cell.weekend {
            background: var(--slate-100);
        }

        /* === JOB ENTRIES === */
        .job-entry {
            background: var(--bg-secondary);
            border-radius: 0.5rem;
            padding: 0.5rem 0.625rem;
            margin-bottom: 0.375rem;
            border-left: 3px solid var(--brand-primary);
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 0.75rem;
            line-height: 1.4;
        }

        [data-theme="dark"] .job-entry {
            background: var(--slate-100);
        }

        .job-entry:last-child {
            margin-bottom: 0;
        }

        .job-entry:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        /* Full display (1-2 jobs) */
        .job-entry.full .job-q {
            font-weight: 700;
            color: var(--brand-primary);
            font-size: 0.8125rem;
        }

        .job-entry.full .job-location {
            color: var(--text-primary);
            font-weight: 500;
            margin-top: 0.125rem;
        }

        .job-entry.full .job-task {
            color: var(--text-muted);
            font-size: 0.6875rem;
            margin-top: 0.125rem;
        }

        .job-entry.full .job-partner {
            color: var(--text-muted);
            font-size: 0.625rem;
            margin-top: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .job-entry.full .job-partner::before {
            content: 'üë§';
            font-size: 0.625rem;
        }

        /* Compact display (3-4 jobs) */
        .job-entry.compact {
            padding: 0.375rem 0.5rem;
        }

        .job-entry.compact .job-line {
            display: flex;
            gap: 0.375rem;
            align-items: baseline;
        }

        .job-entry.compact .job-q {
            font-weight: 700;
            color: var(--brand-primary);
            font-size: 0.75rem;
        }

        .job-entry.compact .job-location {
            color: var(--text-secondary);
            font-size: 0.6875rem;
        }

        .job-entry.compact .job-task {
            color: var(--text-muted);
            font-size: 0.625rem;
        }

        /* Minimal display (5+ jobs) */
        .jobs-minimal {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }

        .job-chip {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--brand-primary);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .job-chip:hover {
            background: var(--brand-primary);
            color: #ffffff;
            border-color: var(--brand-primary);
        }

        .jobs-overflow {
            background: var(--border-color);
            color: var(--text-secondary);
            border: none;
        }

        /* === STATUS ENTRIES === */
        .status-entry {
            border-radius: 0.5rem;
            padding: 0.625rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            min-height: 80px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .status-entry:hover {
            filter: brightness(0.95);
        }

        .status-entry .status-icon {
            font-size: 1rem;
        }

        .status-entry.work {
            border: 1px solid currentColor;
        }

        .status-entry.non-work {
            border: 2px dashed currentColor;
            opacity: 0.9;
        }

        .status-leave { background: var(--status-leave-bg); color: var(--status-leave); }
        .status-training { background: var(--status-training-bg); color: var(--status-training); }
        .status-sickness { background: var(--status-sickness-bg); color: var(--status-sickness); }
        .status-office { background: var(--status-office-bg); color: var(--status-office); }
        .status-night { background: var(--status-night-bg); color: var(--status-night); }
        .status-rest { background: var(--status-rest-bg); color: var(--status-rest); }
        .status-wfh { background: var(--status-wfh-bg); color: var(--status-wfh); }
        .status-travel { background: var(--status-travel-bg); color: var(--status-travel); }

        /* === SIDE PANEL === */
        .panel-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(2px);
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s ease;
        }

        .panel-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .side-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 420px;
            max-width: 100%;
            height: 100vh;
            background: var(--bg-secondary);
            z-index: 101;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), background 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-xl);
        }

        .side-panel.open {
            transform: translateX(0);
        }

        /* Touch-friendly tap targets */
        @media (pointer: coarse) {
            .btn-icon,
            .panel-close,
            .week-navigator button {
                min-width: 44px;
                min-height: 44px;
            }

            .filter-select,
            .search-box input {
                min-height: 44px;
            }

            .job-entry,
            .status-entry,
            .job-chip {
                min-height: 44px;
            }
        }

        .panel-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .panel-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .panel-subtitle {
            font-size: 0.8125rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .panel-close {
            width: 2rem;
            height: 2rem;
            border: none;
            background: var(--bg-tertiary);
            border-radius: 0.5rem;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .panel-close:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .panel-section {
            margin-bottom: 1.5rem;
        }

        .panel-section:last-child {
            margin-bottom: 0;
        }

        .panel-section-title {
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }

        .panel-field {
            margin-bottom: 0.75rem;
        }

        .panel-field:last-child {
            margin-bottom: 0;
        }

        .panel-label {
            font-size: 0.6875rem;
            color: var(--text-muted);
            margin-bottom: 0.125rem;
        }

        .panel-value {
            font-size: 0.875rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .panel-jobs-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .panel-job-card {
            background: var(--bg-tertiary);
            border-radius: 0.75rem;
            padding: 1rem;
            border-left: 3px solid var(--brand-primary);
        }

        .panel-job-q {
            font-weight: 700;
            color: var(--brand-primary);
            font-size: 0.9375rem;
        }

        .panel-job-client {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.125rem;
        }

        .panel-job-details {
            margin-top: 0.75rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .panel-job-detail {
            font-size: 0.75rem;
        }

        .panel-job-detail-label {
            color: var(--text-muted);
            font-size: 0.625rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .panel-job-detail-value {
            color: var(--text-primary);
            font-weight: 500;
            margin-top: 0.125rem;
        }

        .panel-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 0.75rem;
        }

        .panel-btn {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.8125rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            font-family: inherit;
        }

        .panel-btn-primary {
            background: var(--brand-gradient);
            color: #ffffff;
            border: none;
        }

        .panel-btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .panel-btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .panel-btn-secondary:hover {
            background: var(--bg-tertiary);
        }

        .panel-btn-danger {
            background: rgba(244, 63, 94, 0.1);
            color: #f43f5e;
            border: 1px solid #f43f5e;
        }

        .panel-btn-danger:hover {
            background: rgba(244, 63, 94, 0.2);
        }

        /* === WORKSTREAM DIVIDERS === */
        .workstream-divider {
            display: contents;
        }

        .workstream-header {
            grid-column: 1 / -1;
            background: var(--border-color);
            padding: 0.5rem 1rem;
            font-size: 0.6875rem;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* === RESPONSIVE === */
        @media (max-width: 1200px) {
            .schedule-grid {
                grid-template-columns: 180px repeat(5, 1fr);
            }

            .schedule-grid.show-weekends {
                grid-template-columns: 180px repeat(7, 1fr);
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 0.75rem 1rem;
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }

            .logo-section {
                text-align: center;
            }

            .logo-section h1 {
                font-size: 1.125rem;
            }

            .logo-section p {
                font-size: 0.6875rem;
            }

            .header-actions {
                justify-content: center;
                width: 100%;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .week-navigator {
                flex: 1;
                justify-content: center;
                max-width: none;
                order: -1;
                width: 100%;
            }

            .week-navigator .week-display {
                font-size: 0.875rem;
                padding: 0 0.75rem;
                font-weight: 600;
            }

            .week-navigator button {
                width: 2.25rem;
                height: 2.25rem;
                font-size: 1rem;
            }

            .btn-today {
                padding: 0.5rem 0.875rem;
                font-size: 0.75rem;
            }

            .toolbar {
                padding: 0.75rem 1rem;
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }

            .filters {
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .filter-select {
                flex: 1;
                min-width: 120px;
                font-size: 0.8125rem;
                padding: 0.5rem 0.625rem;
            }

            .search-box {
                width: 100%;
                order: -1;
            }

            .search-box input {
                width: 100%;
                font-size: 0.875rem;
                padding: 0.625rem 0.75rem;
            }

            .search-box input:focus {
                width: 100%;
            }

            .toolbar-actions {
                justify-content: center;
                flex-wrap: wrap;
                gap: 0.375rem;
            }

            .toolbar-actions .btn-icon {
                width: 2.25rem;
                height: 2.25rem;
            }

            .legend {
                padding: 0.5rem 1rem;
                gap: 0.75rem;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .legend-items {
                gap: 0.625rem;
            }

            .legend-item {
                font-size: 0.6875rem;
                white-space: nowrap;
                padding: 0.25rem 0;
            }

            .schedule-wrapper {
                padding: 0.5rem;
            }

            /* Mobile grid - horizontal scroll with sticky first column */
            .schedule-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .schedule-grid {
                grid-template-columns: 100px repeat(5, minmax(90px, 1fr));
                min-width: 600px;
            }

            .schedule-grid.show-weekends {
                grid-template-columns: 100px repeat(7, minmax(80px, 1fr));
                min-width: 750px;
            }

            /* Sticky first column */
            .person-cell,
            .grid-header-cell:first-child {
                position: sticky;
                left: 0;
                z-index: 2;
                background: var(--bg-primary);
            }

            .grid-header-cell:first-child {
                z-index: 3;
            }

            .grid-header-cell {
                padding: 0.625rem 0.375rem;
            }

            .day-name {
                font-size: 0.6875rem;
            }

            .day-date {
                font-size: 1.125rem;
            }

            .day-month {
                font-size: 0.625rem;
            }

            .person-cell {
                padding: 0.5rem;
                min-height: auto;
            }

            .person-name {
                font-size: 0.75rem;
                font-weight: 600;
            }

            .person-role {
                font-size: 0.625rem;
                display: block;
            }

            .person-meta {
                display: none;
            }

            /* Day cells */
            .day-cell {
                padding: 0.375rem;
                min-height: 70px;
            }

            /* Mobile job entries */
            .job-entry {
                padding: 0.375rem 0.5rem;
                font-size: 0.6875rem;
                border-left-width: 3px;
            }

            .job-entry.full .job-q {
                font-size: 0.75rem;
            }

            .job-entry.full .job-location {
                font-size: 0.625rem;
            }

            .job-entry.full .job-task,
            .job-entry.full .job-partner {
                display: none;
            }

            .job-entry.compact .job-q {
                font-size: 0.6875rem;
            }

            .job-entry.compact .job-location,
            .job-entry.compact .job-task {
                display: none;
            }

            /* Mobile job chips */
            .job-chip {
                padding: 0.1875rem 0.375rem;
                font-size: 0.625rem;
            }

            /* Mobile status entries */
            .status-entry {
                padding: 0.5rem;
                min-height: 50px;
                font-size: 0.6875rem;
            }

            .status-entry .status-icon {
                font-size: 1rem;
            }

            .status-entry span:not(.status-icon) {
                font-size: 0.625rem;
            }

            /* Workstream header */
            .workstream-header {
                padding: 0.5rem 0.625rem;
                font-size: 0.6875rem;
                position: sticky;
                left: 0;
                background: var(--brand-gradient);
            }

            /* Side panel - full screen on mobile */
            .side-panel {
                width: 100%;
                max-width: 100%;
            }

            .panel-body {
                padding: 1rem;
            }

            .panel-footer {
                padding: 1rem;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .panel-btn {
                flex: 1;
                min-width: calc(50% - 0.25rem);
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }
        }

        /* Extra small screens */
        @media (max-width: 480px) {
            .header {
                padding: 0.625rem 0.75rem;
            }

            .logo-section h1 {
                font-size: 1rem;
            }

            .week-navigator {
                padding: 0.25rem;
            }

            .week-navigator .week-display {
                font-size: 0.8125rem;
            }

            .week-navigator button {
                width: 2rem;
                height: 2rem;
            }

            .btn-today {
                padding: 0.375rem 0.625rem;
                font-size: 0.6875rem;
            }

            .schedule-grid {
                grid-template-columns: 80px repeat(5, minmax(75px, 1fr));
                min-width: 500px;
            }

            .schedule-grid.show-weekends {
                grid-template-columns: 80px repeat(7, minmax(65px, 1fr));
                min-width: 620px;
            }

            .person-cell {
                padding: 0.375rem;
            }

            .person-name {
                font-size: 0.6875rem;
            }

            .person-role {
                display: none;
            }

            .day-cell {
                min-height: 60px;
                padding: 0.25rem;
            }

            .grid-header-cell {
                padding: 0.5rem 0.25rem;
            }

            .day-name {
                font-size: 0.5625rem;
            }

            .day-date {
                font-size: 1rem;
            }

            .day-month {
                font-size: 0.5625rem;
            }

            .job-entry {
                padding: 0.25rem 0.375rem;
            }

            .job-entry.full .job-q {
                font-size: 0.6875rem;
            }

            .job-entry.full .job-location {
                display: none;
            }

            .status-entry {
                min-height: 45px;
                padding: 0.375rem;
            }

            .status-entry .status-icon {
                font-size: 0.875rem;
            }

            .status-entry span:not(.status-icon) {
                font-size: 0.5625rem;
            }

            /* Toolbar compact */
            .toolbar {
                padding: 0.5rem 0.75rem;
            }

            .filter-select {
                font-size: 0.75rem;
                padding: 0.375rem 0.5rem;
            }

            .toolbar-actions .btn-icon {
                width: 2rem;
                height: 2rem;
            }

            .toolbar-actions .btn-icon svg {
                width: 14px;
                height: 14px;
            }
        }

        /* Mobile modal improvements */
        @media (max-width: 768px) {
            #loginOverlay > div,
            #changePasswordOverlay > div,
            #techModalOverlay > div,
            #entryModalOverlay > div,
            #deleteJobOverlay > div,
            #bulkEntryOverlay > div,
            #csvModalOverlay > div,
            #historyOverlay > div,
            #globalAuditOverlay > div,
            #manageTeamOverlay > div,
            #manageRolesOverlay > div,
            #manageWorkstreamsOverlay > div,
            #copyPrevWeekOverlay > div,
            #statsOverlay > div,
            #moveOrDuplicateOverlay > div {
                width: 95% !important;
                max-width: 95% !important;
                max-height: 90vh !important;
                margin: 0 auto;
                border-radius: 0.75rem !important;
            }

            /* Stats modal specific */
            #statsOverlay > div {
                max-height: 85vh !important;
            }

            /* Stats dashboard mobile improvements */
            #statsOverlay [style*="grid-template-columns: repeat(5"] {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            #statsOverlay [style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }

            /* Audit log mobile */
            #globalAuditOverlay input[type="text"] {
                font-size: 16px !important; /* Prevents iOS zoom */
            }

            /* Form inputs prevent zoom on iOS */
            input[type="text"],
            input[type="email"],
            input[type="password"],
            input[type="date"],
            textarea,
            select {
                font-size: 16px !important;
            }
        }

        /* Smooth scrolling for touch devices */
        @media (pointer: coarse) {
            .schedule-container,
            .panel-body,
            #globalAuditContent,
            #historyContent {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
            }

            /* Larger touch targets for job actions */
            .panel-job-card button {
                min-height: 40px;
                padding: 0.5rem 0.75rem !important;
            }
        }

        /* Landscape phone optimization */
        @media (max-width: 900px) and (orientation: landscape) {
            .header {
                padding: 0.5rem 1rem;
                flex-direction: row;
                gap: 0.5rem;
            }

            .header-actions {
                flex: 1;
            }

            .week-navigator {
                order: 0;
            }

            .schedule-grid {
                grid-template-columns: 100px repeat(5, minmax(100px, 1fr));
            }

            .schedule-grid.show-weekends {
                grid-template-columns: 100px repeat(7, minmax(85px, 1fr));
            }
        }

        /* === SCROLLBAR === */
        .schedule-container::-webkit-scrollbar {
            height: 8px;
        }

        .schedule-container::-webkit-scrollbar-track {
            background: var(--slate-100);
        }

        .schedule-container::-webkit-scrollbar-thumb {
            background: var(--slate-300);
            border-radius: 4px;
        }

        .schedule-container::-webkit-scrollbar-thumb:hover {
            background: var(--slate-400);
        }

        /* === TOAST ANIMATIONS === */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo-section">
            <h1>Water Business Unit Schedule</h1>
            <p>Resource deployment & planning</p>
        </div>
        <div class="header-actions">
            <div id="onlineUsers" style="
                display: flex;
                align-items: center;
                gap: 0.5rem;
                background: rgba(255,255,255,0.15);
                padding: 0.375rem 0.75rem;
                border-radius: 0.5rem;
                font-size: 0.75rem;
                color: white;
            ">
                <span style="width: 8px; height: 8px; background: #22c55e; border-radius: 50%; animation: pulse 2s infinite;"></span>
                <span id="onlineCount">1 online</span>
            </div>
            <div class="week-navigator">
                <button onclick="changeWeek(-1)" aria-label="Previous week">‚Äπ</button>
                <div class="week-display" id="weekDisplay">Week 49 ¬∑ December 2025</div>
                <button onclick="changeWeek(1)" aria-label="Next week">‚Ä∫</button>
            </div>
            <button class="btn-today" onclick="goToToday()">Today</button>
            <button class="btn-today" id="authBtn" style="background: rgba(255,255,255,0.2); color: white;">üîê Sign In</button>
        </div>
    </header>

    <!-- Toolbar -->
    <div class="toolbar">
        <div class="filters">
            <select class="filter-select" id="workstreamFilter" onchange="renderSchedule()">
                <option value="all">All Workstreams</option>
                <!-- Populated dynamically -->
            </select>
            <select class="filter-select" id="clientFilter" onchange="renderSchedule()">
                <option value="all">All Clients</option>
                <!-- Populated dynamically -->
            </select>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search name, Q number, location, role..." oninput="renderSchedule()">
            </div>
        </div>
        <div class="toolbar-actions">
            <button class="btn-icon" id="manageTeamBtn" onclick="showManageTeamModal()" title="Manage Team" style="display: none;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
            </button>
            <button class="btn-icon" id="manageRolesBtn" onclick="showManageRolesModal()" title="Manage Roles" style="display: none;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <line x1="19" y1="8" x2="19" y2="14"/>
                    <line x1="22" y1="11" x2="16" y2="11"/>
                </svg>
            </button>
            <button class="btn-icon" id="manageWorkstreamsBtn" onclick="showManageWorkstreamsModal()" title="Manage Workstreams" style="display: none;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="8" y1="6" x2="21" y2="6"/>
                    <line x1="8" y1="12" x2="21" y2="12"/>
                    <line x1="8" y1="18" x2="21" y2="18"/>
                    <line x1="3" y1="6" x2="3.01" y2="6"/>
                    <line x1="3" y1="12" x2="3.01" y2="12"/>
                    <line x1="3" y1="18" x2="3.01" y2="18"/>
                </svg>
            </button>
            <button class="btn-icon" id="csvUploadBtn" onclick="showCSVModal()" title="Upload CSV" style="display: none;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17,8 12,3 7,8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
            </button>
            <button class="btn-icon" id="copyPrevWeekBtn" onclick="showCopyPrevWeekModal()" title="Copy Previous Week" style="display: none;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                </svg>
            </button>
            <button class="btn-icon" id="addTechBtn" onclick="showAddTechnicianModal()" title="Add Technician" style="display: none;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
            </button>
            <button class="btn-icon" id="auditLogBtn" onclick="showGlobalAuditModal()" title="Audit Log" style="display: none;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10 9 9 9 8 9"/>
                </svg>
            </button>
            <button class="btn-icon" id="statsBtn" onclick="showStatsModal()" title="Analytics Dashboard">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="20" x2="18" y2="10"/>
                    <line x1="12" y1="20" x2="12" y2="4"/>
                    <line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
            </button>
            <button class="btn-icon" id="toggleDarkMode" onclick="toggleDarkMode()" title="Toggle dark mode">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="darkModeIcon">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                </svg>
            </button>
            <button class="btn-icon active" id="toggleWeekends" onclick="toggleWeekends()" title="Toggle weekends">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Legend -->
    <div class="legend">
        <span class="legend-label">Job Status</span>
        <div class="legend-items">
            <div class="legend-item"><div class="legend-dot" style="background: #6366f1"></div>Night</div>
            <div class="legend-item"><div class="legend-dot" style="background: #ef4444"></div>Inactive</div>
            <div class="legend-item"><div class="legend-dot" style="background: #f59e0b"></div>Pending</div>
            <div class="legend-item"><div class="legend-dot" style="background: #22c55e"></div>Live</div>
        </div>
    </div>

    <!-- Schedule -->
    <div class="schedule-wrapper">
        <div class="schedule-container" style="overflow-x: auto;">
            <div class="schedule-grid" id="scheduleGrid">
                <!-- Rendered by JS -->
            </div>
        </div>
    </div>

    <!-- Side Panel -->
    <div class="panel-overlay" id="panelOverlay" onclick="closePanel()"></div>
    <div class="side-panel" id="sidePanel">
        <div class="panel-header">
            <div>
                <div class="panel-title" id="panelTitle">Technician Details</div>
                <div class="panel-subtitle" id="panelSubtitle">Monday, 1 December</div>
            </div>
            <button class="panel-close" onclick="closePanel()" aria-label="Close">√ó</button>
        </div>
        <div class="panel-body" id="panelBody">
            <!-- Dynamic content -->
        </div>
        <div class="panel-footer" id="panelFooter">
            <!-- Dynamic buttons -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://tcjaegtublrlkyxveloh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjamFlZ3R1YmxybGt5eHZlbG9oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzNzc4MzMsImV4cCI6MjA4Mzk1MzgzM30.4aNJQZ2REe_njrdVyhefDomnrKQo2zMo-iDJnGhxRXI';
        
        let supabaseClient = null;

        // Status configuration
        const STATUS_CONFIG = {
            leave: { icon: 'üå¥', label: 'Annual Leave', isWork: false },
            training: { icon: 'üìö', label: 'Training', isWork: true },
            sickness: { icon: 'üè•', label: 'Sickness', isWork: false },
            office: { icon: 'üè¢', label: 'Office', isWork: true },
            night: { icon: 'üåô', label: 'Night Work', isWork: true },
            rest: { icon: '‚òÄÔ∏è', label: 'Rest Day', isWork: false },
            wfh: { icon: 'üè†', label: 'WFH', isWork: true },
            travel: { icon: 'üöó', label: 'Travel', isWork: true },
            bank_holiday: { icon: 'üéâ', label: 'Bank Holiday', isWork: false },
            first_day: { icon: 'üéä', label: 'First Day', isWork: true }
        };

        // Sample data - will be replaced by Supabase
        let TECHNICIANS = [];
        let CLIENTS = [];
        let ROLES = [];
        let SCHEDULE_ENTRIES = [];
        let WORKSTREAMS = [
            { name: 'Project Delivery', rank: 0 },
            { name: 'Clean Water', rank: 1 },
            { name: 'Waste Water', rank: 2 },
            { name: 'Contingent Resources', rank: 3 },
            { name: 'Management & Admin', rank: 4 }
        ];
        let isLoading = true;
        let currentUser = null;

        // Default clients (A-Z order)
        const DEFAULT_CLIENTS = [
            'Affinity Water',
            'Ancala Water',
            'Anglian Water',
            'Cambridge Water',
            'Guernsey Water',
            'Jersey Water',
            'Northumbrian Water',
            'Portsmouth Water',
            'Scottish Water',
            'Severn Trent Water',
            'South East Water',
            'South West Water',
            'Southern Water',
            'Sutton & East Surrey',
            'Thames Water',
            'United Utilities',
            'Welsh Water'
        ];

        // Default roles in hierarchy order (highest to lowest)
        const DEFAULT_ROLES = [
            'Contract Director',
            'Contingent Resource Manager',
            'Delivery Manager',
            'Technical Support ‚Äì Instrumentation',
            'Project Manager',
            'Project Engineer',
            'Systems Engineer',
            'Lead Project Coordinator',
            'Project Coordinator',
            'Data Analyst',
            'Senior Supervisor',
            'Supervisor',
            'Supervisor ‚Äì Civil/Mechanical',
            'Electrician',
            'ICA Technician',
            'EC&I Technician',
            'Logging Tech',
            'M&E',
            'M&E Technician',
            'Mechanical Technician',
            'Metering Tech',
            'C&I Technician',
            'Civil & Mechanical Tech',
            'Degree Apprentice',
            'Assistant Technician'
        ];

        // Helper function to setup modal close on overlay click
        // Only closes if both mousedown AND mouseup happen on the overlay (not dragged from inside)
        function setupModalClose(overlay, closeFunction) {
            let mouseDownOnOverlay = false;
            
            overlay.addEventListener('mousedown', (e) => {
                mouseDownOnOverlay = (e.target === overlay);
            });
            
            overlay.addEventListener('mouseup', (e) => {
                if (mouseDownOnOverlay && e.target === overlay) {
                    closeFunction();
                }
                mouseDownOnOverlay = false;
            });
        }

        // Load clients from Supabase
        async function loadClients() {
            if (!supabaseClient) return DEFAULT_CLIENTS;
            
            const { data, error } = await supabaseClient
                .from('clients')
                .select('name')
                .order('name', { ascending: true });
            
            if (error || !data || data.length === 0) {
                // If no clients table or empty, seed with defaults
                return DEFAULT_CLIENTS;
            }
            return data.map(c => c.name);
        }

        // Load roles from Supabase
        async function loadRoles() {
            if (!supabaseClient) return DEFAULT_ROLES.map((name, idx) => ({ name, rank: idx }));
            
            const { data, error } = await supabaseClient
                .from('roles')
                .select('id, name, rank')
                .order('rank', { ascending: true });
            
            if (error || !data || data.length === 0) {
                // If no roles table or empty, use defaults
                return DEFAULT_ROLES.map((name, idx) => ({ name, rank: idx }));
            }
            return data;
        }

        // Get role rank for sorting
        function getRoleRank(roleName) {
            const role = ROLES.find(r => r.name === roleName);
            return role ? role.rank : 999; // Unknown roles go to the end
        }

        async function addClient(clientName) {
            if (!supabaseClient || !clientName.trim()) return false;
            
            const { error } = await supabaseClient
                .from('clients')
                .insert([{ name: clientName.trim() }]);
            
            if (error) {
                console.error('Error adding client:', error);
                return false;
            }
            
            // Reload clients
            CLIENTS = await loadClients();
            updateClientDropdowns();
            return true;
        }

        async function addRole(roleName) {
            if (!supabaseClient || !roleName.trim()) return false;
            
            // Add at the end of the hierarchy
            const newRank = ROLES.length;
            
            const { error } = await supabaseClient
                .from('roles')
                .insert([{ name: roleName.trim(), rank: newRank }]);
            
            if (error) {
                console.error('Error adding role:', error);
                return false;
            }
            
            // Reload roles
            const roles = await loadRoles();
            ROLES = roles;
            return true;
        }

        function updateClientDropdowns() {
            // Update filter dropdown
            const filterDropdown = document.getElementById('clientFilter');
            if (filterDropdown) {
                const currentValue = filterDropdown.value;
                filterDropdown.innerHTML = '<option value="all">All Clients</option>' +
                    CLIENTS.map(c => `<option value="${c}">${c}</option>`).join('');
                filterDropdown.value = currentValue;
            }
        }

        // Load data from Supabase
        async function loadTechnicians() {
            if (!supabaseClient) {
                console.error('Supabase not initialized');
                return [];
            }
            const { data, error } = await supabaseClient
                .from('technicians')
                .select('*')
                .order('workstream', { ascending: true })
                .order('name', { ascending: true });
            
            if (error) {
                console.error('Error loading technicians:', error);
                return [];
            }
            return data || [];
        }

        async function loadScheduleEntries(startDate, endDate) {
            if (!supabaseClient) {
                console.error('Supabase not initialized');
                return [];
            }
            const { data, error } = await supabaseClient
                .from('schedule_entries')
                .select('*')
                .gte('date', startDate.toISOString().split('T')[0])
                .lte('date', endDate.toISOString().split('T')[0]);
            
            if (error) {
                console.error('Error loading schedule:', error);
                return [];
            }
            return data || [];
        }

        // Transform Supabase data to app format
        function buildScheduleData(technicians, entries) {
            return technicians.map(tech => {
                const schedule = {};
                
                // Initialize all days
                for (let i = 0; i < 7; i++) {
                    schedule[i] = { jobs: [] };
                }
                
                // Build date strings for the week to compare against
                const weekDates = [];
                for (let i = 0; i < 7; i++) {
                    const d = new Date(currentWeekStart);
                    d.setDate(d.getDate() + i);
                    weekDates.push(toLocalDateString(d));
                }
                
                // Group entries by day
                entries
                    .filter(e => e.technician_id === tech.id)
                    .forEach(entry => {
                        // entry.date comes as YYYY-MM-DD string from database
                        const entryDateStr = entry.date.split('T')[0]; // Handle if it has time component
                        const dayIndex = weekDates.indexOf(entryDateStr);
                        
                        if (dayIndex >= 0 && dayIndex < 7) {
                            if (entry.entry_type === 'status') {
                                schedule[dayIndex] = { 
                                    status: entry.status_type, 
                                    text: entry.status_text 
                                };
                            } else if (entry.entry_type === 'job') {
                                if (!schedule[dayIndex].jobs) {
                                    schedule[dayIndex] = { jobs: [] };
                                }
                                schedule[dayIndex].jobs.push({
                                    entryId: entry.id,
                                    q: entry.q_number,
                                    client: entry.client,
                                    location: entry.location,
                                    task: entry.task,
                                    partner: entry.partner,
                                    isNight: entry.is_night || false,
                                    jobStatus: entry.job_status || 'live',
                                    notes: entry.notes || ''
                                });
                            }
                        }
                    });
                
                return {
                    id: tech.id,
                    name: tech.name,
                    role: tech.role,
                    postcode: tech.postcode,
                    workstream: tech.workstream,
                    lineManager: tech.line_manager,
                    sort_order: tech.sort_order,
                    first_day: tech.first_day,
                    end_date: tech.end_date,
                    notes: tech.notes,
                    schedule
                };
            });
        }

        async function loadAllData() {
            isLoading = true;
            showLoadingState();
            
            const endDate = new Date(currentWeekStart);
            endDate.setDate(endDate.getDate() + 6);
            
            const [technicians, entries, clients, roles] = await Promise.all([
                loadTechnicians(),
                loadScheduleEntries(currentWeekStart, endDate),
                loadClients(),
                loadRoles()
            ]);
            
            CLIENTS = clients;
            ROLES = roles;
            SCHEDULE_ENTRIES = entries;
            updateClientDropdowns();
            updateWorkstreamDropdowns();
            
            TECHNICIANS = buildScheduleData(technicians, entries);
            isLoading = false;
            renderSchedule();
        }

        function showLoadingState() {
            const grid = document.getElementById('scheduleGrid');
            grid.innerHTML = `
                <div style="grid-column: 1 / -1; padding: 3rem; text-align: center; color: var(--text-muted);">
                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚è≥</div>
                    <div>Loading schedule...</div>
                </div>
            `;
        }

        // Auth functions
        async function checkAuth() {
            if (!supabaseClient) return;
            const { data: { session } } = await supabaseClient.auth.getSession();
            currentUser = session?.user || null;
            updateAuthUI();
        }

        async function signIn(email, password) {
            if (!supabaseClient) {
                alert('Database connection not available');
                return false;
            }
            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email,
                password
            });
            
            if (error) {
                alert('Login failed: ' + error.message);
                return false;
            }
            
            currentUser = data.user;
            updateAuthUI();
            return true;
        }

        async function signOut() {
            if (!supabaseClient) return;
            await supabaseClient.auth.signOut();
            currentUser = null;
            updateAuthUI();
        }

        function updateAuthUI() {
            const authBtn = document.getElementById('authBtn');
            const addTechBtn = document.getElementById('addTechBtn');
            const csvUploadBtn = document.getElementById('csvUploadBtn');
            const copyPrevWeekBtn = document.getElementById('copyPrevWeekBtn');
            const manageTeamBtn = document.getElementById('manageTeamBtn');
            const manageRolesBtn = document.getElementById('manageRolesBtn');
            const manageWorkstreamsBtn = document.getElementById('manageWorkstreamsBtn');
            const auditLogBtn = document.getElementById('auditLogBtn');
            
            if (currentUser) {
                authBtn.innerHTML = `‚úì ${currentUser.email.split('@')[0]} ‚ñæ`;
                authBtn.onclick = toggleUserMenu;
                authBtn.title = 'Account options';
                authBtn.style.background = 'rgba(255,255,255,0.9)';
                authBtn.style.color = 'var(--brand-primary)';
                authBtn.style.position = 'relative';
                if (addTechBtn) addTechBtn.style.display = 'flex';
                if (csvUploadBtn) csvUploadBtn.style.display = 'flex';
                if (copyPrevWeekBtn) copyPrevWeekBtn.style.display = 'flex';
                if (manageTeamBtn) manageTeamBtn.style.display = 'flex';
                if (manageRolesBtn) manageRolesBtn.style.display = 'flex';
                if (manageWorkstreamsBtn) manageWorkstreamsBtn.style.display = 'flex';
                if (auditLogBtn) auditLogBtn.style.display = 'flex';
            } else {
                authBtn.innerHTML = 'üîê Sign In';
                authBtn.onclick = showLoginModal;
                authBtn.title = 'Sign in to edit';
                authBtn.style.background = 'rgba(255,255,255,0.2)';
                authBtn.style.color = 'white';
                if (addTechBtn) addTechBtn.style.display = 'none';
                if (csvUploadBtn) csvUploadBtn.style.display = 'none';
                if (copyPrevWeekBtn) copyPrevWeekBtn.style.display = 'none';
                if (manageTeamBtn) manageTeamBtn.style.display = 'none';
                if (manageRolesBtn) manageRolesBtn.style.display = 'none';
                if (manageWorkstreamsBtn) manageWorkstreamsBtn.style.display = 'none';
                if (auditLogBtn) auditLogBtn.style.display = 'none';
                // Remove any existing user menu
                const existingMenu = document.getElementById('userMenu');
                if (existingMenu) existingMenu.remove();
            }
        }

        function toggleUserMenu(e) {
            e.stopPropagation();
            const existingMenu = document.getElementById('userMenu');
            if (existingMenu) {
                existingMenu.remove();
                return;
            }

            const authBtn = document.getElementById('authBtn');
            const rect = authBtn.getBoundingClientRect();

            const menu = document.createElement('div');
            menu.id = 'userMenu';
            menu.style.cssText = `
                position: fixed;
                top: ${rect.bottom + 8}px;
                right: ${window.innerWidth - rect.right}px;
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                border-radius: 0.5rem;
                box-shadow: 0 10px 25px rgba(0,0,0,0.2);
                z-index: 300;
                min-width: 180px;
                overflow: hidden;
            `;

            menu.innerHTML = `
                <div style="padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); font-size: 0.75rem; color: var(--text-muted);">
                    Signed in as<br>
                    <strong style="color: var(--text-primary);">${currentUser.email}</strong>
                </div>
                <button onclick="showChangePasswordModal()" style="
                    width: 100%;
                    padding: 0.75rem 1rem;
                    border: none;
                    background: transparent;
                    color: var(--text-primary);
                    font-size: 0.875rem;
                    text-align: left;
                    cursor: pointer;
                    font-family: inherit;
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                " onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='transparent'">
                    üîë Change Password
                </button>
                <button onclick="signOut()" style="
                    width: 100%;
                    padding: 0.75rem 1rem;
                    border: none;
                    background: transparent;
                    color: #ef4444;
                    font-size: 0.875rem;
                    text-align: left;
                    cursor: pointer;
                    font-family: inherit;
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                " onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='transparent'">
                    üö™ Sign Out
                </button>
            `;

            document.body.appendChild(menu);

            // Close menu when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeUserMenuOnClickOutside);
            }, 0);
        }

        function closeUserMenuOnClickOutside(e) {
            const menu = document.getElementById('userMenu');
            const authBtn = document.getElementById('authBtn');
            if (menu && !menu.contains(e.target) && e.target !== authBtn) {
                menu.remove();
                document.removeEventListener('click', closeUserMenuOnClickOutside);
            }
        }

        function showChangePasswordModal() {
            // Close user menu
            const menu = document.getElementById('userMenu');
            if (menu) menu.remove();
            document.removeEventListener('click', closeUserMenuOnClickOutside);

            const overlay = document.createElement('div');
            overlay.id = 'changePasswordOverlay';
            overlay.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.6);
                backdrop-filter: blur(4px);
                z-index: 200;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--bg-secondary);
                border-radius: 1rem;
                padding: 2rem;
                width: 90%;
                max-width: 400px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            `;

            modal.innerHTML = `
                <h2 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; color: var(--text-primary);">Change Password</h2>
                <p style="margin: 0 0 1.5rem 0; font-size: 0.875rem; color: var(--text-muted);">Enter your current password and choose a new one</p>
                <form id="changePasswordForm">
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Current Password</label>
                        <input type="password" id="currentPassword" required style="
                            width: 100%;
                            padding: 0.625rem 0.75rem;
                            border: 1px solid var(--border-color);
                            border-radius: 0.5rem;
                            font-size: 0.875rem;
                            font-family: inherit;
                            background: var(--bg-secondary);
                            color: var(--text-primary);
                            box-sizing: border-box;
                        " placeholder="Enter current password">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">New Password</label>
                        <input type="password" id="newPassword" required minlength="6" style="
                            width: 100%;
                            padding: 0.625rem 0.75rem;
                            border: 1px solid var(--border-color);
                            border-radius: 0.5rem;
                            font-size: 0.875rem;
                            font-family: inherit;
                            background: var(--bg-secondary);
                            color: var(--text-primary);
                            box-sizing: border-box;
                        " placeholder="Enter new password (min 6 characters)">
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Confirm New Password</label>
                        <input type="password" id="confirmPassword" required minlength="6" style="
                            width: 100%;
                            padding: 0.625rem 0.75rem;
                            border: 1px solid var(--border-color);
                            border-radius: 0.5rem;
                            font-size: 0.875rem;
                            font-family: inherit;
                            background: var(--bg-secondary);
                            color: var(--text-primary);
                            box-sizing: border-box;
                        " placeholder="Confirm new password">
                    </div>
                    <div id="passwordError" style="display: none; margin-bottom: 1rem; padding: 0.75rem; background: rgba(239,68,68,0.1); border: 1px solid #ef4444; border-radius: 0.5rem; color: #ef4444; font-size: 0.8125rem;"></div>
                    <div style="display: flex; gap: 0.75rem;">
                        <button type="button" onclick="closeChangePasswordModal()" style="
                            flex: 1;
                            padding: 0.625rem 1rem;
                            border: 1px solid var(--border-color);
                            background: var(--bg-secondary);
                            color: var(--text-primary);
                            border-radius: 0.5rem;
                            font-size: 0.875rem;
                            font-weight: 500;
                            cursor: pointer;
                            font-family: inherit;
                        ">Cancel</button>
                        <button type="submit" id="changePasswordBtn" style="
                            flex: 1;
                            padding: 0.625rem 1rem;
                            border: none;
                            background: var(--brand-gradient);
                            color: white;
                            border-radius: 0.5rem;
                            font-size: 0.875rem;
                            font-weight: 600;
                            cursor: pointer;
                            font-family: inherit;
                        ">Change Password</button>
                    </div>
                </form>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            document.getElementById('currentPassword').focus();

            document.getElementById('changePasswordForm').onsubmit = async (e) => {
                e.preventDefault();
                await handleChangePassword();
            };

            setupModalClose(overlay, closeChangePasswordModal);
        }

        function closeChangePasswordModal() {
            const overlay = document.getElementById('changePasswordOverlay');
            if (overlay) overlay.remove();
        }

        async function handleChangePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorDiv = document.getElementById('passwordError');
            const submitBtn = document.getElementById('changePasswordBtn');

            // Validate passwords match
            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'New passwords do not match';
                errorDiv.style.display = 'block';
                return;
            }

            if (newPassword.length < 6) {
                errorDiv.textContent = 'New password must be at least 6 characters';
                errorDiv.style.display = 'block';
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Changing...';
            errorDiv.style.display = 'none';

            try {
                // First verify the current password by re-authenticating
                const { error: signInError } = await supabaseClient.auth.signInWithPassword({
                    email: currentUser.email,
                    password: currentPassword
                });

                if (signInError) {
                    errorDiv.textContent = 'Current password is incorrect';
                    errorDiv.style.display = 'block';
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Change Password';
                    return;
                }

                // Now update to the new password
                const { error: updateError } = await supabaseClient.auth.updateUser({
                    password: newPassword
                });

                if (updateError) {
                    errorDiv.textContent = updateError.message;
                    errorDiv.style.display = 'block';
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Change Password';
                    return;
                }

                // Success!
                closeChangePasswordModal();
                showUpdateToast('Password changed successfully');
            } catch (err) {
                errorDiv.textContent = 'An error occurred. Please try again.';
                errorDiv.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Change Password';
            }
        }

        function showLoginModal() {
            // Create modal
            const overlay = document.createElement('div');
            overlay.id = 'loginOverlay';
            overlay.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.6);
                backdrop-filter: blur(4px);
                z-index: 200;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--bg-secondary);
                border-radius: 1rem;
                padding: 2rem;
                width: 90%;
                max-width: 360px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            `;

            modal.innerHTML = `
                <h2 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; color: var(--text-primary);">Sign In</h2>
                <p style="margin: 0 0 1.5rem 0; font-size: 0.875rem; color: var(--text-muted);">Enter your credentials to edit the schedule</p>
                <form id="loginForm">
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Email</label>
                        <input type="email" id="loginEmail" required style="
                            width: 100%;
                            padding: 0.625rem 0.75rem;
                            border: 1px solid var(--border-color);
                            border-radius: 0.5rem;
                            font-size: 0.875rem;
                            font-family: inherit;
                            background: var(--bg-secondary);
                            color: var(--text-primary);
                            box-sizing: border-box;
                        " placeholder="you@example.com">
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Password</label>
                        <input type="password" id="loginPassword" required style="
                            width: 100%;
                            padding: 0.625rem 0.75rem;
                            border: 1px solid var(--border-color);
                            border-radius: 0.5rem;
                            font-size: 0.875rem;
                            font-family: inherit;
                            background: var(--bg-secondary);
                            color: var(--text-primary);
                            box-sizing: border-box;
                        " placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <div style="display: flex; gap: 0.75rem;">
                        <button type="button" onclick="closeLoginModal()" style="
                            flex: 1;
                            padding: 0.625rem 1rem;
                            border: 1px solid var(--border-color);
                            background: var(--bg-secondary);
                            color: var(--text-primary);
                            border-radius: 0.5rem;
                            font-size: 0.875rem;
                            font-weight: 500;
                            cursor: pointer;
                            font-family: inherit;
                        ">Cancel</button>
                        <button type="submit" style="
                            flex: 1;
                            padding: 0.625rem 1rem;
                            border: none;
                            background: var(--brand-gradient);
                            color: white;
                            border-radius: 0.5rem;
                            font-size: 0.875rem;
                            font-weight: 600;
                            cursor: pointer;
                            font-family: inherit;
                        ">Sign In</button>
                    </div>
                </form>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // Focus email input
            document.getElementById('loginEmail').focus();

            // Handle form submit
            document.getElementById('loginForm').onsubmit = async (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                const success = await signIn(email, password);
                if (success) {
                    closeLoginModal();
                }
            };

            // Close on overlay click
            setupModalClose(overlay, closeLoginModal);

            // Close on Escape
            document.addEventListener('keydown', handleLoginEscape);
        }

        function handleLoginEscape(e) {
            if (e.key === 'Escape') closeLoginModal();
        }

        function closeLoginModal() {
            const overlay = document.getElementById('loginOverlay');
            if (overlay) overlay.remove();
            document.removeEventListener('keydown', handleLoginEscape);
        }

        // ==================== CRUD FUNCTIONS ====================

        // Add new technician
        function showAddTechnicianModal() {
            if (!currentUser) {
                alert('Please sign in to add technicians');
                return;
            }
            showTechnicianModal(null);
        }

        // Edit existing technician
        function showEditTechnicianModal(techId) {
            if (!currentUser) {
                alert('Please sign in to edit');
                return;
            }
            const tech = TECHNICIANS.find(t => t.id === techId);
            if (tech) showTechnicianModal(tech);
        }

        function showTechnicianModal(tech = null) {
            const isEdit = tech !== null;
            
            const overlay = document.createElement('div');
            overlay.id = 'techModalOverlay';
            overlay.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.6);
                backdrop-filter: blur(4px);
                z-index: 200;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--bg-secondary);
                border-radius: 1rem;
                padding: 2rem;
                width: 90%;
                max-width: 480px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.2);
                max-height: 90vh;
                overflow-y: auto;
            `;

            const workstreamOptions = WORKSTREAMS
                .map(ws => `<option value="${ws.name}" ${tech?.workstream === ws.name ? 'selected' : ''}>${ws.name}</option>`)
                .join('');

            modal.innerHTML = `
                <h2 style="margin: 0 0 1.5rem 0; font-size: 1.25rem; color: var(--text-primary);">${isEdit ? 'Edit Technician' : 'Add New Technician'}</h2>
                <form id="techForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Name *</label>
                            <input type="text" id="techName" required value="${tech?.name || ''}" style="
                                width: 100%;
                                padding: 0.625rem 0.75rem;
                                border: 1px solid var(--border-color);
                                border-radius: 0.5rem;
                                font-size: 0.875rem;
                                font-family: inherit;
                                background: var(--bg-secondary);
                                color: var(--text-primary);
                                box-sizing: border-box;
                            " placeholder="John Smith">
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Role</label>
                            <select id="techRole" onchange="handleRoleChange()" style="
                                width: 100%;
                                padding: 0.625rem 0.75rem;
                                border: 1px solid var(--border-color);
                                border-radius: 0.5rem;
                                font-size: 0.875rem;
                                font-family: inherit;
                                background: var(--bg-secondary);
                                color: var(--text-primary);
                                box-sizing: border-box;
                            ">
                                <option value="">Select role...</option>
                                ${ROLES.map(r => `<option value="${r.name}" ${tech?.role === r.name ? 'selected' : ''}>${r.name}</option>`).join('')}
                                ${tech?.role && !ROLES.find(rl => rl.name === tech.role) ? `<option value="${tech.role}" selected>${tech.role}</option>` : ''}
                                <option value="__add_new__">+ Add New Role...</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Postcode</label>
                            <input type="text" id="techPostcode" value="${tech?.postcode || ''}" style="
                                width: 100%;
                                padding: 0.625rem 0.75rem;
                                border: 1px solid var(--border-color);
                                border-radius: 0.5rem;
                                font-size: 0.875rem;
                                font-family: inherit;
                                background: var(--bg-secondary);
                                color: var(--text-primary);
                                box-sizing: border-box;
                            " placeholder="SW1A">
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Line Manager</label>
                            <select id="techManager" style="
                                width: 100%;
                                padding: 0.625rem 0.75rem;
                                border: 1px solid var(--border-color);
                                border-radius: 0.5rem;
                                font-size: 0.875rem;
                                font-family: inherit;
                                background: var(--bg-secondary);
                                color: var(--text-primary);
                                box-sizing: border-box;
                            ">
                                <option value="">None</option>
                                ${TECHNICIANS.filter(t => t.id !== tech?.id).sort((a, b) => a.name.localeCompare(b.name)).map(t => 
                                    `<option value="${t.name}" ${tech?.lineManager === t.name ? 'selected' : ''}>${t.name}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Workstream *</label>
                        <select id="techWorkstream" required style="
                            width: 100%;
                            padding: 0.625rem 0.75rem;
                            border: 1px solid var(--border-color);
                            border-radius: 0.5rem;
                            font-size: 0.875rem;
                            font-family: inherit;
                            background: var(--bg-secondary);
                            color: var(--text-primary);
                            box-sizing: border-box;
                        ">
                            <option value="">Select workstream...</option>
                            ${workstreamOptions}
                        </select>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <div>
                            <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">First Day</label>
                            <input type="date" id="techFirstDay" value="${tech?.first_day || ''}" style="
                                width: 100%;
                                padding: 0.625rem 0.75rem;
                                border: 1px solid var(--border-color);
                                border-radius: 0.5rem;
                                font-size: 0.875rem;
                                font-family: inherit;
                                background: var(--bg-secondary);
                                color: var(--text-primary);
                                box-sizing: border-box;
                            ">
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">End Date</label>
                            <input type="date" id="techEndDate" value="${tech?.end_date || ''}" style="
                                width: 100%;
                                padding: 0.625rem 0.75rem;
                                border: 1px solid var(--border-color);
                                border-radius: 0.5rem;
                                font-size: 0.875rem;
                                font-family: inherit;
                                background: var(--bg-secondary);
                                color: var(--text-primary);
                                box-sizing: border-box;
                            ">
                        </div>
                    </div>
                    <p style="margin: -1rem 0 1.5rem 0; font-size: 0.6875rem; color: var(--text-muted);">
                        First Day: Technician appears from this week with "First Day" status. End Date: Technician hidden after this date.
                    </p>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Notes</label>
                        <textarea id="techNotes" placeholder="Training, certifications, general info..." style="
                            width: 100%;
                            padding: 0.625rem 0.75rem;
                            border: 1px solid var(--border-color);
                            border-radius: 0.5rem;
                            font-size: 0.875rem;
                            font-family: inherit;
                            background: var(--bg-secondary);
                            color: var(--text-primary);
                            box-sizing: border-box;
                            min-height: 80px;
                            resize: vertical;
                        ">${tech?.notes || ''}</textarea>
                    </div>
                    <div style="display: flex; gap: 0.75rem;">
                        ${isEdit ? `<button type="button" onclick="deleteTechnician('${tech.id}')" style="
                            padding: 0.625rem 1rem;
                            border: 1px solid #f43f5e;
                            background: transparent;
                            color: #f43f5e;
                            border-radius: 0.5rem;
                            font-size: 0.875rem;
                            font-weight: 500;
                            cursor: pointer;
                            font-family: inherit;
                        ">Delete</button>` : ''}
                        <div style="flex: 1;"></div>
                        <button type="button" onclick="closeTechModal()" style="
                            padding: 0.625rem 1rem;
                            border: 1px solid var(--border-color);
                            background: var(--bg-secondary);
                            color: var(--text-primary);
                            border-radius: 0.5rem;
                            font-size: 0.875rem;
                            font-weight: 500;
                            cursor: pointer;
                            font-family: inherit;
                        ">Cancel</button>
                        <button type="submit" style="
                            padding: 0.625rem 1.25rem;
                            border: none;
                            background: var(--brand-gradient);
                            color: white;
                            border-radius: 0.5rem;
                            font-size: 0.875rem;
                            font-weight: 600;
                            cursor: pointer;
                            font-family: inherit;
                        ">${isEdit ? 'Save Changes' : 'Add Technician'}</button>
                    </div>
                </form>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            document.getElementById('techName').focus();

            document.getElementById('techForm').onsubmit = async (e) => {
                e.preventDefault();
                await saveTechnician(tech?.id);
            };

            setupModalClose(overlay, closeTechModal);
        }

        function closeTechModal() {
            const overlay = document.getElementById('techModalOverlay');
            if (overlay) overlay.remove();
        }

        function handleRoleChange() {
            const roleSelect = document.getElementById('techRole');
            
            if (roleSelect.value === '__add_new__') {
                const newRole = prompt('Enter new role name:');
                if (newRole && newRole.trim()) {
                    addRole(newRole.trim()).then(success => {
                        if (success) {
                            // Add the new option to the current dropdown
                            const option = document.createElement('option');
                            option.value = newRole.trim();
                            option.textContent = newRole.trim();
                            roleSelect.insertBefore(option, roleSelect.querySelector('option[value="__add_new__"]'));
                            roleSelect.value = newRole.trim();
                        } else {
                            roleSelect.value = '';
                        }
                    });
                } else {
                    roleSelect.value = '';
                }
            }
        }

        async function saveTechnician(techId = null) {
            const firstDay = document.getElementById('techFirstDay').value;
            const endDate = document.getElementById('techEndDate').value;
            const notes = document.getElementById('techNotes').value;
            
            const techData = {
                name: document.getElementById('techName').value,
                role: document.getElementById('techRole').value,
                postcode: document.getElementById('techPostcode').value,
                line_manager: document.getElementById('techManager').value,
                workstream: document.getElementById('techWorkstream').value,
                first_day: firstDay || null,
                end_date: endDate || null,
                notes: notes || null
            };

            let error;
            let newTechId = techId;
            
            if (techId) {
                // Update existing
                const result = await supabaseClient
                    .from('technicians')
                    .update(techData)
                    .eq('id', techId);
                error = result.error;
            } else {
                // Insert new
                const result = await supabaseClient
                    .from('technicians')
                    .insert([techData])
                    .select();
                error = result.error;
                if (result.data && result.data[0]) {
                    newTechId = result.data[0].id;
                }
            }

            if (error) {
                alert('Error saving technician: ' + error.message);
                return;
            }

            // If first day is set and this is a new tech, create the first day status entry
            if (firstDay && !techId && newTechId) {
                await supabaseClient
                    .from('schedule_entries')
                    .insert([{
                        technician_id: newTechId,
                        date: firstDay,
                        entry_type: 'status',
                        status_type: 'first_day',
                        status_text: 'Welcome!'
                    }]);
            }

            closeTechModal();
            closePanel();
            await loadAllData();
        }

        async function deleteTechnician(techId) {
            if (!confirm('Are you sure you want to delete this technician? This will also delete all their schedule entries.')) {
                return;
            }

            const { error } = await supabaseClient
                .from('technicians')
                .delete()
                .eq('id', techId);

            if (error) {
                alert('Error deleting technician: ' + error.message);
                return;
            }

            closeTechModal();
            closePanel();
            await loadAllData();
        }

        // ==================== SCHEDULE ENTRY CRUD ====================

        function showAddEntryModal(techId, dayIndex, isNightWork = false) {
            if (!currentUser) {
                alert('Please sign in to edit the schedule');
                return;
            }
            showEntryModal(techId, dayIndex, null, false, isNightWork);
        }

        function showEditEntryModal(techId, dayIndex, entryType = 'job') {
            if (!currentUser) {
                alert('Please sign in to edit');
                return;
            }
            const tech = TECHNICIANS.find(t => t.id === techId);
            const dayData = tech?.schedule[dayIndex];
            showEntryModal(techId, dayIndex, dayData, true);
        }

        function showEntryModal(techId, dayIndex, existingData = null, isEditMode = false, isNightWork = false) {
            const tech = TECHNICIANS.find(t => t.id === techId);
            if (!tech) return;

            const date = new Date(currentWeekStart);
            date.setDate(date.getDate() + dayIndex);
            // Use local date format to avoid timezone issues
            const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;

            const isStatus = existingData?.status || false;
            const existingIsNight = existingData?.jobs?.[0]?.isNight || false;
            
            // Build partner dropdown from current technicians
            const partnerOptions = TECHNICIANS
                .filter(t => t.id !== techId)
                .map(t => `<option value="${t.name}">${t.name}</option>`)
                .join('');
            
            const overlay = document.createElement('div');
            overlay.id = 'entryModalOverlay';
            overlay.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.6);
                backdrop-filter: blur(4px);
                z-index: 200;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            const modal = document.createElement('div');
            modal.id = 'entryModal';
            modal.style.cssText = `
                background: var(--bg-secondary);
                border-radius: 1rem;
                padding: 2rem;
                width: 90%;
                max-width: 480px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                max-height: 90vh;
                overflow-y: auto;
            `;

            const statusOptions = Object.entries(STATUS_CONFIG)
                .filter(([key]) => key !== 'night') // Remove night from status options
                .map(([key, val]) => `<option value="${key}" ${existingData?.status === key ? 'selected' : ''}>${val.icon} ${val.label}</option>`)
                .join('');

            const clientOptions = CLIENTS
                .map(c => `<option value="${c}">${c}</option>`)
                .join('') + '<option value="__add_new__">+ Add New Client...</option>';

            const titleText = isEditMode ? 'Edit Entry' : 'Add Entry';

            modal.innerHTML = `
                <h2 style="margin: 0 0 0.25rem 0; font-size: 1.25rem; color: var(--text-primary);">${titleText}</h2>
                <p style="margin: 0 0 1.5rem 0; font-size: 0.875rem; color: var(--text-muted);">${tech.name} - ${formatDate(date).full}</p>
                
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
                    <button type="button" id="tabJob" onclick="switchEntryTab('job')" style="
                        flex: 1;
                        padding: 0.625rem 1rem;
                        border: 1px solid var(--border-color);
                        background: ${!isStatus ? 'var(--brand-primary)' : 'var(--bg-secondary)'};
                        color: ${!isStatus ? 'white' : 'var(--text-primary)'};
                        border-radius: 0.5rem;
                        font-size: 0.875rem;
                        font-weight: 500;
                        cursor: pointer;
                        font-family: inherit;
                    ">Job</button>
                    <button type="button" id="tabStatus" onclick="switchEntryTab('status')" style="
                        flex: 1;
                        padding: 0.625rem 1rem;
                        border: 1px solid var(--border-color);
                        background: ${isStatus ? 'var(--brand-primary)' : 'var(--bg-secondary)'};
                        color: ${isStatus ? 'white' : 'var(--text-primary)'};
                        border-radius: 0.5rem;
                        font-size: 0.875rem;
                        font-weight: 500;
                        cursor: pointer;
                        font-family: inherit;
                    ">Status</button>
                </div>

                <form id="entryForm">
                    <input type="hidden" id="entryTechId" value="${techId}">
                    <input type="hidden" id="entryDate" value="${dateStr}">
                    <input type="hidden" id="entryDayIndex" value="${dayIndex}">
                    <input type="hidden" id="entryIsEditMode" value="${isEditMode}">
                    
                    <div id="jobFields" style="display: ${!isStatus ? 'block' : 'none'};">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: ${existingIsNight ? '#312e81' : 'var(--bg-tertiary)'}; border-radius: 0.5rem; border: 1px solid ${existingIsNight ? '#6366f1' : 'var(--border-color)'};" id="nightWorkLabel">
                                <input type="checkbox" id="entryIsNight" ${existingIsNight ? 'checked' : ''} onchange="toggleNightWorkStyle()" style="width: 1rem; height: 1rem; accent-color: #6366f1;">
                                <span style="font-size: 1rem;">üåô</span>
                                <span style="font-size: 0.875rem; font-weight: 500; color: ${existingIsNight ? '#a5b4fc' : 'var(--text-primary)'};" id="nightWorkText">Night Work</span>
                            </label>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Q Number</label>
                                <input type="text" id="entryQNumber" value="${existingData?.jobs?.[0]?.q || ''}" style="
                                    width: 100%;
                                    padding: 0.625rem 0.75rem;
                                    border: 1px solid var(--border-color);
                                    border-radius: 0.5rem;
                                    font-size: 0.875rem;
                                    font-family: inherit;
                                    background: var(--bg-secondary);
                                    color: var(--text-primary);
                                    box-sizing: border-box;
                                " placeholder="Q12345">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Client</label>
                                <select id="entryClient" onchange="toggleOtherClient()" style="
                                    width: 100%;
                                    padding: 0.625rem 0.75rem;
                                    border: 1px solid var(--border-color);
                                    border-radius: 0.5rem;
                                    font-size: 0.875rem;
                                    font-family: inherit;
                                    background: var(--bg-secondary);
                                    color: var(--text-primary);
                                    box-sizing: border-box;
                                ">
                                    <option value="">Select...</option>
                                    ${clientOptions}
                                </select>
                            </div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Location</label>
                            <input type="text" id="entryLocation" value="${existingData?.jobs?.[0]?.location || ''}" style="
                                width: 100%;
                                padding: 0.625rem 0.75rem;
                                border: 1px solid var(--border-color);
                                border-radius: 0.5rem;
                                font-size: 0.875rem;
                                font-family: inherit;
                                background: var(--bg-secondary);
                                color: var(--text-primary);
                                box-sizing: border-box;
                            " placeholder="Site name or address">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Task</label>
                                <input type="text" id="entryTask" value="${existingData?.jobs?.[0]?.task || ''}" style="
                                    width: 100%;
                                    padding: 0.625rem 0.75rem;
                                    border: 1px solid var(--border-color);
                                    border-radius: 0.5rem;
                                    font-size: 0.875rem;
                                    font-family: inherit;
                                    background: var(--bg-secondary);
                                    color: var(--text-primary);
                                    box-sizing: border-box;
                                " placeholder="What are they doing?">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Partner</label>
                                <select id="entryPartner" style="
                                    width: 100%;
                                    padding: 0.625rem 0.75rem;
                                    border: 1px solid var(--border-color);
                                    border-radius: 0.5rem;
                                    font-size: 0.875rem;
                                    font-family: inherit;
                                    background: var(--bg-secondary);
                                    color: var(--text-primary);
                                    box-sizing: border-box;
                                ">
                                    <option value="">None</option>
                                    ${partnerOptions}
                                </select>
                            </div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Job Status</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <label style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 0.375rem; padding: 0.5rem; border-radius: 0.5rem; cursor: pointer; border: 2px solid ${existingData?.jobs?.[0]?.jobStatus === 'inactive' ? '#ef4444' : 'var(--border-color)'}; background: ${existingData?.jobs?.[0]?.jobStatus === 'inactive' ? 'rgba(239,68,68,0.1)' : 'transparent'};" id="statusInactiveLabel">
                                    <input type="radio" name="jobStatus" value="inactive" ${existingData?.jobs?.[0]?.jobStatus === 'inactive' ? 'checked' : ''} onchange="updateJobStatusStyle()" style="display: none;">
                                    <span style="width: 10px; height: 10px; border-radius: 50%; background: #ef4444;"></span>
                                    <span style="font-size: 0.75rem; font-weight: 500;">Inactive</span>
                                </label>
                                <label style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 0.375rem; padding: 0.5rem; border-radius: 0.5rem; cursor: pointer; border: 2px solid ${existingData?.jobs?.[0]?.jobStatus === 'pending' ? '#f59e0b' : 'var(--border-color)'}; background: ${existingData?.jobs?.[0]?.jobStatus === 'pending' ? 'rgba(245,158,11,0.1)' : 'transparent'};" id="statusPendingLabel">
                                    <input type="radio" name="jobStatus" value="pending" ${existingData?.jobs?.[0]?.jobStatus === 'pending' ? 'checked' : ''} onchange="updateJobStatusStyle()" style="display: none;">
                                    <span style="width: 10px; height: 10px; border-radius: 50%; background: #f59e0b;"></span>
                                    <span style="font-size: 0.75rem; font-weight: 500;">Pending</span>
                                </label>
                                <label style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 0.375rem; padding: 0.5rem; border-radius: 0.5rem; cursor: pointer; border: 2px solid ${(existingData?.jobs?.[0]?.jobStatus === 'live' || !existingData?.jobs?.[0]?.jobStatus) ? '#22c55e' : 'var(--border-color)'}; background: ${(existingData?.jobs?.[0]?.jobStatus === 'live' || !existingData?.jobs?.[0]?.jobStatus) ? 'rgba(34,197,94,0.1)' : 'transparent'};" id="statusLiveLabel">
                                    <input type="radio" name="jobStatus" value="live" ${(existingData?.jobs?.[0]?.jobStatus === 'live' || !existingData?.jobs?.[0]?.jobStatus) ? 'checked' : ''} onchange="updateJobStatusStyle()" style="display: none;">
                                    <span style="width: 10px; height: 10px; border-radius: 50%; background: #22c55e;"></span>
                                    <span style="font-size: 0.75rem; font-weight: 500;">Live</span>
                                </label>
                            </div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Notes (optional)</label>
                            <textarea id="entryNotes" style="
                                width: 100%;
                                padding: 0.625rem 0.75rem;
                                border: 1px solid var(--border-color);
                                border-radius: 0.5rem;
                                font-size: 0.875rem;
                                font-family: inherit;
                                background: var(--bg-secondary);
                                color: var(--text-primary);
                                box-sizing: border-box;
                                min-height: 60px;
                                resize: vertical;
                            " placeholder="Additional information...">${existingData?.jobs?.[0]?.notes || ''}</textarea>
                        </div>
                    </div>

                    <div id="statusFields" style="display: ${isStatus ? 'block' : 'none'};">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Status Type</label>
                            <select id="entryStatusType" style="
                                width: 100%;
                                padding: 0.625rem 0.75rem;
                                border: 1px solid var(--border-color);
                                border-radius: 0.5rem;
                                font-size: 0.875rem;
                                font-family: inherit;
                                background: var(--bg-secondary);
                                color: var(--text-primary);
                                box-sizing: border-box;
                            ">
                                <option value="">Select status...</option>
                                ${statusOptions}
                            </select>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Notes (optional)</label>
                            <input type="text" id="entryStatusText" value="${existingData?.text || ''}" style="
                                width: 100%;
                                padding: 0.625rem 0.75rem;
                                border: 1px solid var(--border-color);
                                border-radius: 0.5rem;
                                font-size: 0.875rem;
                                font-family: inherit;
                                background: var(--bg-secondary);
                                color: var(--text-primary);
                                box-sizing: border-box;
                            " placeholder="Additional details...">
                        </div>
                    </div>

                    <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                        ${isEditMode ? `<button type="button" onclick="clearDayEntries('${techId}', ${dayIndex})" style="
                            padding: 0.625rem 1rem;
                            border: 1px solid #f43f5e;
                            background: transparent;
                            color: #f43f5e;
                            border-radius: 0.5rem;
                            font-size: 0.875rem;
                            font-weight: 500;
                            cursor: pointer;
                            font-family: inherit;
                        ">Clear Day</button>` : ''}
                        <div style="flex: 1;"></div>
                        <button type="button" onclick="confirmCloseEntryModal()" style="
                            padding: 0.625rem 1rem;
                            border: 1px solid var(--border-color);
                            background: var(--bg-secondary);
                            color: var(--text-primary);
                            border-radius: 0.5rem;
                            font-size: 0.875rem;
                            font-weight: 500;
                            cursor: pointer;
                            font-family: inherit;
                        ">Cancel</button>
                        <button type="submit" style="
                            padding: 0.625rem 1.25rem;
                            border: none;
                            background: var(--brand-gradient);
                            color: white;
                            border-radius: 0.5rem;
                            font-size: 0.875rem;
                            font-weight: 600;
                            cursor: pointer;
                            font-family: inherit;
                        ">Save</button>
                    </div>
                </form>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // Set client value if editing
            if (existingData?.jobs?.[0]?.client) {
                const clientSelect = document.getElementById('entryClient');
                const clientValue = existingData.jobs[0].client;
                // Check if it's in our clients list
                if (CLIENTS.includes(clientValue)) {
                    clientSelect.value = clientValue;
                } else {
                    // Client not in list - might be a legacy value, just set it
                    clientSelect.value = clientValue;
                }
            }

            // Set partner value if editing
            if (existingData?.jobs?.[0]?.partner) {
                document.getElementById('entryPartner').value = existingData.jobs[0].partner;
            }

            document.getElementById('entryForm').onsubmit = async (e) => {
                e.preventDefault();
                await saveEntry();
            };

            let mouseDownOnOverlay = false;
            overlay.addEventListener('mousedown', (e) => {
                mouseDownOnOverlay = (e.target === overlay);
            });
            overlay.addEventListener('mouseup', (e) => {
                if (mouseDownOnOverlay && e.target === overlay) {
                    if (hasUnsavedEntryChanges()) {
                        if (confirm('You have unsaved changes. Are you sure you want to close?')) {
                            closeEntryModal();
                        }
                    } else {
                        closeEntryModal();
                    }
                }
                mouseDownOnOverlay = false;
            });
        }

        function hasUnsavedEntryChanges() {
            // Check if job tab has any data
            const qNumber = document.getElementById('entryQNumber')?.value?.trim();
            const client = document.getElementById('entryClient')?.value;
            const location = document.getElementById('entryLocation')?.value?.trim();
            const task = document.getElementById('entryTask')?.value?.trim();
            const partner = document.getElementById('entryPartner')?.value;
            const notes = document.getElementById('entryNotes')?.value?.trim();
            
            // Check if status tab has data
            const statusType = document.getElementById('entryStatusType')?.value;
            const statusText = document.getElementById('entryStatusText')?.value?.trim();
            
            // Check which tab is active
            const jobFields = document.getElementById('jobFields');
            const isJobTab = jobFields && jobFields.style.display !== 'none';
            
            if (isJobTab) {
                // If on job tab, check if any job fields have data
                return !!(qNumber || client || location || task || partner || notes);
            } else {
                // If on status tab, check if status is selected
                return !!(statusType || statusText);
            }
        }

        function toggleNightWorkStyle() {
            const checkbox = document.getElementById('entryIsNight');
            const label = document.getElementById('nightWorkLabel');
            const text = document.getElementById('nightWorkText');
            
            if (checkbox.checked) {
                label.style.background = '#312e81';
                label.style.borderColor = '#6366f1';
                text.style.color = '#a5b4fc';
            } else {
                label.style.background = 'var(--bg-tertiary)';
                label.style.borderColor = 'var(--border-color)';
                text.style.color = 'var(--text-primary)';
            }
        }

        function updateJobStatusStyle() {
            const statuses = ['inactive', 'pending', 'live'];
            const colors = { inactive: '#ef4444', pending: '#f59e0b', live: '#22c55e' };
            
            statuses.forEach(status => {
                const label = document.getElementById(`status${status.charAt(0).toUpperCase() + status.slice(1)}Label`);
                const radio = document.querySelector(`input[name="jobStatus"][value="${status}"]`);
                
                if (radio.checked) {
                    label.style.borderColor = colors[status];
                    label.style.background = `rgba(${status === 'inactive' ? '239,68,68' : status === 'pending' ? '245,158,11' : '34,197,94'},0.1)`;
                } else {
                    label.style.borderColor = 'var(--border-color)';
                    label.style.background = 'transparent';
                }
            });
        }

        function toggleOtherClient() {
            const clientSelect = document.getElementById('entryClient');
            
            if (clientSelect.value === '__add_new__') {
                // Prompt for new client name
                const newClient = prompt('Enter new client name:');
                if (newClient && newClient.trim()) {
                    // Add to database and update dropdowns
                    addClient(newClient.trim()).then(success => {
                        if (success) {
                            // Add the new option to the current dropdown
                            const option = document.createElement('option');
                            option.value = newClient.trim();
                            option.textContent = newClient.trim();
                            clientSelect.insertBefore(option, clientSelect.querySelector('option[value="__add_new__"]'));
                            clientSelect.value = newClient.trim();
                        } else {
                            clientSelect.value = '';
                        }
                    });
                } else {
                    clientSelect.value = '';
                }
            }
        }

        function switchEntryTab(tab) {
            const jobFields = document.getElementById('jobFields');
            const statusFields = document.getElementById('statusFields');
            const tabJob = document.getElementById('tabJob');
            const tabStatus = document.getElementById('tabStatus');

            if (tab === 'job') {
                jobFields.style.display = 'block';
                statusFields.style.display = 'none';
                tabJob.style.background = 'var(--brand-primary)';
                tabJob.style.color = 'white';
                tabStatus.style.background = 'var(--bg-secondary)';
                tabStatus.style.color = 'var(--text-primary)';
            } else {
                jobFields.style.display = 'none';
                statusFields.style.display = 'block';
                tabStatus.style.background = 'var(--brand-primary)';
                tabStatus.style.color = 'white';
                tabJob.style.background = 'var(--bg-secondary)';
                tabJob.style.color = 'var(--text-primary)';
            }
        }

        function closeEntryModal() {
            const overlay = document.getElementById('entryModalOverlay');
            if (overlay) overlay.remove();
        }

        function confirmCloseEntryModal() {
            if (hasUnsavedEntryChanges()) {
                if (confirm('You have unsaved changes. Are you sure you want to close?')) {
                    closeEntryModal();
                }
            } else {
                closeEntryModal();
            }
        }

        async function saveEntry() {
            suppressRealtimeEvents(3000); // Ignore realtime for 3 seconds
            
            const techId = document.getElementById('entryTechId').value;
            const dateStr = document.getElementById('entryDate').value;
            const isEditMode = document.getElementById('entryIsEditMode').value === 'true';
            
            // Calculate day index
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(currentWeekStart);
                d.setDate(d.getDate() + i);
                weekDates.push(toLocalDateString(d));
            }
            const dayIndex = weekDates.indexOf(dateStr);

            // Get old job data for partner sync
            const tech = TECHNICIANS.find(t => t.id === techId);
            const editingJobIndex = window.editingJobIndex;
            const oldJob = editingJobIndex !== undefined ? tech?.schedule[dayIndex]?.jobs?.[editingJobIndex] : tech?.schedule[dayIndex]?.jobs?.[0];
            const oldPartnerName = oldJob?.partner;

            // Only clear existing entries if we're in edit mode
            if (isEditMode) {
                // Also delete partner's linked entry if exists
                if (oldPartnerName) {
                    const oldPartner = TECHNICIANS.find(t => t.name === oldPartnerName);
                    if (oldPartner) {
                        await supabaseClient
                            .from('schedule_entries')
                            .delete()
                            .eq('technician_id', oldPartner.id)
                            .eq('date', dateStr)
                            .eq('partner', tech.name)
                            .eq('q_number', oldJob.q);
                        
                        // Update old partner's cell locally
                        await reloadTechnicianDay(oldPartner, dayIndex, dateStr);
                        updateCell(oldPartner, dayIndex);
                    }
                }
                
                // Delete only the specific job being edited, not all jobs
                if (oldJob) {
                    await supabaseClient
                        .from('schedule_entries')
                        .delete()
                        .eq('technician_id', techId)
                        .eq('date', dateStr)
                        .eq('q_number', oldJob.q)
                        .eq('location', oldJob.location);
                } else {
                    // Fallback: delete all entries for this day (for status entries)
                    await supabaseClient
                        .from('schedule_entries')
                        .delete()
                        .eq('technician_id', techId)
                        .eq('date', dateStr);
                }
            }
            
            // Clear the editing index
            window.editingJobIndex = undefined;

            const jobFields = document.getElementById('jobFields');
            const isJob = jobFields.style.display !== 'none';

            let entryData;
            let partnerEntryData = null;
            
            if (isJob) {
                const qNumber = document.getElementById('entryQNumber').value;
                const client = document.getElementById('entryClient').value;
                const location = document.getElementById('entryLocation').value;
                const task = document.getElementById('entryTask').value;
                const partnerName = document.getElementById('entryPartner').value;
                const isNight = document.getElementById('entryIsNight').checked;
                const jobStatus = document.querySelector('input[name="jobStatus"]:checked')?.value || 'live';
                const notes = document.getElementById('entryNotes').value;

                if (!qNumber && !location && !task) {
                    closeEntryModal();
                    closePanel();
                    // Update cell locally
                    if (tech && dayIndex >= 0) {
                        await reloadTechnicianDay(tech, dayIndex, dateStr);
                        updateCell(tech, dayIndex);
                    }
                    return;
                }

                entryData = {
                    technician_id: techId,
                    date: dateStr,
                    entry_type: 'job',
                    q_number: qNumber,
                    client: client,
                    location: location,
                    task: task,
                    partner: partnerName || null,
                    is_night: isNight,
                    job_status: jobStatus,
                    notes: notes || null
                };

                // Create partner entry if partner selected
                if (partnerName) {
                    const partnerTech = TECHNICIANS.find(t => t.name === partnerName);
                    if (partnerTech) {
                        partnerEntryData = {
                            technician_id: partnerTech.id,
                            date: dateStr,
                            entry_type: 'job',
                            q_number: qNumber,
                            client: client,
                            location: location,
                            task: task,
                            partner: tech.name, // The original tech is the partner
                            is_night: isNight,
                            job_status: jobStatus,
                            notes: notes || null
                        };
                    }
                }
            } else {
                const statusType = document.getElementById('entryStatusType').value;
                const statusText = document.getElementById('entryStatusText').value;

                if (!statusType) {
                    closeEntryModal();
                    closePanel();
                    if (tech && dayIndex >= 0) {
                        await reloadTechnicianDay(tech, dayIndex, dateStr);
                        updateCell(tech, dayIndex);
                    }
                    return;
                }

                entryData = {
                    technician_id: techId,
                    date: dateStr,
                    entry_type: 'status',
                    status_type: statusType,
                    status_text: statusText || null
                };
            }

            // Insert main entry
            const { error } = await supabaseClient
                .from('schedule_entries')
                .insert([entryData]);

            if (error) {
                alert('Error saving entry: ' + error.message);
                return;
            }

            // Insert partner entry if exists
            if (partnerEntryData) {
                const partnerTech = TECHNICIANS.find(t => t.id === partnerEntryData.technician_id);
                
                const { error: partnerError } = await supabaseClient
                    .from('schedule_entries')
                    .insert([partnerEntryData]);

                if (partnerError) {
                    console.error('Error saving partner entry:', partnerError);
                } else if (partnerTech && dayIndex >= 0) {
                    // Update partner's cell locally
                    await reloadTechnicianDay(partnerTech, dayIndex, dateStr);
                    updateCell(partnerTech, dayIndex);
                }
            }

            // Update main tech's cell locally
            if (tech && dayIndex >= 0) {
                await reloadTechnicianDay(tech, dayIndex, dateStr);
                updateCell(tech, dayIndex);
            }

            closeEntryModal();
            closePanel();
            showUpdateToast('Entry saved');
        }

        async function clearDayEntries(techId, dayIndex) {
            if (!confirm('Clear all entries for this day?')) return;
            
            suppressRealtimeEvents(3000); // Ignore realtime for 3 seconds

            const date = new Date(currentWeekStart);
            date.setDate(date.getDate() + dayIndex);
            const dateStr = toLocalDateString(date);

            const tech = TECHNICIANS.find(t => t.id === techId);
            if (!tech) return;

            // Get partners from existing jobs to delete their linked entries
            const jobs = tech.schedule[dayIndex]?.jobs || [];
            const partnersToUpdate = [];
            
            for (const job of jobs) {
                if (job.partner) {
                    const partnerTech = TECHNICIANS.find(t => t.name === job.partner);
                    if (partnerTech) {
                        // Delete partner's entry that has this tech as partner
                        await supabaseClient
                            .from('schedule_entries')
                            .delete()
                            .eq('technician_id', partnerTech.id)
                            .eq('date', dateStr)
                            .eq('partner', tech.name);
                        
                        partnersToUpdate.push({ tech: partnerTech, dayIndex, dateStr });
                    }
                }
            }

            // Delete main tech's entries
            const { error } = await supabaseClient
                .from('schedule_entries')
                .delete()
                .eq('technician_id', techId)
                .eq('date', dateStr);

            if (error) {
                alert('Error clearing entries: ' + error.message);
                return;
            }

            // Update main tech's cell locally
            tech.schedule[dayIndex] = { jobs: [] };
            updateCell(tech, dayIndex);

            // Update partner cells
            for (const p of partnersToUpdate) {
                await reloadTechnicianDay(p.tech, p.dayIndex, p.dateStr);
                updateCell(p.tech, p.dayIndex);
            }

            // Broadcast to other users
            const cellsToRefresh = [{ techId: techId, dateStr: dateStr }];
            for (const p of partnersToUpdate) {
                cellsToRefresh.push({ techId: p.tech.id, dateStr: p.dateStr });
            }
            broadcastCellRefresh(cellsToRefresh);

            closeEntryModal();
            closePanel();
            showUpdateToast('Day cleared');
        }

        // Edit a single job by index
        function editSingleJob(techId, dayIndex, jobIndex) {
            const tech = TECHNICIANS.find(t => t.id === techId);
            if (!tech) return;
            
            const job = tech.schedule[dayIndex]?.jobs?.[jobIndex];
            if (!job) return;
            
            const date = new Date(currentWeekStart);
            date.setDate(date.getDate() + dayIndex);
            const dateStr = toLocalDateString(date);
            
            // Create a fake dayData with just this one job for the modal
            const singleJobData = { jobs: [job] };
            
            // Store which job we're editing
            window.editingJobIndex = jobIndex;
            
            showEntryModal(techId, dayIndex, singleJobData, true, job.isNight);
        }

        // Delete a single job by index
        async function deleteSingleJob(techId, dayIndex, jobIndex) {
            const tech = TECHNICIANS.find(t => t.id === techId);
            if (!tech) return;
            
            const job = tech.schedule[dayIndex]?.jobs?.[jobIndex];
            if (!job) return;
            
            // Show delete confirmation modal with reason
            showDeleteJobModal(techId, dayIndex, jobIndex, job, tech);
        }

        function showDeleteJobModal(techId, dayIndex, jobIndex, job, tech) {
            const overlay = document.createElement('div');
            overlay.id = 'deleteJobOverlay';
            overlay.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.6);
                backdrop-filter: blur(4px);
                z-index: 250;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--bg-secondary);
                border-radius: 1rem;
                padding: 2rem;
                width: 90%;
                max-width: 400px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            `;

            modal.innerHTML = `
                <h2 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; color: var(--text-primary);">üóëÔ∏è Delete Job</h2>
                <p style="margin: 0 0 1.5rem 0; font-size: 0.875rem; color: var(--text-muted);">
                    <strong style="color: var(--brand-primary);">${job.q || 'Job'}</strong> ¬∑ ${job.location || 'No location'}<br>
                    ${tech.name}
                </p>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.5rem;">Was this job canceled?</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <label style="
                            flex: 1;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 0.5rem;
                            padding: 0.625rem;
                            border: 1px solid var(--border-color);
                            border-radius: 0.5rem;
                            cursor: pointer;
                            background: var(--bg-tertiary);
                        " id="cancelYesLabel">
                            <input type="radio" name="wasCanceled" value="yes" style="margin: 0;">
                            <span style="font-size: 0.875rem;">Yes, canceled</span>
                        </label>
                        <label style="
                            flex: 1;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 0.5rem;
                            padding: 0.625rem;
                            border: 1px solid var(--border-color);
                            border-radius: 0.5rem;
                            cursor: pointer;
                            background: var(--bg-tertiary);
                        " id="cancelNoLabel">
                            <input type="radio" name="wasCanceled" value="no" checked style="margin: 0;">
                            <span style="font-size: 0.875rem;">No</span>
                        </label>
                    </div>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Reason / Notes <span style="color: var(--text-muted);">(required)</span></label>
                    <textarea id="deleteJobNotes" required placeholder="Why is this job being deleted?" style="
                        width: 100%;
                        padding: 0.625rem 0.75rem;
                        border: 1px solid var(--border-color);
                        border-radius: 0.5rem;
                        font-size: 0.875rem;
                        font-family: inherit;
                        background: var(--bg-secondary);
                        color: var(--text-primary);
                        box-sizing: border-box;
                        min-height: 80px;
                        resize: vertical;
                    "></textarea>
                </div>
                
                <div style="display: flex; gap: 0.75rem;">
                    <button onclick="closeDeleteJobModal()" style="
                        flex: 1;
                        padding: 0.625rem 1rem;
                        border: 1px solid var(--border-color);
                        background: var(--bg-secondary);
                        color: var(--text-primary);
                        border-radius: 0.5rem;
                        font-size: 0.875rem;
                        font-weight: 500;
                        cursor: pointer;
                        font-family: inherit;
                    ">Cancel</button>
                    <button onclick="executeDeleteJob('${techId}', ${dayIndex}, ${jobIndex})" id="confirmDeleteBtn" style="
                        flex: 1;
                        padding: 0.625rem 1rem;
                        border: 1px solid #f43f5e;
                        background: rgba(244, 63, 94, 0.1);
                        color: #f43f5e;
                        border-radius: 0.5rem;
                        font-size: 0.875rem;
                        font-weight: 600;
                        cursor: pointer;
                        font-family: inherit;
                    ">Delete Job</button>
                </div>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // Focus on notes field
            document.getElementById('deleteJobNotes').focus();

            setupModalClose(overlay, closeDeleteJobModal);
        }

        function closeDeleteJobModal() {
            const overlay = document.getElementById('deleteJobOverlay');
            if (overlay) overlay.remove();
        }

        async function executeDeleteJob(techId, dayIndex, jobIndex) {
            const notes = document.getElementById('deleteJobNotes').value.trim();
            if (!notes) {
                alert('Please enter a reason for deleting this job.');
                document.getElementById('deleteJobNotes').focus();
                return;
            }

            const wasCanceled = document.querySelector('input[name="wasCanceled"]:checked').value === 'yes';
            
            const tech = TECHNICIANS.find(t => t.id === techId);
            if (!tech) return;
            
            const job = tech.schedule[dayIndex]?.jobs?.[jobIndex];
            if (!job) return;

            const btn = document.getElementById('confirmDeleteBtn');
            btn.disabled = true;
            btn.textContent = 'Deleting...';
            
            suppressRealtimeEvents(3000);
            
            const date = new Date(currentWeekStart);
            date.setDate(date.getDate() + dayIndex);
            const dateStr = toLocalDateString(date);
            
            try {
                // Log to audit table first
                await supabaseClient
                    .from('audit_log')
                    .insert([{
                        action: 'job_deleted',
                        technician_id: techId,
                        technician_name: tech.name,
                        date: dateStr,
                        job_details: {
                            q_number: job.q,
                            client: job.client,
                            location: job.location,
                            task: job.task,
                            partner: job.partner,
                            is_night: job.isNight,
                            job_status: job.jobStatus
                        },
                        was_canceled: wasCanceled,
                        notes: notes,
                        performed_by: currentUser?.email
                    }]);

                // Delete this specific job by matching its fields
                const { error } = await supabaseClient
                    .from('schedule_entries')
                    .delete()
                    .eq('technician_id', techId)
                    .eq('date', dateStr)
                    .eq('q_number', job.q)
                    .eq('location', job.location);
                
                if (error) throw error;
                
                // If job had a partner, delete their linked entry too
                if (job.partner) {
                    const partnerTech = TECHNICIANS.find(t => t.name === job.partner);
                    if (partnerTech) {
                        // Log to audit table for partner too
                        await supabaseClient
                            .from('audit_log')
                            .insert([{
                                action: 'job_deleted',
                                technician_id: partnerTech.id,
                                technician_name: partnerTech.name,
                                date: dateStr,
                                job_details: {
                                    q_number: job.q,
                                    client: job.client,
                                    location: job.location,
                                    task: job.task,
                                    partner: tech.name,
                                    is_night: job.isNight,
                                    job_status: job.jobStatus
                                },
                                was_canceled: wasCanceled,
                                notes: notes + ` (deleted via ${tech.name})`,
                                performed_by: currentUser?.email
                            }]);

                        await supabaseClient
                            .from('schedule_entries')
                            .delete()
                            .eq('technician_id', partnerTech.id)
                            .eq('date', dateStr)
                            .eq('partner', tech.name)
                            .eq('q_number', job.q);
                        
                        // Update partner cell
                        await reloadTechnicianDay(partnerTech, dayIndex, dateStr);
                        updateCell(partnerTech, dayIndex);
                        
                        // Broadcast to other users
                        broadcastCellRefresh([
                            { techId: techId, dateStr: dateStr },
                            { techId: partnerTech.id, dateStr: dateStr }
                        ]);
                    } else {
                        broadcastCellRefresh([{ techId: techId, dateStr: dateStr }]);
                    }
                } else {
                    broadcastCellRefresh([{ techId: techId, dateStr: dateStr }]);
                }
                
                closeDeleteJobModal();
                
                // Update main tech cell
                await reloadTechnicianDay(tech, dayIndex, dateStr);
                updateCell(tech, dayIndex);
                
                // Refresh the panel to show updated job list
                openPanel(techId, dayIndex);
                showUpdateToast(wasCanceled ? 'Job canceled and logged' : 'Job deleted and logged');
                
            } catch (err) {
                console.error('Error deleting job:', err);
                alert('Error deleting job: ' + err.message);
                btn.disabled = false;
                btn.textContent = 'Delete Job';
            }
        }

        // ==================== BULK ENTRY ====================

        let bulkEntryState = {
            dayIndex: null,
            dateStr: null,
            statusType: null,
            statusText: null,
            workstream: 'all',
            techsToProcess: [],
            currentTechIndex: 0
        };

        function showBulkEntryModal(dayIndex) {
            if (!currentUser) return;

            const date = new Date(currentWeekStart);
            date.setDate(date.getDate() + dayIndex);
            const dateStr = toLocalDateString(date);

            bulkEntryState.dayIndex = dayIndex;
            bulkEntryState.dateStr = dateStr;

            const overlay = document.createElement('div');
            overlay.id = 'bulkEntryOverlay';
            overlay.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.6);
                backdrop-filter: blur(4px);
                z-index: 200;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--bg-secondary);
                border-radius: 1rem;
                padding: 2rem;
                width: 90%;
                max-width: 400px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            `;

            const workstreamOptions = ['all', ...WORKSTREAMS.map(ws => ws.name)]
                .map(ws => `<option value="${ws}">${ws === 'all' ? 'All Workstreams' : ws}</option>`)
                .join('');

            const bulkStatusOptions = [
                { value: 'leave', label: 'üå¥ Annual Leave' },
                { value: 'training', label: 'üìö Training' },
                { value: 'office', label: 'üè¢ Office' },
                { value: 'sickness', label: 'üè• Sickness' },
                { value: 'wfh', label: 'üè† WFH' },
                { value: 'rest', label: '‚òÄÔ∏è Rest Day' },
                { value: 'bank_holiday', label: 'üéâ Bank Holiday' }
            ].map(s => `<option value="${s.value}">${s.label}</option>`).join('');

            modal.innerHTML = `
                <h2 style="margin: 0 0 0.25rem 0; font-size: 1.25rem; color: var(--text-primary);">Bulk Add Status</h2>
                <p style="margin: 0 0 1.5rem 0; font-size: 0.875rem; color: var(--text-muted);">${formatDate(date).full}</p>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Workstream</label>
                    <select id="bulkWorkstream" style="
                        width: 100%;
                        padding: 0.625rem 0.75rem;
                        border: 1px solid var(--border-color);
                        border-radius: 0.5rem;
                        font-size: 0.875rem;
                        font-family: inherit;
                        background: var(--bg-secondary);
                        color: var(--text-primary);
                        box-sizing: border-box;
                    ">
                        ${workstreamOptions}
                    </select>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Status</label>
                    <select id="bulkStatusType" style="
                        width: 100%;
                        padding: 0.625rem 0.75rem;
                        border: 1px solid var(--border-color);
                        border-radius: 0.5rem;
                        font-size: 0.875rem;
                        font-family: inherit;
                        background: var(--bg-secondary);
                        color: var(--text-primary);
                        box-sizing: border-box;
                    ">
                        <option value="">Select status...</option>
                        ${bulkStatusOptions}
                    </select>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Notes (optional)</label>
                    <input type="text" id="bulkStatusText" style="
                        width: 100%;
                        padding: 0.625rem 0.75rem;
                        border: 1px solid var(--border-color);
                        border-radius: 0.5rem;
                        font-size: 0.875rem;
                        font-family: inherit;
                        background: var(--bg-secondary);
                        color: var(--text-primary);
                        box-sizing: border-box;
                    " placeholder="e.g. Christmas Day">
                </div>

                <div style="display: flex; gap: 0.75rem; margin-bottom: 0.75rem;">
                    <button type="button" onclick="closeBulkEntryModal()" style="
                        flex: 1;
                        padding: 0.625rem 1rem;
                        border: 1px solid var(--border-color);
                        background: var(--bg-secondary);
                        color: var(--text-primary);
                        border-radius: 0.5rem;
                        font-size: 0.875rem;
                        font-weight: 500;
                        cursor: pointer;
                        font-family: inherit;
                    ">Cancel</button>
                    <button type="button" onclick="startBulkEntry()" style="
                        flex: 1;
                        padding: 0.625rem 1rem;
                        border: none;
                        background: var(--brand-gradient);
                        color: white;
                        border-radius: 0.5rem;
                        font-size: 0.875rem;
                        font-weight: 600;
                        cursor: pointer;
                        font-family: inherit;
                    ">Apply Status</button>
                </div>
                <button type="button" onclick="startBulkClear()" style="
                    width: 100%;
                    padding: 0.625rem 1rem;
                    border: 1px solid #f43f5e;
                    background: rgba(244, 63, 94, 0.1);
                    color: #f43f5e;
                    border-radius: 0.5rem;
                    font-size: 0.875rem;
                    font-weight: 500;
                    cursor: pointer;
                    font-family: inherit;
                ">üóëÔ∏è Clear Day for Selected Workstream</button>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            setupModalClose(overlay, closeBulkEntryModal);
        }

        function closeBulkEntryModal() {
            const overlay = document.getElementById('bulkEntryOverlay');
            if (overlay) overlay.remove();
        }

        async function startBulkEntry() {
            const statusType = document.getElementById('bulkStatusType').value;
            if (!statusType) {
                alert('Please select a status');
                return;
            }
            
            suppressRealtimeEvents(5000); // Ignore realtime for 5 seconds (bulk operation)

            bulkEntryState.statusType = statusType;
            bulkEntryState.statusText = document.getElementById('bulkStatusText').value;
            bulkEntryState.workstream = document.getElementById('bulkWorkstream').value;

            // Get technicians to process
            let techs = TECHNICIANS;
            if (bulkEntryState.workstream !== 'all') {
                techs = techs.filter(t => t.workstream === bulkEntryState.workstream);
            }

            bulkEntryState.techsToProcess = techs;
            bulkEntryState.currentTechIndex = 0;

            closeBulkEntryModal();
            await processNextBulkEntry();
        }

        async function startBulkClear() {
            const workstream = document.getElementById('bulkWorkstream').value;
            const workstreamLabel = workstream === 'all' ? 'ALL technicians' : `all ${workstream} technicians`;
            
            if (!confirm(`Are you sure you want to clear all entries for ${workstreamLabel} on this day?\n\nThis cannot be undone.`)) {
                return;
            }
            
            suppressRealtimeEvents(5000); // Ignore realtime for 5 seconds (bulk operation)

            // Get technicians to clear
            let techs = TECHNICIANS;
            if (workstream !== 'all') {
                techs = techs.filter(t => t.workstream === workstream);
            }

            const dayIndex = bulkEntryState.dayIndex;
            const dateStr = bulkEntryState.dateStr;
            const techIds = techs.map(t => t.id);
            const partnersToUpdate = new Set();

            // Find partners that need updating (outside the workstream being cleared)
            for (const tech of techs) {
                const jobs = tech.schedule[dayIndex]?.jobs || [];
                for (const job of jobs) {
                    if (job.partner) {
                        const partnerTech = TECHNICIANS.find(t => t.name === job.partner);
                        if (partnerTech && !techIds.includes(partnerTech.id)) {
                            // Partner is outside the workstream being cleared
                            partnersToUpdate.add(partnerTech.id);
                            // Delete their linked entry
                            await supabaseClient
                                .from('schedule_entries')
                                .delete()
                                .eq('technician_id', partnerTech.id)
                                .eq('date', dateStr)
                                .eq('partner', tech.name);
                        }
                    }
                }
            }
            
            const { error } = await supabaseClient
                .from('schedule_entries')
                .delete()
                .eq('date', dateStr)
                .in('technician_id', techIds);

            if (error) {
                alert('Error clearing entries: ' + error.message);
                return;
            }

            // Update cells locally instead of full reload
            techs.forEach(tech => {
                tech.schedule[dayIndex] = { jobs: [] };
                updateCell(tech, dayIndex);
            });

            // Update partner cells
            for (const partnerId of partnersToUpdate) {
                const partnerTech = TECHNICIANS.find(t => t.id === partnerId);
                if (partnerTech) {
                    await reloadTechnicianDay(partnerTech, dayIndex, dateStr);
                    updateCell(partnerTech, dayIndex);
                }
            }

            // Broadcast to other users
            const cellsToRefresh = techs.map(t => ({ techId: t.id, dateStr: dateStr }));
            for (const partnerId of partnersToUpdate) {
                cellsToRefresh.push({ techId: partnerId, dateStr: dateStr });
            }
            broadcastCellRefresh(cellsToRefresh);

            closeBulkEntryModal();
            showUpdateToast(`Cleared ${techs.length} technician(s)`);
        }

        async function processNextBulkEntry() {
            if (bulkEntryState.currentTechIndex >= bulkEntryState.techsToProcess.length) {
                // All done - just show toast, cells already updated
                showUpdateToast('Bulk status applied');
                return;
            }

            const tech = bulkEntryState.techsToProcess[bulkEntryState.currentTechIndex];
            const dayData = tech.schedule[bulkEntryState.dayIndex];
            const hasExistingData = dayData?.status || (dayData?.jobs && dayData.jobs.length > 0);

            if (hasExistingData) {
                // Show conflict modal
                showConflictModal(tech, dayData);
            } else {
                // No conflict, just add
                await addBulkEntryForTech(tech.id);
                bulkEntryState.currentTechIndex++;
                await processNextBulkEntry();
            }
        }

        function showConflictModal(tech, dayData) {
            const overlay = document.createElement('div');
            overlay.id = 'conflictOverlay';
            overlay.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.6);
                backdrop-filter: blur(4px);
                z-index: 210;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--bg-secondary);
                border-radius: 1rem;
                padding: 2rem;
                width: 90%;
                max-width: 400px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            `;

            // Describe existing entry
            let existingDesc = '';
            if (dayData.status) {
                const config = STATUS_CONFIG[dayData.status];
                existingDesc = `<div style="padding: 0.75rem; background: var(--bg-tertiary); border-radius: 0.5rem; margin-bottom: 1rem;">
                    <span style="font-size: 1.25rem;">${config?.icon || 'üìã'}</span>
                    <span style="margin-left: 0.5rem;">${dayData.text || config?.label || dayData.status}</span>
                </div>`;
            } else if (dayData.jobs && dayData.jobs.length > 0) {
                existingDesc = `<div style="padding: 0.75rem; background: var(--bg-tertiary); border-radius: 0.5rem; margin-bottom: 1rem;">
                    <strong>${dayData.jobs.length} job(s):</strong><br>
                    ${dayData.jobs.map(j => `‚Ä¢ ${j.q} - ${j.location}`).join('<br>')}
                </div>`;
            }

            const remaining = bulkEntryState.techsToProcess.length - bulkEntryState.currentTechIndex - 1;

            modal.innerHTML = `
                <h2 style="margin: 0 0 0.25rem 0; font-size: 1.25rem; color: var(--text-primary);">Conflict Found</h2>
                <p style="margin: 0 0 1rem 0; font-size: 0.875rem; color: var(--text-muted);">${tech.name} already has an entry</p>
                
                ${existingDesc}
                
                <p style="font-size: 0.8125rem; color: var(--text-muted); margin-bottom: 1rem;">${remaining} more technician${remaining !== 1 ? 's' : ''} remaining</p>

                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button type="button" onclick="handleConflict('replace')" style="
                        flex: 1;
                        min-width: 100px;
                        padding: 0.625rem 0.75rem;
                        border: 1px solid #f59e0b;
                        background: rgba(245,158,11,0.1);
                        color: #f59e0b;
                        border-radius: 0.5rem;
                        font-size: 0.8125rem;
                        font-weight: 500;
                        cursor: pointer;
                        font-family: inherit;
                    ">Replace</button>
                    <button type="button" onclick="handleConflict('skip')" style="
                        flex: 1;
                        min-width: 100px;
                        padding: 0.625rem 0.75rem;
                        border: 1px solid var(--border-color);
                        background: var(--bg-secondary);
                        color: var(--text-primary);
                        border-radius: 0.5rem;
                        font-size: 0.8125rem;
                        font-weight: 500;
                        cursor: pointer;
                        font-family: inherit;
                    ">Skip</button>
                    <button type="button" onclick="handleConflict('replaceAll')" style="
                        flex: 1;
                        min-width: 100px;
                        padding: 0.625rem 0.75rem;
                        border: none;
                        background: #f59e0b;
                        color: white;
                        border-radius: 0.5rem;
                        font-size: 0.8125rem;
                        font-weight: 600;
                        cursor: pointer;
                        font-family: inherit;
                    ">Replace All</button>
                    <button type="button" onclick="handleConflict('skipAll')" style="
                        flex: 1;
                        min-width: 100px;
                        padding: 0.625rem 0.75rem;
                        border: 1px solid var(--border-color);
                        background: var(--bg-tertiary);
                        color: var(--text-secondary);
                        border-radius: 0.5rem;
                        font-size: 0.8125rem;
                        font-weight: 500;
                        cursor: pointer;
                        font-family: inherit;
                    ">Skip All</button>
                </div>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }

        function closeConflictModal() {
            const overlay = document.getElementById('conflictOverlay');
            if (overlay) overlay.remove();
        }

        async function handleConflict(action) {
            closeConflictModal();
            
            suppressRealtimeEvents(5000); // Ignore realtime for 5 seconds

            const tech = bulkEntryState.techsToProcess[bulkEntryState.currentTechIndex];
            const dayIndex = bulkEntryState.dayIndex;
            const dateStr = bulkEntryState.dateStr;

            if (action === 'replace') {
                await deleteTechDayEntries(tech.id);
                await addBulkEntryForTech(tech.id);
                await reloadTechnicianDay(tech, dayIndex, dateStr);
                updateCell(tech, dayIndex);
                bulkEntryState.currentTechIndex++;
                await processNextBulkEntry();
            } else if (action === 'skip') {
                bulkEntryState.currentTechIndex++;
                await processNextBulkEntry();
            } else if (action === 'replaceAll') {
                // Replace this one and all remaining conflicts
                await deleteTechDayEntries(tech.id);
                await addBulkEntryForTech(tech.id);
                await reloadTechnicianDay(tech, dayIndex, dateStr);
                updateCell(tech, dayIndex);
                bulkEntryState.currentTechIndex++;
                
                // Process remaining with auto-replace
                while (bulkEntryState.currentTechIndex < bulkEntryState.techsToProcess.length) {
                    const t = bulkEntryState.techsToProcess[bulkEntryState.currentTechIndex];
                    await deleteTechDayEntries(t.id);
                    await addBulkEntryForTech(t.id);
                    await reloadTechnicianDay(t, dayIndex, dateStr);
                    updateCell(t, dayIndex);
                    bulkEntryState.currentTechIndex++;
                }
                showUpdateToast('Bulk status applied');
            } else if (action === 'skipAll') {
                // Skip this one and all remaining conflicts
                bulkEntryState.currentTechIndex++;
                
                // Process remaining, skipping any with existing data
                while (bulkEntryState.currentTechIndex < bulkEntryState.techsToProcess.length) {
                    const t = bulkEntryState.techsToProcess[bulkEntryState.currentTechIndex];
                    const dayData = t.schedule[dayIndex];
                    const hasData = dayData?.status || (dayData?.jobs && dayData.jobs.length > 0);
                    
                    if (!hasData) {
                        await addBulkEntryForTech(t.id);
                        await reloadTechnicianDay(t, dayIndex, dateStr);
                        updateCell(t, dayIndex);
                    }
                    bulkEntryState.currentTechIndex++;
                }
                showUpdateToast('Bulk status applied');
            }
        }

        async function deleteTechDayEntries(techId) {
            await supabaseClient
                .from('schedule_entries')
                .delete()
                .eq('technician_id', techId)
                .eq('date', bulkEntryState.dateStr);
        }

        async function addBulkEntryForTech(techId) {
            const entryData = {
                technician_id: techId,
                date: bulkEntryState.dateStr,
                entry_type: 'status',
                status_type: bulkEntryState.statusType,
                status_text: bulkEntryState.statusText || null
            };

            await supabaseClient
                .from('schedule_entries')
                .insert([entryData]);
        }

        // ==================== COPY PREVIOUS ====================

        async function findPreviousDayData(techId, currentDayIndex) {
            const tech = TECHNICIANS.find(t => t.id === techId);
            if (!tech) return null;

            // First check days before in current week (going backwards)
            for (let i = currentDayIndex - 1; i >= 0; i--) {
                const dayData = tech.schedule[i];
                if ((dayData?.jobs?.length > 0) || dayData?.status) {
                    return { dayIndex: i, data: dayData, fromPreviousWeek: false };
                }
            }

            // If nothing found, check previous week from database
            const prevWeekStart = new Date(currentWeekStart);
            prevWeekStart.setDate(prevWeekStart.getDate() - 7);
            const prevWeekEnd = new Date(currentWeekStart);
            prevWeekEnd.setDate(prevWeekEnd.getDate() - 1);

            const { data: prevEntries, error } = await supabaseClient
                .from('schedule_entries')
                .select('*')
                .eq('technician_id', techId)
                .gte('date', toLocalDateString(prevWeekStart))
                .lte('date', toLocalDateString(prevWeekEnd))
                .order('date', { ascending: false });

            if (error || !prevEntries || prevEntries.length === 0) {
                return null;
            }

            // Group by date and return the most recent day's data
            const entriesByDate = {};
            prevEntries.forEach(entry => {
                const dateStr = entry.date.split('T')[0];
                if (!entriesByDate[dateStr]) {
                    entriesByDate[dateStr] = { jobs: [] };
                }
                if (entry.entry_type === 'status') {
                    entriesByDate[dateStr] = { status: entry.status_type, text: entry.status_text };
                } else if (entry.entry_type === 'job') {
                    entriesByDate[dateStr].jobs.push({
                        q: entry.q_number,
                        client: entry.client,
                        location: entry.location,
                        task: entry.task,
                        partner: entry.partner,
                        isNight: entry.is_night || false,
                        jobStatus: entry.job_status || 'live'
                    });
                }
            });

            // Get most recent date with data
            const dates = Object.keys(entriesByDate).sort().reverse();
            if (dates.length > 0) {
                return { dateStr: dates[0], data: entriesByDate[dates[0]], fromPreviousWeek: true };
            }

            return null;
        }

        async function copyPreviousEntry(techId, dayIndex) {
            const previous = await findPreviousDayData(techId, dayIndex);
            if (!previous) {
                alert('No previous entry found to copy');
                return;
            }
            
            suppressRealtimeEvents(3000); // Ignore realtime for 3 seconds

            const date = new Date(currentWeekStart);
            date.setDate(date.getDate() + dayIndex);
            const dateStr = toLocalDateString(date);

            const entriesToInsert = [];

            if (previous.data.status) {
                // Copy status
                entriesToInsert.push({
                    technician_id: techId,
                    date: dateStr,
                    entry_type: 'status',
                    status_type: previous.data.status,
                    status_text: previous.data.text || null
                });
            } else if (previous.data.jobs && previous.data.jobs.length > 0) {
                // Copy ALL jobs from that day
                for (const job of previous.data.jobs) {
                    entriesToInsert.push({
                        technician_id: techId,
                        date: dateStr,
                        entry_type: 'job',
                        q_number: job.q,
                        client: job.client,
                        location: job.location,
                        task: job.task,
                        partner: job.partner || null,
                        is_night: job.isNight || false,
                        job_status: job.jobStatus || 'live',
                        notes: job.notes || null
                    });
                }
            }

            if (entriesToInsert.length === 0) {
                alert('No entries to copy');
                return;
            }

            const tech = TECHNICIANS.find(t => t.id === techId);

            const { error } = await supabaseClient
                .from('schedule_entries')
                .insert(entriesToInsert);

            if (error) {
                alert('Error copying entries: ' + error.message);
                return;
            }

            // Also create partner entries
            const partnerEntries = [];
            for (const entry of entriesToInsert) {
                if (entry.partner && entry.entry_type === 'job') {
                    const partnerTech = TECHNICIANS.find(t => t.name === entry.partner);
                    if (partnerTech) {
                        partnerEntries.push({
                            technician_id: partnerTech.id,
                            date: dateStr,
                            entry_type: 'job',
                            q_number: entry.q_number,
                            client: entry.client,
                            location: entry.location,
                            task: entry.task,
                            partner: tech.name,
                            is_night: entry.is_night,
                            job_status: entry.job_status,
                            notes: entry.notes
                        });
                    }
                }
            }

            if (partnerEntries.length > 0) {
                await supabaseClient
                    .from('schedule_entries')
                    .insert(partnerEntries);
                
                // Update partner cells
                for (const entry of partnerEntries) {
                    const partnerTech = TECHNICIANS.find(t => t.id === entry.technician_id);
                    if (partnerTech) {
                        await reloadTechnicianDay(partnerTech, dayIndex, dateStr);
                        updateCell(partnerTech, dayIndex);
                    }
                }
            }

            // Update main tech cell
            if (tech) {
                await reloadTechnicianDay(tech, dayIndex, dateStr);
                updateCell(tech, dayIndex);
            }

            closePanel();
            showUpdateToast('Entries copied');
        }

        // Check if there's any previous entry (for showing copy button)
        function hasPreviousEntry(techId, currentDayIndex) {
            const tech = TECHNICIANS.find(t => t.id === techId);
            if (!tech) return false;

            // Check days before in current week
            for (let i = currentDayIndex - 1; i >= 0; i--) {
                const dayData = tech.schedule[i];
                if ((dayData?.jobs?.length > 0) || dayData?.status) {
                    return true;
                }
            }
            
            // For now, also show if it's Monday (could have data from last week)
            // The actual check happens async when they click copy
            if (currentDayIndex === 0) {
                return true; // Show button, will check previous week when clicked
            }

            return false;
        }

        // ==================== CSV UPLOAD ====================

        function showCSVModal() {
            if (!currentUser) return;

            const overlay = document.createElement('div');
            overlay.id = 'csvModalOverlay';
            overlay.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.6);
                backdrop-filter: blur(4px);
                z-index: 200;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--bg-secondary);
                border-radius: 1rem;
                padding: 2rem;
                width: 90%;
                max-width: 500px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            `;

            modal.innerHTML = `
                <h2 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; color: var(--text-primary);">CSV Upload</h2>
                <p style="margin: 0 0 1.5rem 0; font-size: 0.875rem; color: var(--text-muted);">Bulk upload technicians or schedule entries</p>
                
                <div style="display: grid; gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="padding: 1.25rem; border: 1px solid var(--border-color); border-radius: 0.75rem; background: var(--bg-tertiary);">
                        <h3 style="margin: 0 0 0.5rem 0; font-size: 1rem; color: var(--text-primary);">üìã Technicians</h3>
                        <p style="margin: 0 0 1rem 0; font-size: 0.8125rem; color: var(--text-muted);">Upload names, roles, postcodes, managers, workstreams</p>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="downloadTechTemplate()" style="
                                flex: 1;
                                padding: 0.5rem;
                                border: 1px solid var(--border-color);
                                background: var(--bg-secondary);
                                color: var(--text-primary);
                                border-radius: 0.5rem;
                                font-size: 0.75rem;
                                cursor: pointer;
                                font-family: inherit;
                            ">‚¨áÔ∏è Template</button>
                            <label style="
                                flex: 1;
                                padding: 0.5rem;
                                border: none;
                                background: var(--brand-gradient);
                                color: white;
                                border-radius: 0.5rem;
                                font-size: 0.75rem;
                                cursor: pointer;
                                font-family: inherit;
                                text-align: center;
                                font-weight: 500;
                            ">
                                ‚¨ÜÔ∏è Upload
                                <input type="file" accept=".csv" onchange="uploadTechCSV(this)" style="display: none;">
                            </label>
                        </div>
                    </div>

                    <div style="padding: 1.25rem; border: 1px solid var(--border-color); border-radius: 0.75rem; background: var(--bg-tertiary);">
                        <h3 style="margin: 0 0 0.5rem 0; font-size: 1rem; color: var(--text-primary);">üìÖ Schedule Entries</h3>
                        <p style="margin: 0 0 1rem 0; font-size: 0.8125rem; color: var(--text-muted);">Upload jobs with dates, locations, tasks, partners</p>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="downloadScheduleTemplate()" style="
                                flex: 1;
                                padding: 0.5rem;
                                border: 1px solid var(--border-color);
                                background: var(--bg-secondary);
                                color: var(--text-primary);
                                border-radius: 0.5rem;
                                font-size: 0.75rem;
                                cursor: pointer;
                                font-family: inherit;
                            ">‚¨áÔ∏è Template</button>
                            <label style="
                                flex: 1;
                                padding: 0.5rem;
                                border: none;
                                background: var(--brand-gradient);
                                color: white;
                                border-radius: 0.5rem;
                                font-size: 0.75rem;
                                cursor: pointer;
                                font-family: inherit;
                                text-align: center;
                                font-weight: 500;
                            ">
                                ‚¨ÜÔ∏è Upload
                                <input type="file" accept=".csv" onchange="uploadScheduleCSV(this)" style="display: none;">
                            </label>
                        </div>
                    </div>
                </div>

                <button onclick="closeCSVModal()" style="
                    width: 100%;
                    padding: 0.625rem 1rem;
                    border: 1px solid var(--border-color);
                    background: var(--bg-secondary);
                    color: var(--text-primary);
                    border-radius: 0.5rem;
                    font-size: 0.875rem;
                    font-weight: 500;
                    cursor: pointer;
                    font-family: inherit;
                ">Close</button>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            setupModalClose(overlay, closeCSVModal);
        }

        function closeCSVModal() {
            const overlay = document.getElementById('csvModalOverlay');
            if (overlay) overlay.remove();
        }

        function downloadTechTemplate() {
            const csv = 'Name,Role,Postcode,Line Manager,Workstream\nJohn Smith,Electrician,SW1A,Jane Doe,Project Delivery\nJane Doe,Operations Manager,E14,,Management/Admin';
            downloadCSV(csv, 'technicians_template.csv');
        }

        function downloadScheduleTemplate() {
            // Get dates for current week in DD/MM/YY format
            const dates = [];
            const isoDateMap = {};
            for (let i = 0; i < 7; i++) {
                const d = new Date(currentWeekStart);
                d.setDate(d.getDate() + i);
                const formatted = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getFullYear()).slice(-2)}`;
                dates.push(formatted);
                isoDateMap[formatted] = d.toISOString().split('T')[0];
            }
            
            const header = 'Field,' + dates.join(',');
            const rows = [
                header,
                'Name,John Smith,John Smith,John Smith,John Smith,John Smith,,',
                'Q Number,Q12345,Q12345,Q12345,Q12345,Q12345,,',
                'Client,Thames Water,Thames Water,Thames Water,Thames Water,Thames Water,,',
                'Location,Beckton STW,Beckton STW,Beckton STW,Beckton STW,Beckton STW,,',
                'Task,Panel Install,Panel Install,Panel Install,Panel Install,Panel Install,,',
                'Partner,,,,,,,',
                'Job Status,live,live,live,live,live,,',
                'Night Work,no,no,no,no,no,,',
                'Name,Jane Doe,Jane Doe,,,,,',
                'Q Number,Q12346,Q12346,,,,,',
                'Client,Southern Water,Southern Water,,,,,',
                'Location,Testwood,Testwood,,,,,',
                'Task,Pump Service,Pump Service,,,,,',
                'Partner,John Smith,John Smith,,,,,',
                'Job Status,pending,pending,,,,,',
                'Night Work,no,no,,,,,'
            ];
            
            const csv = rows.join('\n');
            downloadCSV(csv, 'schedule_template.csv');
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        async function uploadTechCSV(input) {
            const file = input.files[0];
            if (!file) return;

            const text = await file.text();
            const lines = text.trim().split('\n');
            const header = lines[0].toLowerCase();
            
            if (!header.includes('name') || !header.includes('workstream')) {
                alert('Invalid CSV format. Please use the template.');
                return;
            }

            const techs = [];
            for (let i = 1; i < lines.length; i++) {
                const cols = parseCSVLine(lines[i]);
                if (cols.length >= 5 && cols[0].trim()) {
                    techs.push({
                        name: cols[0].trim(),
                        role: cols[1]?.trim() || '',
                        postcode: cols[2]?.trim() || '',
                        line_manager: cols[3]?.trim() || null,
                        workstream: cols[4]?.trim() || 'Project Delivery'
                    });
                }
            }

            if (techs.length === 0) {
                alert('No valid technicians found in CSV');
                return;
            }

            const { error } = await supabaseClient
                .from('technicians')
                .insert(techs);

            if (error) {
                alert('Error uploading technicians: ' + error.message);
                return;
            }

            alert(`Successfully uploaded ${techs.length} technician(s)`);
            closeCSVModal();
            await loadAllData();
        }

        async function uploadScheduleCSV(input) {
            const file = input.files[0];
            if (!file) return;

            const text = await file.text();
            const lines = text.trim().split('\n');
            const headerCols = parseCSVLine(lines[0]);
            
            // First column is "Field", rest are dates
            const dateCols = headerCols.slice(1).map(d => {
                // Parse DD/MM/YY or DD/MM/YYYY format to ISO
                const cleaned = d.trim();
                if (!cleaned) return null;
                
                const parts = cleaned.split('/');
                if (parts.length === 3) {
                    let year = parts[2];
                    if (year.length === 2) year = '20' + year;
                    return `${year}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
                }
                // Try ISO format
                if (cleaned.match(/^\d{4}-\d{2}-\d{2}$/)) return cleaned;
                return null;
            });

            // Get all technicians for name lookup
            const { data: allTechs } = await supabaseClient
                .from('technicians')
                .select('id, name');
            
            const techMap = {};
            allTechs?.forEach(t => techMap[t.name.toLowerCase().trim()] = t.id);

            const entries = [];
            const notFound = new Set();
            
            // Process in groups of 8 rows (one person block)
            let i = 1; // Skip header
            while (i < lines.length) {
                // Read 8 rows for one person
                const block = {};
                const fieldOrder = ['name', 'q_number', 'client', 'location', 'task', 'partner', 'job_status', 'night_work'];
                
                for (let j = 0; j < 8 && (i + j) < lines.length; j++) {
                    const cols = parseCSVLine(lines[i + j]);
                    const fieldName = cols[0]?.toLowerCase().replace(/\s+/g, '_').trim();
                    
                    // Map various field name formats
                    let mappedField = fieldName;
                    if (fieldName === 'qnumber' || fieldName === 'q_number' || fieldName === 'q') mappedField = 'q_number';
                    if (fieldName === 'jobstatus' || fieldName === 'job_status' || fieldName === 'status') mappedField = 'job_status';
                    if (fieldName === 'nightwork' || fieldName === 'night_work' || fieldName === 'night') mappedField = 'night_work';
                    
                    if (fieldOrder.includes(mappedField)) {
                        block[mappedField] = cols.slice(1); // Values for each date
                    }
                }
                
                // Skip if no name found
                if (!block.name || block.name.every(n => !n?.trim())) {
                    i += 8;
                    continue;
                }

                // Process each date column
                for (let col = 0; col < dateCols.length; col++) {
                    const dateStr = dateCols[col];
                    if (!dateStr) continue;
                    
                    const name = block.name?.[col]?.trim();
                    if (!name) continue;
                    
                    const techId = techMap[name.toLowerCase()];
                    if (!techId) {
                        notFound.add(name);
                        continue;
                    }
                    
                    const qNumber = block.q_number?.[col]?.trim();
                    const client = block.client?.[col]?.trim();
                    const location = block.location?.[col]?.trim();
                    const task = block.task?.[col]?.trim();
                    
                    // Skip if no meaningful data for this date
                    if (!qNumber && !location && !task) continue;
                    
                    const partner = block.partner?.[col]?.trim() || null;
                    const jobStatus = block.job_status?.[col]?.trim()?.toLowerCase() || 'live';
                    const isNight = ['yes', 'y', '1', 'true'].includes(block.night_work?.[col]?.trim()?.toLowerCase());
                    
                    entries.push({
                        technician_id: techId,
                        date: dateStr,
                        entry_type: 'job',
                        q_number: qNumber || '',
                        client: client || '',
                        location: location || '',
                        task: task || '',
                        partner: partner,
                        job_status: jobStatus,
                        is_night: isNight
                    });
                }
                
                i += 8;
            }

            if (notFound.size > 0) {
                alert(`Warning: Could not find technicians: ${Array.from(notFound).join(', ')}\n\nMake sure technicians are added first.`);
            }

            if (entries.length === 0) {
                alert('No valid schedule entries found in CSV');
                return;
            }

            const { error } = await supabaseClient
                .from('schedule_entries')
                .insert(entries);

            if (error) {
                alert('Error uploading schedule: ' + error.message);
                return;
            }

            alert(`Successfully uploaded ${entries.length} schedule entry(ies)`);
            closeCSVModal();
            await loadAllData();
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        // Real-time sync
        let realtimeUpdateTimeout = null;
        let pendingUpdates = new Map(); // Map of techId-dateStr -> update info
        let ignoreRealtimeUntil = 0; // Timestamp to ignore realtime events until
        let broadcastChannel = null; // For broadcasting cell updates
        let presenceChannel = null; // For tracking online users

        function setupRealtimeSync() {
            if (!supabaseClient) return;

            // Subscribe to technicians changes
            supabaseClient
                .channel('technicians-changes')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'technicians' },
                    (payload) => {
                        // Ignore if we're in the middle of our own changes
                        if (Date.now() < ignoreRealtimeUntil) {
                            console.log('Ignoring technician realtime event (local change in progress)');
                            return;
                        }
                        console.log('Technicians changed:', payload);
                        handleTechnicianChange(payload);
                    }
                )
                .subscribe();

            // Subscribe to schedule_entries changes
            supabaseClient
                .channel('schedule-changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'schedule_entries' },
                    (payload) => {
                        // Ignore if we're in the middle of our own changes
                        if (Date.now() < ignoreRealtimeUntil) {
                            console.log('Ignoring schedule realtime event (local change in progress)');
                            return;
                        }
                        console.log('Schedule changed:', payload);
                        queueScheduleUpdate(payload);
                    }
                )
                .subscribe();

            // Subscribe to custom broadcast channel for cell refresh notifications
            broadcastChannel = supabaseClient
                .channel('cell-updates')
                .on('broadcast', { event: 'refresh-cells' }, (payload) => {
                    // Ignore if we're in the middle of our own changes
                    if (Date.now() < ignoreRealtimeUntil) {
                        console.log('Ignoring broadcast (local change in progress)');
                        return;
                    }
                    console.log('Received cell refresh broadcast:', payload);
                    handleCellRefreshBroadcast(payload.payload);
                })
                .subscribe();

            // Setup presence tracking for online users
            setupPresenceTracking();
        }

        function setupPresenceTracking() {
            if (!supabaseClient) return;

            const uniqueId = 'user_' + Math.random().toString(36).substr(2, 9);
            
            presenceChannel = supabaseClient.channel('online-users', {
                config: {
                    presence: {
                        key: uniqueId
                    }
                }
            });

            presenceChannel
                .on('presence', { event: 'sync' }, () => {
                    updateOnlineUsersDisplay();
                })
                .on('presence', { event: 'join' }, ({ key, newPresences }) => {
                    console.log('User joined:', key);
                    updateOnlineUsersDisplay();
                })
                .on('presence', { event: 'leave' }, ({ key, leftPresences }) => {
                    console.log('User left:', key);
                    updateOnlineUsersDisplay();
                })
                .subscribe(async (status) => {
                    if (status === 'SUBSCRIBED') {
                        // Track this user
                        await presenceChannel.track({
                            user: currentUser?.email?.split('@')[0] || null,
                            online_at: new Date().toISOString()
                        });
                    }
                });
        }

        function updateOnlineUsersDisplay() {
            if (!presenceChannel) return;

            const presenceState = presenceChannel.presenceState();
            const allUsers = Object.values(presenceState).flat();
            
            const loggedInUsers = allUsers.filter(u => u.user);
            const guests = allUsers.filter(u => !u.user);

            const onlineCountEl = document.getElementById('onlineCount');
            if (!onlineCountEl) return;

            let text = '';
            if (loggedInUsers.length > 0) {
                const names = loggedInUsers.map(u => u.user).slice(0, 3);
                if (loggedInUsers.length <= 3) {
                    text = names.join(', ');
                } else {
                    text = names.join(', ') + ` +${loggedInUsers.length - 3}`;
                }
                if (guests.length > 0) {
                    text += ` ¬∑ +${guests.length} guest${guests.length > 1 ? 's' : ''}`;
                }
            } else {
                text = `${allUsers.length} online`;
                if (guests.length > 0 && allUsers.length > 1) {
                    text = `${guests.length} guest${guests.length > 1 ? 's' : ''}`;
                }
            }

            onlineCountEl.textContent = text || '1 online';
        }

        // Update presence when user logs in/out
        async function updatePresenceUser() {
            if (presenceChannel) {
                await presenceChannel.track({
                    user: currentUser?.email?.split('@')[0] || null,
                    online_at: new Date().toISOString()
                });
            }
        }

        // Broadcast which cells need refreshing (called after deletes)
        async function broadcastCellRefresh(cells) {
            if (!broadcastChannel) return;
            
            console.log('Broadcasting cell refresh:', cells);
            await broadcastChannel.send({
                type: 'broadcast',
                event: 'refresh-cells',
                payload: { cells }
            });
        }

        // Handle incoming broadcast to refresh specific cells
        async function handleCellRefreshBroadcast(data) {
            if (!data?.cells || !Array.isArray(data.cells)) return;
            
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(currentWeekStart);
                d.setDate(d.getDate() + i);
                weekDates.push(toLocalDateString(d));
            }
            
            for (const cell of data.cells) {
                const { techId, dateStr } = cell;
                const tech = TECHNICIANS.find(t => t.id === techId);
                if (!tech) continue;
                
                const dayIndex = weekDates.indexOf(dateStr);
                if (dayIndex < 0 || dayIndex > 6) continue;
                
                await reloadTechnicianDay(tech, dayIndex, dateStr);
                updateCell(tech, dayIndex);
            }
            
            if (data.cells.length > 0) {
                showUpdateToast('Schedule updated');
            }
        }

        // Call this before making changes to suppress realtime events
        function suppressRealtimeEvents(durationMs = 2000) {
            ignoreRealtimeUntil = Date.now() + durationMs;
        }

        function queueScheduleUpdate(payload) {
            const { eventType, new: newRecord, old: oldRecord } = payload;
            
            console.log('queueScheduleUpdate:', eventType, 'new:', newRecord, 'old:', oldRecord);
            
            // Get the affected technician(s) and date
            // For INSERT/UPDATE we have newRecord, for DELETE we need oldRecord
            const techId = newRecord?.technician_id || oldRecord?.technician_id;
            const dateStr = (newRecord?.date || oldRecord?.date)?.split('T')[0];
            
            // Track partner from the new record
            const partnerName = newRecord?.partner;
            
            console.log('Parsed - techId:', techId, 'dateStr:', dateStr, 'partner:', partnerName);
            
            // If we can't identify the change (DELETE without REPLICA IDENTITY FULL), 
            // just skip it - the subsequent INSERT events will have full data
            if (!techId || !dateStr) {
                console.log('Cannot identify cell for', eventType, '- skipping (waiting for INSERT events with full data)');
                return;
            }
            
            // Queue this specific cell update
            const key = `${techId}-${dateStr}`;
            pendingUpdates.set(key, { techId, dateStr, eventType });
            
            // If there's a partner involved, also queue their update
            if (partnerName) {
                const partnerTech = TECHNICIANS.find(t => t.name === partnerName);
                if (partnerTech) {
                    const partnerKey = `${partnerTech.id}-${dateStr}`;
                    pendingUpdates.set(partnerKey, { techId: partnerTech.id, dateStr, eventType: 'PARTNER_UPDATE' });
                }
            }
            
            // For INSERT events, also check if this tech had a DIFFERENT partner before
            // and queue that old partner for refresh too (handles partner changes)
            if (eventType === 'INSERT' && dateStr) {
                const tech = TECHNICIANS.find(t => t.id === techId);
                if (tech) {
                    // Find which day index this is
                    const weekDates = [];
                    for (let i = 0; i < 7; i++) {
                        const d = new Date(currentWeekStart);
                        d.setDate(d.getDate() + i);
                        weekDates.push(toLocalDateString(d));
                    }
                    const dayIndex = weekDates.indexOf(dateStr);
                    
                    if (dayIndex >= 0 && dayIndex < 7) {
                        // Check current local data for any existing partners on this day
                        const currentJobs = tech.schedule[dayIndex]?.jobs || [];
                        for (const job of currentJobs) {
                            if (job.partner && job.partner !== partnerName) {
                                // This is an OLD partner that needs refreshing
                                const oldPartnerTech = TECHNICIANS.find(t => t.name === job.partner);
                                if (oldPartnerTech) {
                                    console.log('Queueing old partner refresh:', job.partner);
                                    const oldPartnerKey = `${oldPartnerTech.id}-${dateStr}`;
                                    pendingUpdates.set(oldPartnerKey, { techId: oldPartnerTech.id, dateStr, eventType: 'OLD_PARTNER_UPDATE' });
                                }
                            }
                        }
                    }
                }
            }
            
            // Debounce - wait 300ms for more updates before processing
            if (realtimeUpdateTimeout) {
                clearTimeout(realtimeUpdateTimeout);
            }
            realtimeUpdateTimeout = setTimeout(() => {
                processQueuedUpdates();
            }, 300);
        }

        async function processQueuedUpdates() {
            const updates = Array.from(pendingUpdates.values());
            pendingUpdates.clear();
            
            if (updates.length === 0) return;
            
            // Calculate week dates once
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(currentWeekStart);
                d.setDate(d.getDate() + i);
                weekDates.push(toLocalDateString(d));
            }
            
            let updatedCount = 0;
            
            for (const update of updates) {
                const { techId, dateStr, eventType } = update;
                
                const tech = TECHNICIANS.find(t => t.id === techId);
                if (!tech) continue;
                
                const dayIndex = weekDates.indexOf(dateStr);
                if (dayIndex < 0 || dayIndex > 6) continue;
                
                await reloadTechnicianDay(tech, dayIndex, dateStr);
                updateCell(tech, dayIndex);
                updatedCount++;
            }
            
            if (updatedCount > 0) {
                const message = updates.length === 1 
                    ? (updates[0].eventType === 'DELETE' ? 'Entry removed' : 
                       updates[0].eventType === 'INSERT' ? 'New entry added' : 'Entry updated')
                    : `${updatedCount} cell${updatedCount > 1 ? 's' : ''} updated`;
                showUpdateToast(message);
            }
        }

        function handleTechnicianChange(payload) {
            const { eventType, new: newRecord, old: oldRecord } = payload;
            
            if (eventType === 'INSERT') {
                // Add new technician to the list
                const newTech = {
                    id: newRecord.id,
                    name: newRecord.name,
                    role: newRecord.role,
                    postcode: newRecord.postcode,
                    workstream: newRecord.workstream,
                    lineManager: newRecord.line_manager,
                    schedule: {}
                };
                for (let i = 0; i < 7; i++) {
                    newTech.schedule[i] = { jobs: [] };
                }
                TECHNICIANS.push(newTech);
                renderSchedule();
                showUpdateToast('New technician added');
            } else if (eventType === 'UPDATE') {
                // Update existing technician
                const tech = TECHNICIANS.find(t => t.id === newRecord.id);
                if (tech) {
                    tech.name = newRecord.name;
                    tech.role = newRecord.role;
                    tech.postcode = newRecord.postcode;
                    tech.workstream = newRecord.workstream;
                    tech.lineManager = newRecord.line_manager;
                    renderSchedule();
                    showUpdateToast('Technician updated');
                }
            } else if (eventType === 'DELETE') {
                // Remove technician
                const index = TECHNICIANS.findIndex(t => t.id === oldRecord.id);
                if (index !== -1) {
                    TECHNICIANS.splice(index, 1);
                    renderSchedule();
                    showUpdateToast('Technician removed');
                }
            }
        }

        async function reloadTechnicianDay(tech, dayIndex, dateStr) {
            // Fetch all entries for this technician on this date
            const { data: entries, error } = await supabaseClient
                .from('schedule_entries')
                .select('*')
                .eq('technician_id', tech.id)
                .eq('date', dateStr);
            
            if (error) {
                console.error('Error reloading day:', error);
                return;
            }
            
            // Reset the day
            tech.schedule[dayIndex] = { jobs: [] };
            
            // Rebuild the day's data
            entries?.forEach(entry => {
                if (entry.entry_type === 'status') {
                    tech.schedule[dayIndex] = { 
                        status: entry.status_type, 
                        text: entry.status_text 
                    };
                } else if (entry.entry_type === 'job') {
                    if (!tech.schedule[dayIndex].jobs) {
                        tech.schedule[dayIndex] = { jobs: [] };
                    }
                    tech.schedule[dayIndex].jobs.push({
                        entryId: entry.id,
                        q: entry.q_number,
                        client: entry.client,
                        location: entry.location,
                        task: entry.task,
                        partner: entry.partner,
                        isNight: entry.is_night || false,
                        jobStatus: entry.job_status || 'live',
                        notes: entry.notes || ''
                    });
                }
            });
        }

        function updateCell(tech, dayIndex) {
            // Find the specific cell in the DOM and update just that cell
            const rows = document.querySelectorAll('.person-row');
            
            for (const row of rows) {
                const nameEl = row.querySelector('.person-name');
                if (nameEl && nameEl.textContent === tech.name) {
                    // Found the row - now find the right day cell
                    const dayCells = row.querySelectorAll('.day-cell');
                    const cell = dayCells[dayIndex];
                    
                    if (cell) {
                        // Update just this cell's content with a highlight animation
                        cell.innerHTML = renderDayCell(tech.schedule[dayIndex], tech, dayIndex);
                        cell.classList.add('cell-updated');
                        setTimeout(() => cell.classList.remove('cell-updated'), 1500);
                    }
                    break;
                }
            }
        }

        function showUpdateToast(message = 'Schedule updated') {
            // Remove existing toast if any
            const existingToast = document.getElementById('updateToast');
            if (existingToast) existingToast.remove();

            // Create toast
            const toast = document.createElement('div');
            toast.id = 'updateToast';
            toast.innerHTML = `üîÑ ${message}`;
            toast.style.cssText = `
                position: fixed;
                bottom: 2rem;
                right: 2rem;
                background: var(--brand-primary);
                color: white;
                padding: 0.75rem 1.25rem;
                border-radius: 0.5rem;
                font-size: 0.875rem;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(toast);

            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // State - start on current week
        const today = new Date();
        const dayOfWeek = today.getDay();
        let currentWeekStart = new Date(today);
        currentWeekStart.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
        currentWeekStart.setHours(0, 0, 0, 0);
        
        let showWeekends = true;
        let darkMode = false;

        // Dark mode toggle
        function toggleDarkMode() {
            darkMode = !darkMode;
            document.documentElement.setAttribute('data-theme', darkMode ? 'dark' : 'light');
            document.getElementById('toggleDarkMode').classList.toggle('active', darkMode);
            
            // Update icon
            const icon = document.getElementById('darkModeIcon');
            if (darkMode) {
                icon.innerHTML = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
            } else {
                icon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
            }
            
            // Save preference
            localStorage.setItem('darkMode', darkMode);
        }

        // Check for saved dark mode preference
        function initDarkMode() {
            const saved = localStorage.getItem('darkMode');
            if (saved === 'true') {
                toggleDarkMode();
            }
        }

        // Helpers
        function formatDate(date) {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return {
                dayName: days[date.getDay()],
                dayNum: date.getDate(),
                month: months[date.getMonth()],
                full: `${days[date.getDay()]}, ${date.getDate()} ${months[date.getMonth()]}`
            };
        }

        // Convert date to YYYY-MM-DD string in local timezone (avoids DST issues)
        function toLocalDateString(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function getWeekNumber(date) {
            const firstDay = new Date(date.getFullYear(), 0, 1);
            const pastDays = (date - firstDay) / 86400000;
            return Math.ceil((pastDays + firstDay.getDay() + 1) / 7);
        }

        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        // Navigation
        function changeWeek(delta) {
            currentWeekStart.setDate(currentWeekStart.getDate() + (delta * 7));
            loadAllData();
        }

        function goToToday() {
            const today = new Date();
            const day = today.getDay();
            currentWeekStart = new Date(today);
            currentWeekStart.setDate(today.getDate() - (day === 0 ? 6 : day - 1));
            loadAllData();
        }

        function toggleWeekends() {
            showWeekends = !showWeekends;
            document.getElementById('toggleWeekends').classList.toggle('active', showWeekends);
            renderSchedule();
        }

        // Render job cells with smart layout
        function renderDayCell(dayData, tech, dayIndex) {
            if (!dayData) return '';

            // Status entry
            if (dayData.status) {
                const config = STATUS_CONFIG[dayData.status];
                const workClass = config.isWork ? 'work' : 'non-work';
                return `
                    <div class="status-entry ${workClass} status-${dayData.status}" onclick="openPanel('${tech.id}', ${dayIndex})">
                        <span class="status-icon">${config.icon}</span>
                        <span>${dayData.text || config.label}</span>
                    </div>
                `;
            }

            // Jobs
            const jobs = dayData.jobs || [];
            if (jobs.length === 0) return '';

            // Job status colors
            const getJobStatusColor = (status) => {
                switch(status) {
                    case 'inactive': return '#ef4444';
                    case 'pending': return '#f59e0b';
                    case 'live': 
                    default: return '#22c55e';
                }
            };

            // Draggable attributes for logged in users
            const getDragAttrs = (jobIndex) => {
                if (!currentUser) return '';
                return `draggable="true" ondragstart="handleJobDragStart(event, '${tech.id}', ${dayIndex}, ${jobIndex})" ondragend="handleJobDragEnd(event)"`;
            };

            // 1-2 jobs: Full display
            if (jobs.length <= 2) {
                return jobs.map((job, jobIndex) => {
                    const statusColor = getJobStatusColor(job.jobStatus);
                    const nightBg = job.isNight ? 'background: #312e81;' : '';
                    const borderColor = job.isNight ? '#6366f1' : statusColor;
                    return `
                    <div class="job-entry full ${job.isNight ? 'night-job' : ''}" ${getDragAttrs(jobIndex)} onclick="openPanel('${tech.id}', ${dayIndex})" style="${nightBg} border-left-color: ${borderColor}; ${currentUser ? 'cursor: grab;' : ''}">
                        <div class="job-q" style="${job.isNight ? 'color: #a5b4fc;' : ''}">${job.isNight ? 'üåô ' : ''}<span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: ${statusColor}; margin-right: 4px;"></span>${job.q}</div>
                        <div class="job-location" style="${job.isNight ? 'color: #c7d2fe;' : ''}">${job.location}</div>
                        <div class="job-task" style="${job.isNight ? 'color: #a5b4fc;' : ''}">${job.task}</div>
                        ${job.partner ? `<div class="job-partner" style="${job.isNight ? 'color: #818cf8;' : ''}">${job.partner}</div>` : ''}
                    </div>
                `}).join('');
            }

            // 3-4 jobs: Compact display
            if (jobs.length <= 4) {
                return jobs.map((job, jobIndex) => {
                    const statusColor = getJobStatusColor(job.jobStatus);
                    const nightBg = job.isNight ? 'background: #312e81;' : '';
                    const borderColor = job.isNight ? '#6366f1' : statusColor;
                    return `
                    <div class="job-entry compact ${job.isNight ? 'night-job' : ''}" ${getDragAttrs(jobIndex)} onclick="openPanel('${tech.id}', ${dayIndex})" style="${nightBg} border-left-color: ${borderColor}; ${currentUser ? 'cursor: grab;' : ''}">
                        <div class="job-line">
                            <span class="job-q" style="${job.isNight ? 'color: #a5b4fc;' : ''}">${job.isNight ? 'üåô ' : ''}<span style="display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: ${statusColor}; margin-right: 3px;"></span>${job.q}</span>
                            <span class="job-location" style="${job.isNight ? 'color: #c7d2fe;' : ''}">${job.location}</span>
                        </div>
                        <div class="job-task" style="${job.isNight ? 'color: #a5b4fc;' : ''}">${job.task}</div>
                    </div>
                `}).join('');
            }

            // 5+ jobs: Chip display (not draggable individually - open panel to manage)
            const visibleJobs = jobs.slice(0, 5);
            const overflow = jobs.length - 5;
            return `
                <div class="jobs-minimal" onclick="openPanel('${tech.id}', ${dayIndex})">
                    ${visibleJobs.map(job => {
                        const statusColor = getJobStatusColor(job.jobStatus);
                        return `
                        <div class="job-chip" style="${job.isNight ? 'background: #312e81; color: #a5b4fc;' : ''} border-left: 3px solid ${statusColor};">${job.isNight ? 'üåô' : ''}${job.q}</div>
                    `}).join('')}
                    ${overflow > 0 ? `<div class="job-chip jobs-overflow">+${overflow}</div>` : ''}
                </div>
            `;
        }

        // Main render
        function renderSchedule() {
            const grid = document.getElementById('scheduleGrid');
            const workstreamFilter = document.getElementById('workstreamFilter').value;
            const clientFilter = document.getElementById('clientFilter').value;
            const search = document.getElementById('searchInput').value.toLowerCase();

            // Update week display
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('weekDisplay').textContent = `Week ${getWeekNumber(currentWeekStart)} ¬∑ ${months[currentWeekStart.getMonth()]} ${currentWeekStart.getFullYear()}`;

            // Grid columns
            const numDays = showWeekends ? 7 : 5;
            grid.className = `schedule-grid${showWeekends ? ' show-weekends' : ''}`;

            // Build header
            let html = '<div class="grid-header">';
            html += '<div class="grid-header-cell">Technician</div>';

            for (let i = 0; i < numDays; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + i);
                const f = formatDate(date);
                const todayClass = isToday(date) ? ' today' : '';
                const weekendClass = (i >= 5) ? ' weekend' : '';
                const clickHandler = currentUser ? `onclick="showBulkEntryModal(${i})"` : '';
                const cursorStyle = currentUser ? 'cursor: pointer;' : '';
                html += `
                    <div class="grid-header-cell${todayClass}${weekendClass}" ${clickHandler} style="${cursorStyle}" title="${currentUser ? 'Click to add bulk status' : ''}">
                        <div class="day-name">${f.dayName}</div>
                        <div class="day-date">${f.dayNum}</div>
                        <div class="day-month">${f.month}</div>
                    </div>
                `;
            }
            html += '</div>';

            // Filter technicians
            let techs = TECHNICIANS.filter(t => {
                // Filter by first_day - don't show tech if their first day is in a future week
                if (t.first_day) {
                    const firstDayDate = new Date(t.first_day);
                    const weekEnd = new Date(currentWeekStart);
                    weekEnd.setDate(weekEnd.getDate() + 6);
                    
                    // If first day is after this week ends, don't show
                    if (firstDayDate > weekEnd) return false;
                }
                
                // Filter by end_date - don't show tech if their end date is before this week starts
                if (t.end_date) {
                    const endDate = new Date(t.end_date);
                    const weekStart = new Date(currentWeekStart);
                    
                    // If end date is before this week starts, don't show
                    if (endDate < weekStart) return false;
                }
                
                if (workstreamFilter !== 'all' && t.workstream !== workstreamFilter) return false;
                
                // Enhanced search - check name, role, and all jobs
                if (search) {
                    const nameMatch = t.name.toLowerCase().includes(search);
                    const roleMatch = t.role?.toLowerCase().includes(search);
                    const postcodeMatch = t.postcode?.toLowerCase().includes(search);
                    
                    // Search in all jobs
                    let jobMatch = false;
                    for (let day in t.schedule) {
                        const jobs = t.schedule[day]?.jobs || [];
                        for (const job of jobs) {
                            if (job.q?.toLowerCase().includes(search) ||
                                job.location?.toLowerCase().includes(search) ||
                                job.task?.toLowerCase().includes(search) ||
                                job.client?.toLowerCase().includes(search) ||
                                job.partner?.toLowerCase().includes(search)) {
                                jobMatch = true;
                                break;
                            }
                        }
                        if (jobMatch) break;
                    }
                    
                    if (!nameMatch && !roleMatch && !postcodeMatch && !jobMatch) return false;
                }
                
                if (clientFilter !== 'all') {
                    let hasClient = false;
                    for (let day in t.schedule) {
                        const jobs = t.schedule[day]?.jobs || [];
                        if (jobs.some(j => j.client === clientFilter)) hasClient = true;
                    }
                    if (!hasClient) return false;
                }
                return true;
            });

            // Group by workstream
            const workstreams = WORKSTREAMS.map(ws => ws.name);
            const grouped = {};
            workstreams.forEach(ws => grouped[ws] = []);
            techs.forEach(t => {
                if (grouped[t.workstream]) grouped[t.workstream].push(t);
            });

            // Sort each workstream group by sort_order (from Manage Team), fallback to role hierarchy
            workstreams.forEach(ws => {
                grouped[ws].sort((a, b) => {
                    // Use sort_order if available
                    const orderA = a.sort_order ?? 999;
                    const orderB = b.sort_order ?? 999;
                    if (orderA !== orderB) return orderA - orderB;
                    // Fallback to role hierarchy
                    const rankA = getRoleRank(a.role);
                    const rankB = getRoleRank(b.role);
                    if (rankA !== rankB) return rankA - rankB;
                    // Same role rank, sort by name A-Z
                    return a.name.localeCompare(b.name);
                });
            });

            // Render rows
            let hasData = false;
            workstreams.forEach(ws => {
                if (grouped[ws].length === 0) return;
                if (workstreamFilter !== 'all' && workstreamFilter !== ws) return;

                hasData = true;
                html += `<div class="workstream-divider"><div class="workstream-header">${ws}</div></div>`;

                grouped[ws].forEach(tech => {
                    html += `<div class="person-row">`;
                    html += `
                        <div class="person-cell" onclick="openPanel('${tech.id}')">
                            <div class="person-name">${tech.name}</div>
                            <div class="person-role">${tech.role}</div>
                            <div class="person-meta">
                                <span class="person-tag">${tech.postcode}</span>
                            </div>
                        </div>
                    `;

                    for (let i = 0; i < numDays; i++) {
                        const weekendClass = (i >= 5) ? ' weekend' : '';
                        html += `<div class="day-cell${weekendClass}" data-tech-id="${tech.id}" data-day-index="${i}" onclick="openPanel('${tech.id}', ${i})" ondragover="handleJobDragOver(event)" ondragleave="handleJobDragLeave(event)" ondrop="handleJobDrop(event, '${tech.id}', ${i})">${renderDayCell(tech.schedule[i], tech, i)}</div>`;
                    }

                    html += '</div>';
                });
            });

            grid.innerHTML = html;

            // Show empty state if no data
            if (!hasData && !isLoading) {
                grid.innerHTML += `
                    <div style="grid-column: 1 / -1; padding: 3rem; text-align: center; color: var(--text-muted);">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìã</div>
                        <div style="font-size: 1rem; font-weight: 600; margin-bottom: 0.25rem;">No technicians found</div>
                        <div style="font-size: 0.875rem;">Add technicians in Supabase to get started</div>
                    </div>
                `;
            }
        }

        // Panel
        function openPanel(techId, dayIndex = null) {
            const tech = TECHNICIANS.find(t => t.id === techId);
            if (!tech) return;

            const panel = document.getElementById('sidePanel');
            const overlay = document.getElementById('panelOverlay');
            const title = document.getElementById('panelTitle');
            const subtitle = document.getElementById('panelSubtitle');
            const body = document.getElementById('panelBody');
            const footer = document.getElementById('panelFooter');

            title.textContent = tech.name;

            if (dayIndex !== null) {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + dayIndex);
                subtitle.textContent = formatDate(date).full;

                const dayData = tech.schedule[dayIndex];
                const hasData = dayData?.status || (dayData?.jobs && dayData.jobs.length > 0);

                if (dayData?.status) {
                    const config = STATUS_CONFIG[dayData.status];
                    body.innerHTML = `
                        <div class="panel-section">
                            <div class="panel-section-title">Status</div>
                            <div class="status-entry ${config.isWork ? 'work' : 'non-work'} status-${dayData.status}" style="margin: 0;">
                                <span class="status-icon">${config.icon}</span>
                                <span>${dayData.text || config.label}</span>
                            </div>
                        </div>
                        <div class="panel-section">
                            <div class="panel-section-title">Technician</div>
                            <div class="panel-field">
                                <div class="panel-label">Role</div>
                                <div class="panel-value">${tech.role}</div>
                            </div>
                            <div class="panel-field">
                                <div class="panel-label">Workstream</div>
                                <div class="panel-value">${tech.workstream}</div>
                            </div>
                            <div class="panel-field">
                                <div class="panel-label">Line Manager</div>
                                <div class="panel-value">${tech.lineManager || '‚Äî'}</div>
                            </div>
                        </div>
                    `;
                } else if (dayData?.jobs && dayData.jobs.length > 0) {
                    const getJobColor = (job) => {
                        if (job.isNight) {
                            // Night jobs - use indigo background but show status color for the badge
                            const statusColor = job.jobStatus === 'inactive' ? '#ef4444' : job.jobStatus === 'pending' ? '#f59e0b' : '#22c55e';
                            return { bg: '#312e81', border: '#6366f1', text: '#c7d2fe', statusColor: statusColor };
                        }
                        switch(job.jobStatus) {
                            case 'inactive': return { bg: 'rgba(239,68,68,0.1)', border: '#ef4444', text: 'var(--text-primary)', statusColor: '#ef4444' };
                            case 'pending': return { bg: 'rgba(245,158,11,0.1)', border: '#f59e0b', text: 'var(--text-primary)', statusColor: '#f59e0b' };
                            case 'live':
                            default: return { bg: 'rgba(34,197,94,0.1)', border: '#22c55e', text: 'var(--text-primary)', statusColor: '#22c55e' };
                        }
                    };
                    body.innerHTML = `
                        <div class="panel-section">
                            <div class="panel-section-title">Jobs (${dayData.jobs.length})</div>
                            <div class="panel-jobs-list">
                                ${dayData.jobs.map((job, jobIndex) => {
                                    const colors = getJobColor(job);
                                    const statusText = job.jobStatus === 'inactive' ? 'Inactive' : job.jobStatus === 'pending' ? 'Pending' : 'Live';
                                    const statusLabel = job.isNight ? `üåô Night ¬∑ ${statusText}` : statusText;
                                    const editBtns = currentUser ? `
                                        <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid ${job.isNight ? 'rgba(165,180,252,0.2)' : 'var(--border-color)'};">
                                            <button onclick="editSingleJob('${tech.id}', ${dayIndex}, ${jobIndex})" style="
                                                flex: 1;
                                                padding: 0.375rem 0.5rem;
                                                border: 1px solid ${job.isNight ? '#818cf8' : 'var(--border-color)'};
                                                background: ${job.isNight ? 'rgba(129,140,248,0.1)' : 'var(--bg-secondary)'};
                                                color: ${job.isNight ? '#c7d2fe' : 'var(--text-primary)'};
                                                border-radius: 0.375rem;
                                                font-size: 0.75rem;
                                                font-weight: 500;
                                                cursor: pointer;
                                                font-family: inherit;
                                            ">‚úèÔ∏è Edit</button>
                                            <button onclick="deleteSingleJob('${tech.id}', ${dayIndex}, ${jobIndex})" style="
                                                flex: 1;
                                                padding: 0.375rem 0.5rem;
                                                border: 1px solid #f43f5e;
                                                background: rgba(244, 63, 94, 0.1);
                                                color: #f43f5e;
                                                border-radius: 0.375rem;
                                                font-size: 0.75rem;
                                                font-weight: 500;
                                                cursor: pointer;
                                                font-family: inherit;
                                            ">üóëÔ∏è Delete</button>
                                        </div>
                                    ` : '';
                                    return `
                                    <div class="panel-job-card" style="background: ${colors.bg}; border-left: 3px solid ${colors.border};">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div class="panel-job-q" style="color: ${job.isNight ? '#a5b4fc' : 'var(--brand-primary)'};">${job.isNight ? 'üåô ' : ''}${job.q}</div>
                                            <span style="font-size: 0.625rem; padding: 0.125rem 0.5rem; border-radius: 1rem; background: ${colors.statusColor}; color: white; font-weight: 600;">${statusLabel}</span>
                                        </div>
                                        <div class="panel-job-client" style="color: ${colors.text};">${job.client}</div>
                                        <div class="panel-job-details">
                                            <div class="panel-job-detail">
                                                <div class="panel-job-detail-label" style="${job.isNight ? 'color: #a5b4fc;' : ''}">Location</div>
                                                <div class="panel-job-detail-value" style="color: ${colors.text};">${job.location}</div>
                                            </div>
                                            <div class="panel-job-detail">
                                                <div class="panel-job-detail-label" style="${job.isNight ? 'color: #a5b4fc;' : ''}">Task</div>
                                                <div class="panel-job-detail-value" style="color: ${colors.text};">${job.task}</div>
                                            </div>
                                            ${job.partner ? `
                                            <div class="panel-job-detail" style="grid-column: span 2;">
                                                <div class="panel-job-detail-label" style="${job.isNight ? 'color: #a5b4fc;' : ''}">Working With</div>
                                                <div class="panel-job-detail-value" style="color: ${colors.text};">${job.partner}</div>
                                            </div>
                                            ` : ''}
                                            ${job.notes ? `
                                            <div class="panel-job-detail" style="grid-column: span 2;">
                                                <div class="panel-job-detail-label" style="${job.isNight ? 'color: #a5b4fc;' : ''}">Notes</div>
                                                <div class="panel-job-detail-value" style="color: ${colors.text}; font-style: italic;">${job.notes}</div>
                                            </div>
                                            ` : ''}
                                        </div>
                                        ${editBtns}
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                        <div class="panel-section">
                            <div class="panel-section-title">Technician</div>
                            <div class="panel-field">
                                <div class="panel-label">Base Postcode</div>
                                <div class="panel-value">${tech.postcode}</div>
                            </div>
                            <div class="panel-field">
                                <div class="panel-label">Line Manager</div>
                                <div class="panel-value">${tech.lineManager || '‚Äî'}</div>
                            </div>
                        </div>
                    `;
                } else {
                    body.innerHTML = `
                        <div class="panel-section">
                            <div class="panel-section-title">No Schedule</div>
                            <p style="color: var(--text-muted); font-size: 0.875rem;">No jobs or status assigned for this day.</p>
                        </div>
                    `;
                }

                // Footer with edit buttons
                if (currentUser) {
                    // Check if there's previous entry for this tech
                    const showCopyBtn = hasPreviousEntry(tech.id, dayIndex);
                    const copyPrevBtn = showCopyBtn ? `<button class="panel-btn panel-btn-secondary" onclick="copyPreviousEntry('${tech.id}', ${dayIndex})" title="Copy previous day's entries">üìã Copy</button>` : '';
                    
                    if (hasData) {
                        footer.innerHTML = `
                            <button class="panel-btn panel-btn-secondary" onclick="showAddEntryModal('${tech.id}', ${dayIndex})">+ Add</button>
                            <button class="panel-btn panel-btn-danger" onclick="clearDayEntries('${tech.id}', ${dayIndex})">üóëÔ∏è Clear Day</button>
                            ${copyPrevBtn}
                            <button class="panel-btn panel-btn-primary" onclick="showEditTechnicianModal('${tech.id}')">Tech</button>
                        `;
                    } else {
                        footer.innerHTML = `
                            <button class="panel-btn panel-btn-secondary" onclick="showAddEntryModal('${tech.id}', ${dayIndex})">Add Entry</button>
                            ${copyPrevBtn}
                            <button class="panel-btn panel-btn-primary" onclick="showEditTechnicianModal('${tech.id}')">Tech</button>
                        `;
                    }
                } else {
                    footer.innerHTML = `
                        <button class="panel-btn panel-btn-secondary" onclick="showLoginModal()">Sign in to edit</button>
                    `;
                }
            } else {
                subtitle.textContent = tech.role;
                body.innerHTML = `
                    <div class="panel-section">
                        <div class="panel-section-title">Details</div>
                        <div class="panel-field">
                            <div class="panel-label">Workstream</div>
                            <div class="panel-value">${tech.workstream}</div>
                        </div>
                        <div class="panel-field">
                            <div class="panel-label">Base Postcode</div>
                            <div class="panel-value">${tech.postcode}</div>
                        </div>
                        <div class="panel-field">
                            <div class="panel-label">Line Manager</div>
                            <div class="panel-value">${tech.lineManager || '‚Äî'}</div>
                        </div>
                    </div>
                    ${tech.notes ? `
                    <div class="panel-section">
                        <div class="panel-section-title">Notes</div>
                        <div style="font-size: 0.8125rem; color: var(--text-secondary); white-space: pre-wrap; line-height: 1.5;">${tech.notes}</div>
                    </div>
                    ` : ''}
                `;

                // Footer for technician view
                if (currentUser) {
                    footer.innerHTML = `
                        <button class="panel-btn panel-btn-secondary" onclick="showTechHistoryModal('${tech.id}')">üìã History</button>
                        <button class="panel-btn panel-btn-primary" onclick="showEditTechnicianModal('${tech.id}')">Edit Technician</button>
                    `;
                } else {
                    footer.innerHTML = `
                        <button class="panel-btn panel-btn-secondary" onclick="showLoginModal()">Sign in to edit</button>
                    `;
                }
            }

            panel.classList.add('open');
            overlay.classList.add('open');
        }

        function closePanel() {
            document.getElementById('sidePanel').classList.remove('open');
            document.getElementById('panelOverlay').classList.remove('open');
        }

        // ==================== AUDIT HISTORY MODAL ====================

        async function showTechHistoryModal(techId) {
            const tech = TECHNICIANS.find(t => t.id === techId);
            if (!tech) return;

            const overlay = document.createElement('div');
            overlay.id = 'historyOverlay';
            overlay.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.6);
                backdrop-filter: blur(4px);
                z-index: 200;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 1rem;
            `;

            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--bg-secondary);
                border-radius: 1rem;
                width: 100%;
                max-width: 500px;
                max-height: 80vh;
                display: flex;
                flex-direction: column;
                box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            `;

            modal.innerHTML = `
                <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 style="margin: 0; font-size: 1.25rem; color: var(--text-primary);">üìã Job History</h2>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.8125rem; color: var(--text-muted);">${tech.name} ¬∑ Last 3 months</p>
                    </div>
                    <button onclick="closeHistoryModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); padding: 0.5rem;">&times;</button>
                </div>
                <div id="historyContent" style="padding: 1.5rem; overflow-y: auto; flex: 1;">
                    <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚è≥</div>
                        <div>Loading history...</div>
                    </div>
                </div>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            setupModalClose(overlay, closeHistoryModal);

            // Fetch audit log for this technician
            try {
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

                const { data: logs, error } = await supabaseClient
                    .from('audit_log')
                    .select('*')
                    .eq('technician_id', techId)
                    .gte('created_at', threeMonthsAgo.toISOString())
                    .order('created_at', { ascending: false });

                const content = document.getElementById('historyContent');

                if (error) {
                    content.innerHTML = `<div style="color: #ef4444; padding: 1rem;">Error loading history: ${error.message}</div>`;
                    return;
                }

                if (!logs || logs.length === 0) {
                    content.innerHTML = `
                        <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ú®</div>
                            <div>No deleted or moved jobs in the last 3 months</div>
                        </div>
                    `;
                    return;
                }

                content.innerHTML = logs.map(log => {
                    const date = new Date(log.created_at);
                    const formattedDate = date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
                    const formattedTime = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                    const jobDate = log.date ? new Date(log.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : '';
                    const details = log.job_details || {};

                    if (log.action === 'job_deleted') {
                        return `
                            <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 0.5rem; margin-bottom: 0.75rem; border-left: 3px solid ${log.was_canceled ? '#f59e0b' : '#ef4444'};">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.75rem; font-weight: 600; color: ${log.was_canceled ? '#f59e0b' : '#ef4444'};">
                                        ${log.was_canceled ? '‚ö†Ô∏è Job Canceled' : 'üóëÔ∏è Job Deleted'}
                                    </span>
                                    <span style="font-size: 0.6875rem; color: var(--text-muted);">${formattedDate} ${formattedTime}</span>
                                </div>
                                <div style="font-size: 0.8125rem; color: var(--text-primary); font-weight: 500;">${details.q_number || 'No Q'} ¬∑ ${jobDate}</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">${details.client || ''} ¬∑ ${details.location || ''}</div>
                                ${log.notes ? `<div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border-color);"><em>"${log.notes}"</em></div>` : ''}
                                <div style="font-size: 0.6875rem; color: var(--text-muted); margin-top: 0.5rem;">By: ${log.performed_by || 'Unknown'}</div>
                            </div>
                        `;
                    } else if (log.action === 'job_moved') {
                        const movedToDate = log.moved_to_date ? new Date(log.moved_to_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : '';
                        return `
                            <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 0.5rem; margin-bottom: 0.75rem; border-left: 3px solid #3b82f6;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.75rem; font-weight: 600; color: #3b82f6;">üì¶ Job Moved</span>
                                    <span style="font-size: 0.6875rem; color: var(--text-muted);">${formattedDate} ${formattedTime}</span>
                                </div>
                                <div style="font-size: 0.8125rem; color: var(--text-primary); font-weight: 500;">${details.q_number || 'No Q'} ¬∑ ${jobDate}</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">${details.client || ''} ¬∑ ${details.location || ''}</div>
                                <div style="font-size: 0.75rem; color: #3b82f6; margin-top: 0.5rem;">‚Üí Moved to ${log.moved_to_tech_name || 'Unknown'} (${movedToDate})</div>
                                <div style="font-size: 0.6875rem; color: var(--text-muted); margin-top: 0.5rem;">By: ${log.performed_by || 'Unknown'}</div>
                            </div>
                        `;
                    }
                    return '';
                }).join('');

            } catch (err) {
                console.error('Error loading history:', err);
                document.getElementById('historyContent').innerHTML = `<div style="color: #ef4444; padding: 1rem;">Error loading history</div>`;
            }
        }

        function closeHistoryModal() {
            const overlay = document.getElementById('historyOverlay');
            if (overlay) overlay.remove();
        }

        async function showGlobalAuditModal() {
            const overlay = document.createElement('div');
            overlay.id = 'globalAuditOverlay';
            overlay.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.6);
                backdrop-filter: blur(4px);
                z-index: 200;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 1rem;
            `;

            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--bg-secondary);
                border-radius: 1rem;
                width: 100%;
                max-width: 700px;
                max-height: 85vh;
                display: flex;
                flex-direction: column;
                box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            `;

            modal.innerHTML = `
                <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div>
                            <h2 style="margin: 0; font-size: 1.25rem; color: var(--text-primary);">üìã Audit Log</h2>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.8125rem; color: var(--text-muted);">Deleted & moved jobs ¬∑ Last 3 months</p>
                        </div>
                        <button onclick="closeGlobalAuditModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); padding: 0.5rem;">&times;</button>
                    </div>
                    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                        <input type="text" id="auditSearchFilter" oninput="filterGlobalAudit()" placeholder="Search name, Q number, client, location..." style="
                            padding: 0.5rem 0.75rem;
                            border: 1px solid var(--border-color);
                            border-radius: 0.5rem;
                            font-size: 0.8125rem;
                            font-family: inherit;
                            background: var(--bg-secondary);
                            color: var(--text-primary);
                            flex: 1;
                            min-width: 200px;
                        ">
                        <select id="auditActionFilter" onchange="filterGlobalAudit()" style="
                            padding: 0.5rem 0.75rem;
                            border: 1px solid var(--border-color);
                            border-radius: 0.5rem;
                            font-size: 0.8125rem;
                            font-family: inherit;
                            background: var(--bg-secondary);
                            color: var(--text-primary);
                        ">
                            <option value="all">All Actions</option>
                            <option value="job_deleted">Deleted</option>
                            <option value="job_moved">Moved</option>
                            <option value="canceled">Canceled Only</option>
                        </select>
                    </div>
                </div>
                <div id="globalAuditContent" style="padding: 1.5rem; overflow-y: auto; flex: 1;">
                    <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚è≥</div>
                        <div>Loading audit log...</div>
                    </div>
                </div>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            setupModalClose(overlay, closeGlobalAuditModal);

            // Load audit data
            await loadGlobalAuditData();
        }

        let globalAuditData = [];

        async function loadGlobalAuditData() {
            try {
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

                const { data: logs, error } = await supabaseClient
                    .from('audit_log')
                    .select('*')
                    .gte('created_at', threeMonthsAgo.toISOString())
                    .order('created_at', { ascending: false })
                    .limit(500);

                if (error) {
                    document.getElementById('globalAuditContent').innerHTML = `<div style="color: #ef4444; padding: 1rem;">Error loading audit log: ${error.message}</div>`;
                    return;
                }

                globalAuditData = logs || [];
                filterGlobalAudit();

            } catch (err) {
                console.error('Error loading audit log:', err);
                document.getElementById('globalAuditContent').innerHTML = `<div style="color: #ef4444; padding: 1rem;">Error loading audit log</div>`;
            }
        }

        function filterGlobalAudit() {
            const searchFilter = document.getElementById('auditSearchFilter').value.toLowerCase().trim();
            const actionFilter = document.getElementById('auditActionFilter').value;
            const content = document.getElementById('globalAuditContent');

            let filtered = globalAuditData;

            // Search filter - searches across multiple fields
            if (searchFilter) {
                filtered = filtered.filter(log => {
                    const details = log.job_details || {};
                    const searchFields = [
                        log.technician_name,
                        log.moved_to_tech_name,
                        details.q_number,
                        details.client,
                        details.location,
                        details.task,
                        log.notes,
                        log.date,
                        log.performed_by
                    ].filter(Boolean).map(f => f.toLowerCase());
                    
                    return searchFields.some(field => field.includes(searchFilter));
                });
            }

            if (actionFilter === 'job_deleted') {
                filtered = filtered.filter(log => log.action === 'job_deleted');
            } else if (actionFilter === 'job_moved') {
                filtered = filtered.filter(log => log.action === 'job_moved');
            } else if (actionFilter === 'canceled') {
                filtered = filtered.filter(log => log.was_canceled === true);
            }

            if (filtered.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ú®</div>
                        <div>No matching records found</div>
                    </div>
                `;
                return;
            }

            content.innerHTML = filtered.map(log => {
                const date = new Date(log.created_at);
                const formattedDate = date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
                const formattedTime = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                const jobDate = log.date ? new Date(log.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : '';
                const details = log.job_details || {};

                if (log.action === 'job_deleted') {
                    return `
                        <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 0.5rem; margin-bottom: 0.75rem; border-left: 3px solid ${log.was_canceled ? '#f59e0b' : '#ef4444'};">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                <span style="font-size: 0.75rem; font-weight: 600; color: ${log.was_canceled ? '#f59e0b' : '#ef4444'};">
                                    ${log.was_canceled ? '‚ö†Ô∏è Job Canceled' : 'üóëÔ∏è Job Deleted'}
                                </span>
                                <span style="font-size: 0.6875rem; color: var(--text-muted);">${formattedDate} ${formattedTime}</span>
                            </div>
                            <div style="font-size: 0.875rem; color: var(--text-primary); font-weight: 500;">${log.technician_name || 'Unknown'}</div>
                            <div style="font-size: 0.8125rem; color: var(--text-secondary); margin-top: 0.25rem;">${details.q_number || 'No Q'} ¬∑ ${jobDate} ¬∑ ${details.client || ''}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">${details.location || ''} ¬∑ ${details.task || ''}</div>
                            ${log.notes ? `<div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border-color);"><em>"${log.notes}"</em></div>` : ''}
                            <div style="font-size: 0.6875rem; color: var(--text-muted); margin-top: 0.5rem;">By: ${log.performed_by || 'Unknown'}</div>
                        </div>
                    `;
                } else if (log.action === 'job_moved') {
                    const movedToDate = log.moved_to_date ? new Date(log.moved_to_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : '';
                    return `
                        <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 0.5rem; margin-bottom: 0.75rem; border-left: 3px solid #3b82f6;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                <span style="font-size: 0.75rem; font-weight: 600; color: #3b82f6;">üì¶ Job Moved</span>
                                <span style="font-size: 0.6875rem; color: var(--text-muted);">${formattedDate} ${formattedTime}</span>
                            </div>
                            <div style="font-size: 0.875rem; color: var(--text-primary); font-weight: 500;">${log.technician_name || 'Unknown'} ‚Üí ${log.moved_to_tech_name || 'Unknown'}</div>
                            <div style="font-size: 0.8125rem; color: var(--text-secondary); margin-top: 0.25rem;">${details.q_number || 'No Q'} ¬∑ ${jobDate} ‚Üí ${movedToDate} ¬∑ ${details.client || ''}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">${details.location || ''} ¬∑ ${details.task || ''}</div>
                            <div style="font-size: 0.6875rem; color: var(--text-muted); margin-top: 0.5rem;">By: ${log.performed_by || 'Unknown'}</div>
                        </div>
                    `;
                }
                return '';
            }).join('');
        }

        function closeGlobalAuditModal() {
            const overlay = document.getElementById('globalAuditOverlay');
            if (overlay) overlay.remove();
            globalAuditData = [];
        }

        // ==================== MANAGE TEAM MODAL ====================
        
        function showManageTeamModal() {
            const overlay = document.createElement('div');
            overlay.id = 'manageTeamOverlay';
            overlay.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.6);
                backdrop-filter: blur(4px);
                z-index: 200;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 1rem;
            `;

            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--bg-secondary);
                border-radius: 1rem;
                width: 95%;
                max-width: 950px;
                max-height: 90vh;
                display: flex;
                flex-direction: column;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            `;

            // Group technicians by workstream
            const grouped = {};
            WORKSTREAMS.forEach(ws => grouped[ws.name] = []);
            TECHNICIANS.forEach(tech => {
                if (grouped[tech.workstream]) {
                    grouped[tech.workstream].push(tech);
                } else {
                    if (!grouped['Other']) grouped['Other'] = [];
                    grouped['Other'].push(tech);
                }
            });

            // Sort within each workstream by sort_order, then role rank, then name
            Object.keys(grouped).forEach(ws => {
                grouped[ws].sort((a, b) => {
                    // Use sort_order if available
                    const orderA = a.sort_order ?? 999;
                    const orderB = b.sort_order ?? 999;
                    if (orderA !== orderB) return orderA - orderB;
                    // Fallback to role rank
                    const rankA = getRoleRank(a.role);
                    const rankB = getRoleRank(b.role);
                    if (rankA !== rankB) return rankA - rankB;
                    return a.name.localeCompare(b.name);
                });
            });

            const roleOptions = ROLES.map(r => `<option value="${r.name}">${r.name}</option>`).join('');

            let tableRows = '';
            WORKSTREAMS.forEach(ws => {
                const techs = grouped[ws.name] || [];
                if (techs.length > 0) {
                    tableRows += `
                        <tr class="workstream-header-row" data-workstream="${ws.name}">
                            <td colspan="7" style="background: var(--border-color); padding: 0.5rem 1rem; font-weight: 700; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary);">
                                ${ws.name} (${techs.length})
                            </td>
                        </tr>
                    `;
                    techs.forEach((tech) => {
                        tableRows += `
                            <tr class="tech-row" data-tech-id="${tech.id}" data-workstream="${ws.name}" draggable="true">
                                <td style="padding: 0.5rem; cursor: grab; text-align: center; color: var(--text-muted);" class="drag-handle">‚†ø</td>
                                <td style="padding: 0.5rem;"><input type="text" value="${tech.name}" data-field="name" style="width: 100%; padding: 0.375rem; border: 1px solid var(--border-color); border-radius: 0.25rem; font-size: 0.8125rem; background: var(--bg-secondary); color: var(--text-primary);"></td>
                                <td style="padding: 0.5rem;">
                                    <select data-field="role" style="width: 100%; padding: 0.375rem; border: 1px solid var(--border-color); border-radius: 0.25rem; font-size: 0.8125rem; background: var(--bg-secondary); color: var(--text-primary);">
                                        <option value="${tech.role}">${tech.role}</option>
                                        ${roleOptions}
                                    </select>
                                </td>
                                <td style="padding: 0.5rem;"><input type="text" value="${tech.postcode || ''}" data-field="postcode" style="width: 100%; padding: 0.375rem; border: 1px solid var(--border-color); border-radius: 0.25rem; font-size: 0.8125rem; background: var(--bg-secondary); color: var(--text-primary);"></td>
                                <td style="padding: 0.5rem;">
                                    <select data-field="lineManager" style="width: 100%; padding: 0.375rem; border: 1px solid var(--border-color); border-radius: 0.25rem; font-size: 0.8125rem; background: var(--bg-secondary); color: var(--text-primary);">
                                        <option value="">None</option>
                                        ${TECHNICIANS.filter(t => t.id !== tech.id).map(t => 
                                            `<option value="${t.name}" ${tech.lineManager === t.name ? 'selected' : ''}>${t.name}</option>`
                                        ).join('')}
                                    </select>
                                </td>
                                <td style="padding: 0.5rem;">
                                    <select data-field="workstream" style="width: 100%; padding: 0.375rem; border: 1px solid var(--border-color); border-radius: 0.25rem; font-size: 0.8125rem; background: var(--bg-secondary); color: var(--text-primary);">
                                        ${WORKSTREAMS.map(w => 
                                            `<option value="${w.name}" ${tech.workstream === w.name ? 'selected' : ''}>${w.name}</option>`
                                        ).join('')}
                                    </select>
                                </td>
                                <td style="padding: 0.5rem; text-align: center;">
                                    <button onclick="deleteTeamMember('${tech.id}', '${tech.name.replace(/'/g, "\\'")}')" style="padding: 0.25rem 0.5rem; border: 1px solid #f43f5e; background: rgba(244,63,94,0.1); color: #f43f5e; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">‚úï</button>
                                </td>
                            </tr>
                        `;
                    });
                }
            });

            modal.innerHTML = `
                <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
                    <h2 style="margin: 0; font-size: 1.25rem; color: var(--text-primary);">Manage Team</h2>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.8125rem; color: var(--text-muted);">Edit technician details. Drag ‚†ø to reorder within workstream.</p>
                </div>
                <div style="flex: 1; overflow-y: auto; padding: 1rem;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.8125rem;" id="teamTable">
                        <thead>
                            <tr style="background: var(--bg-tertiary);">
                                <th style="padding: 0.75rem 0.5rem; text-align: left; font-weight: 600; width: 40px;"></th>
                                <th style="padding: 0.75rem 0.5rem; text-align: left; font-weight: 600;">Name</th>
                                <th style="padding: 0.75rem 0.5rem; text-align: left; font-weight: 600;">Role</th>
                                <th style="padding: 0.75rem 0.5rem; text-align: left; font-weight: 600; width: 90px;">Postcode</th>
                                <th style="padding: 0.75rem 0.5rem; text-align: left; font-weight: 600;">Line Manager</th>
                                <th style="padding: 0.75rem 0.5rem; text-align: left; font-weight: 600;">Workstream</th>
                                <th style="padding: 0.75rem 0.5rem; text-align: center; font-weight: 600; width: 50px;"></th>
                            </tr>
                        </thead>
                        <tbody id="teamTableBody">
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
                <div style="padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); display: flex; gap: 0.75rem; justify-content: flex-end;">
                    <button onclick="closeManageTeamModal()" style="padding: 0.625rem 1.25rem; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary); border-radius: 0.5rem; font-size: 0.875rem; cursor: pointer; font-family: inherit;">Cancel</button>
                    <button onclick="saveTeamChanges()" style="padding: 0.625rem 1.25rem; border: none; background: var(--brand-gradient); color: white; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; font-family: inherit;">Save Changes</button>
                </div>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // Setup drag and drop
            setupTeamTableDragDrop();

            setupModalClose(overlay, closeManageTeamModal);
        }

        function setupTeamTableDragDrop() {
            const tbody = document.getElementById('teamTableBody');
            let draggedRow = null;

            tbody.querySelectorAll('.tech-row').forEach(row => {
                row.addEventListener('dragstart', (e) => {
                    draggedRow = row;
                    row.style.opacity = '0.5';
                    row.dataset.dragging = 'true';
                });

                row.addEventListener('dragend', () => {
                    draggedRow.style.opacity = '1';
                    delete draggedRow.dataset.dragging;
                    draggedRow = null;
                });

                row.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (!draggedRow || draggedRow === row) return;
                    
                    // Only allow drop within same workstream
                    if (draggedRow.dataset.workstream !== row.dataset.workstream) return;
                    
                    const rect = row.getBoundingClientRect();
                    const midY = rect.top + rect.height / 2;
                    
                    if (e.clientY < midY) {
                        row.parentNode.insertBefore(draggedRow, row);
                    } else {
                        row.parentNode.insertBefore(draggedRow, row.nextSibling);
                    }
                });
            });
        }

        async function deleteTeamMember(techId, techName) {
            if (!confirm(`Delete ${techName}?\n\nThis will also remove all their schedule entries.`)) return;
            
            suppressRealtimeEvents(5000);
            
            // Delete schedule entries first
            await supabaseClient
                .from('schedule_entries')
                .delete()
                .eq('technician_id', techId);
            
            // Delete technician
            const { error } = await supabaseClient
                .from('technicians')
                .delete()
                .eq('id', techId);
            
            if (error) {
                alert('Error deleting technician: ' + error.message);
                return;
            }
            
            // Remove row from table
            document.querySelector(`[data-tech-id="${techId}"]`)?.remove();
            
            // Update local data
            TECHNICIANS = TECHNICIANS.filter(t => t.id !== techId);
            showUpdateToast(`${techName} deleted`);
        }

        function closeManageTeamModal() {
            const overlay = document.getElementById('manageTeamOverlay');
            if (overlay) overlay.remove();
        }

        async function saveTeamChanges() {
            const saveBtn = document.querySelector('#manageTeamOverlay button[onclick="saveTeamChanges()"]');
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';
            }

            // Suppress realtime events while we save
            suppressRealtimeEvents(10000);

            const rows = document.querySelectorAll('#teamTableBody .tech-row');
            const updates = [];
            
            // Track position within each workstream
            const workstreamPositions = {};

            rows.forEach((row) => {
                const techId = row.dataset.techId;
                const tech = TECHNICIANS.find(t => t.id === techId);
                if (!tech) return;

                const name = row.querySelector('[data-field="name"]').value.trim();
                const role = row.querySelector('[data-field="role"]').value;
                const postcode = row.querySelector('[data-field="postcode"]').value.trim();
                const lineManager = row.querySelector('[data-field="lineManager"]').value;
                const workstream = row.querySelector('[data-field="workstream"]').value;
                
                // Calculate sort_order based on position in current workstream
                if (!workstreamPositions[workstream]) workstreamPositions[workstream] = 0;
                const sortOrder = workstreamPositions[workstream]++;

                // Check if anything changed (data or order)
                const dataChanged = name !== tech.name || 
                    role !== tech.role || 
                    postcode !== (tech.postcode || '') || 
                    lineManager !== (tech.lineManager || '') || 
                    workstream !== tech.workstream;
                const orderChanged = (tech.sort_order ?? -1) !== sortOrder;

                if (dataChanged || orderChanged) {
                    updates.push({
                        id: techId,
                        name,
                        role,
                        postcode,
                        line_manager: lineManager || null,
                        workstream,
                        sort_order: sortOrder
                    });
                }
            });

            if (updates.length === 0) {
                closeManageTeamModal();
                showUpdateToast('No changes to save');
                return;
            }

            // Update changed technicians
            let errorOccurred = false;
            for (const update of updates) {
                const { error } = await supabaseClient
                    .from('technicians')
                    .update({
                        name: update.name,
                        role: update.role,
                        postcode: update.postcode,
                        line_manager: update.line_manager,
                        workstream: update.workstream,
                        sort_order: update.sort_order
                    })
                    .eq('id', update.id);

                if (error) {
                    console.error('Error updating technician:', error);
                    errorOccurred = true;
                    break;
                }
            }

            if (errorOccurred) {
                alert('Error updating some technicians. Please try again.');
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save Changes';
                }
                return;
            }

            closeManageTeamModal();
            await loadAllData();
            showUpdateToast(`Updated ${updates.length} technician(s)`);
        }

        // ==================== MANAGE ROLES MODAL ====================

        function showManageRolesModal() {
            const overlay = document.createElement('div');
            overlay.id = 'manageRolesOverlay';
            overlay.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.6);
                backdrop-filter: blur(4px);
                z-index: 200;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 1rem;
            `;

            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--bg-secondary);
                border-radius: 1rem;
                width: 95%;
                max-width: 500px;
                max-height: 90vh;
                display: flex;
                flex-direction: column;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            `;

            const roleRows = ROLES.map((role, idx) => `
                <tr class="role-row" data-role-id="${role.id || idx}" data-rank="${role.rank}" draggable="true">
                    <td style="padding: 0.5rem; cursor: grab; text-align: center; color: var(--text-muted);">‚†ø</td>
                    <td style="padding: 0.5rem;">
                        <input type="text" value="${role.name}" data-field="name" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.25rem; font-size: 0.875rem; background: var(--bg-secondary); color: var(--text-primary);">
                    </td>
                    <td style="padding: 0.5rem; text-align: center;">
                        <button onclick="deleteRole('${role.id || ''}')" style="padding: 0.25rem 0.5rem; border: 1px solid #f43f5e; background: rgba(244,63,94,0.1); color: #f43f5e; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">‚úï</button>
                    </td>
                </tr>
            `).join('');

            modal.innerHTML = `
                <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
                    <h2 style="margin: 0; font-size: 1.25rem; color: var(--text-primary);">Manage Roles</h2>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.8125rem; color: var(--text-muted);">Drag to reorder hierarchy (top = highest rank)</p>
                </div>
                <div style="flex: 1; overflow-y: auto; padding: 1rem;">
                    <table style="width: 100%; border-collapse: collapse;" id="rolesTable">
                        <thead>
                            <tr style="background: var(--bg-tertiary);">
                                <th style="padding: 0.75rem 0.5rem; width: 40px;"></th>
                                <th style="padding: 0.75rem 0.5rem; text-align: left; font-weight: 600;">Role Name</th>
                                <th style="padding: 0.75rem 0.5rem; width: 60px;"></th>
                            </tr>
                        </thead>
                        <tbody id="rolesTableBody">
                            ${roleRows}
                        </tbody>
                    </table>
                    <button onclick="addNewRoleRow()" style="margin-top: 1rem; width: 100%; padding: 0.75rem; border: 2px dashed var(--border-color); background: transparent; color: var(--text-muted); border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem; font-family: inherit;">+ Add New Role</button>
                </div>
                <div style="padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); display: flex; gap: 0.75rem; justify-content: flex-end;">
                    <button onclick="closeManageRolesModal()" style="padding: 0.625rem 1.25rem; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary); border-radius: 0.5rem; font-size: 0.875rem; cursor: pointer; font-family: inherit;">Cancel</button>
                    <button onclick="saveRolesChanges()" style="padding: 0.625rem 1.25rem; border: none; background: var(--brand-gradient); color: white; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; font-family: inherit;">Save Changes</button>
                </div>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            setupRolesTableDragDrop();

            setupModalClose(overlay, closeManageRolesModal);
        }

        function closeManageRolesModal() {
            const overlay = document.getElementById('manageRolesOverlay');
            if (overlay) overlay.remove();
        }

        function setupRolesTableDragDrop() {
            const tbody = document.getElementById('rolesTableBody');
            let draggedRow = null;

            tbody.querySelectorAll('.role-row').forEach(row => {
                row.addEventListener('dragstart', (e) => {
                    draggedRow = row;
                    row.style.opacity = '0.5';
                });

                row.addEventListener('dragend', () => {
                    draggedRow.style.opacity = '1';
                    draggedRow = null;
                });

                row.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (!draggedRow || draggedRow === row) return;
                    
                    const rect = row.getBoundingClientRect();
                    const midY = rect.top + rect.height / 2;
                    
                    if (e.clientY < midY) {
                        row.parentNode.insertBefore(draggedRow, row);
                    } else {
                        row.parentNode.insertBefore(draggedRow, row.nextSibling);
                    }
                });
            });
        }

        function addNewRoleRow() {
            const tbody = document.getElementById('rolesTableBody');
            const newRow = document.createElement('tr');
            newRow.className = 'role-row';
            newRow.dataset.roleId = 'new-' + Date.now();
            newRow.draggable = true;
            newRow.innerHTML = `
                <td style="padding: 0.5rem; cursor: grab; text-align: center; color: var(--text-muted);">‚†ø</td>
                <td style="padding: 0.5rem;">
                    <input type="text" value="" data-field="name" placeholder="New role name..." style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.25rem; font-size: 0.875rem; background: var(--bg-secondary); color: var(--text-primary);">
                </td>
                <td style="padding: 0.5rem; text-align: center;">
                    <button onclick="this.closest('tr').remove()" style="padding: 0.25rem 0.5rem; border: 1px solid #f43f5e; background: rgba(244,63,94,0.1); color: #f43f5e; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">‚úï</button>
                </td>
            `;
            tbody.appendChild(newRow);
            newRow.querySelector('input').focus();
            setupRolesTableDragDrop();
        }

        async function deleteRole(roleId) {
            if (!roleId) return;
            if (!confirm('Delete this role?')) return;
            
            const { error } = await supabaseClient
                .from('roles')
                .delete()
                .eq('id', roleId);

            if (error) {
                alert('Error deleting role: ' + error.message);
                return;
            }

            // Remove from local array and UI
            ROLES = ROLES.filter(r => r.id !== roleId);
            document.querySelector(`[data-role-id="${roleId}"]`)?.remove();
        }

        async function saveRolesChanges() {
            const rows = document.querySelectorAll('#rolesTableBody .role-row');
            const rolesToUpdate = [];
            const rolesToInsert = [];

            rows.forEach((row, index) => {
                const roleId = row.dataset.roleId;
                const name = row.querySelector('[data-field="name"]').value.trim();
                
                if (!name) return;

                if (roleId.startsWith('new-')) {
                    rolesToInsert.push({ name, rank: index });
                } else {
                    rolesToUpdate.push({ id: roleId, name, rank: index });
                }
            });

            // Update existing roles
            for (const role of rolesToUpdate) {
                await supabaseClient
                    .from('roles')
                    .update({ name: role.name, rank: role.rank })
                    .eq('id', role.id);
            }

            // Insert new roles
            if (rolesToInsert.length > 0) {
                await supabaseClient
                    .from('roles')
                    .insert(rolesToInsert);
            }

            closeManageRolesModal();
            await loadRoles();
            showUpdateToast('Roles updated');
        }

        // ==================== MANAGE WORKSTREAMS MODAL ====================

        function showManageWorkstreamsModal() {
            const overlay = document.createElement('div');
            overlay.id = 'manageWorkstreamsOverlay';
            overlay.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.6);
                backdrop-filter: blur(4px);
                z-index: 200;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 1rem;
            `;

            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--bg-secondary);
                border-radius: 1rem;
                width: 95%;
                max-width: 500px;
                max-height: 90vh;
                display: flex;
                flex-direction: column;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            `;

            const wsRows = WORKSTREAMS.map((ws, idx) => `
                <tr class="ws-row" data-ws-name="${ws.name}" data-rank="${ws.rank}" draggable="true">
                    <td style="padding: 0.5rem; cursor: grab; text-align: center; color: var(--text-muted);">‚†ø</td>
                    <td style="padding: 0.5rem;">
                        <input type="text" value="${ws.name}" data-field="name" data-original="${ws.name}" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.25rem; font-size: 0.875rem; background: var(--bg-secondary); color: var(--text-primary);">
                    </td>
                    <td style="padding: 0.5rem; text-align: center;">
                        <button onclick="deleteWorkstream('${ws.name}')" style="padding: 0.25rem 0.5rem; border: 1px solid #f43f5e; background: rgba(244,63,94,0.1); color: #f43f5e; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">‚úï</button>
                    </td>
                </tr>
            `).join('');

            modal.innerHTML = `
                <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
                    <h2 style="margin: 0; font-size: 1.25rem; color: var(--text-primary);">Manage Workstreams</h2>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.8125rem; color: var(--text-muted);">Drag to reorder. Changes affect dropdown order.</p>
                </div>
                <div style="flex: 1; overflow-y: auto; padding: 1rem;">
                    <table style="width: 100%; border-collapse: collapse;" id="workstreamsTable">
                        <thead>
                            <tr style="background: var(--bg-tertiary);">
                                <th style="padding: 0.75rem 0.5rem; width: 40px;"></th>
                                <th style="padding: 0.75rem 0.5rem; text-align: left; font-weight: 600;">Workstream Name</th>
                                <th style="padding: 0.75rem 0.5rem; width: 60px;"></th>
                            </tr>
                        </thead>
                        <tbody id="workstreamsTableBody">
                            ${wsRows}
                        </tbody>
                    </table>
                    <button onclick="addNewWorkstreamRow()" style="margin-top: 1rem; width: 100%; padding: 0.75rem; border: 2px dashed var(--border-color); background: transparent; color: var(--text-muted); border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem; font-family: inherit;">+ Add New Workstream</button>
                </div>
                <div style="padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); display: flex; gap: 0.75rem; justify-content: flex-end;">
                    <button onclick="closeManageWorkstreamsModal()" style="padding: 0.625rem 1.25rem; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary); border-radius: 0.5rem; font-size: 0.875rem; cursor: pointer; font-family: inherit;">Cancel</button>
                    <button onclick="saveWorkstreamsChanges()" style="padding: 0.625rem 1.25rem; border: none; background: var(--brand-gradient); color: white; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; font-family: inherit;">Save Changes</button>
                </div>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            setupWorkstreamsTableDragDrop();

            setupModalClose(overlay, closeManageWorkstreamsModal);
        }

        function closeManageWorkstreamsModal() {
            const overlay = document.getElementById('manageWorkstreamsOverlay');
            if (overlay) overlay.remove();
        }

        function setupWorkstreamsTableDragDrop() {
            const tbody = document.getElementById('workstreamsTableBody');
            let draggedRow = null;

            tbody.querySelectorAll('.ws-row').forEach(row => {
                row.addEventListener('dragstart', (e) => {
                    draggedRow = row;
                    row.style.opacity = '0.5';
                });

                row.addEventListener('dragend', () => {
                    draggedRow.style.opacity = '1';
                    draggedRow = null;
                });

                row.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (!draggedRow || draggedRow === row) return;
                    
                    const rect = row.getBoundingClientRect();
                    const midY = rect.top + rect.height / 2;
                    
                    if (e.clientY < midY) {
                        row.parentNode.insertBefore(draggedRow, row);
                    } else {
                        row.parentNode.insertBefore(draggedRow, row.nextSibling);
                    }
                });
            });
        }

        function addNewWorkstreamRow() {
            const tbody = document.getElementById('workstreamsTableBody');
            const newRow = document.createElement('tr');
            newRow.className = 'ws-row';
            newRow.dataset.wsName = 'new-' + Date.now();
            newRow.draggable = true;
            newRow.innerHTML = `
                <td style="padding: 0.5rem; cursor: grab; text-align: center; color: var(--text-muted);">‚†ø</td>
                <td style="padding: 0.5rem;">
                    <input type="text" value="" data-field="name" data-original="" placeholder="New workstream name..." style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.25rem; font-size: 0.875rem; background: var(--bg-secondary); color: var(--text-primary);">
                </td>
                <td style="padding: 0.5rem; text-align: center;">
                    <button onclick="this.closest('tr').remove()" style="padding: 0.25rem 0.5rem; border: 1px solid #f43f5e; background: rgba(244,63,94,0.1); color: #f43f5e; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">‚úï</button>
                </td>
            `;
            tbody.appendChild(newRow);
            newRow.querySelector('input').focus();
            setupWorkstreamsTableDragDrop();
        }

        function deleteWorkstream(wsName) {
            // Check if any technicians are in this workstream
            const techsInWs = TECHNICIANS.filter(t => t.workstream === wsName);
            if (techsInWs.length > 0) {
                alert(`Cannot delete "${wsName}" - ${techsInWs.length} technician(s) are assigned to it.`);
                return;
            }
            
            document.querySelector(`[data-ws-name="${wsName}"]`)?.remove();
        }

        async function saveWorkstreamsChanges() {
            suppressRealtimeEvents(5000);
            
            const rows = document.querySelectorAll('#workstreamsTableBody .ws-row');
            const newWorkstreams = [];
            const renames = [];

            rows.forEach((row, index) => {
                const input = row.querySelector('[data-field="name"]');
                const newName = input.value.trim();
                const originalName = input.dataset.original;
                
                if (!newName) return;

                newWorkstreams.push({ name: newName, rank: index });

                // Track renames to update technicians
                if (originalName && originalName !== newName) {
                    renames.push({ from: originalName, to: newName });
                }
            });

            // Update technicians with renamed workstreams
            for (const rename of renames) {
                await supabaseClient
                    .from('technicians')
                    .update({ workstream: rename.to })
                    .eq('workstream', rename.from);
            }

            // Update local WORKSTREAMS array (sorted by rank)
            WORKSTREAMS = newWorkstreams.sort((a, b) => a.rank - b.rank);
            
            // Update workstream filter dropdown
            updateWorkstreamDropdowns();

            closeManageWorkstreamsModal();
            await loadAllData();
            showUpdateToast('Workstreams updated');
        }

        function updateWorkstreamDropdowns() {
            const filterSelect = document.getElementById('workstreamFilter');
            if (filterSelect) {
                const currentValue = filterSelect.value;
                filterSelect.innerHTML = '<option value="all">All Workstreams</option>' +
                    WORKSTREAMS.map(ws => `<option value="${ws.name}">${ws.name}</option>`).join('');
                filterSelect.value = currentValue;
            }
        }

        // Copy Previous Week functionality
        function showCopyPrevWeekModal() {
            const prevWeekStart = new Date(currentWeekStart);
            prevWeekStart.setDate(prevWeekStart.getDate() - 7);
            const prevWeekEnd = new Date(prevWeekStart);
            prevWeekEnd.setDate(prevWeekEnd.getDate() + 6);

            const formatDateShort = (d) => `${d.getDate()}/${d.getMonth() + 1}`;

            const overlay = document.createElement('div');
            overlay.id = 'copyPrevWeekOverlay';
            overlay.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.6);
                backdrop-filter: blur(4px);
                z-index: 200;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--bg-secondary);
                border-radius: 1rem;
                padding: 2rem;
                width: 90%;
                max-width: 500px;
                max-height: 85vh;
                overflow-y: auto;
                box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            `;

            // Group technicians by workstream
            const grouped = {};
            WORKSTREAMS.forEach(ws => grouped[ws.name] = []);
            TECHNICIANS.forEach(tech => {
                if (grouped[tech.workstream]) {
                    grouped[tech.workstream].push(tech);
                }
            });

            let techCheckboxes = '';
            WORKSTREAMS.forEach(ws => {
                const techs = grouped[ws.name] || [];
                if (techs.length > 0) {
                    techCheckboxes += `
                        <div style="margin-bottom: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 0.375rem; margin-bottom: 0.5rem;">
                                <input type="checkbox" class="ws-checkbox" data-workstream="${ws.name}" onchange="toggleWorkstreamTechs('${ws.name}')" style="width: 1rem; height: 1rem;">
                                <span style="font-size: 0.875rem; font-weight: 600; color: var(--text-primary);">${ws.name}</span>
                                <span style="font-size: 0.75rem; color: var(--text-muted);">(${techs.length})</span>
                            </label>
                            <div style="margin-left: 1.5rem; display: flex; flex-direction: column; gap: 0.25rem;">
                                ${techs.map(t => `
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem 0;">
                                        <input type="checkbox" class="tech-checkbox" data-tech-id="${t.id}" data-workstream="${ws.name}" style="width: 0.875rem; height: 0.875rem;">
                                        <span style="font-size: 0.8125rem; color: var(--text-secondary);">${t.name}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            });

            modal.innerHTML = `
                <h2 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; color: var(--text-primary);">Copy Previous Week</h2>
                <p style="margin: 0 0 1rem 0; font-size: 0.875rem; color: var(--text-muted);">
                    Copy entries from <strong>${formatDateShort(prevWeekStart)} - ${formatDateShort(prevWeekEnd)}</strong> to the current week.
                </p>
                
                <div style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <label style="font-size: 0.75rem; font-weight: 500; color: var(--text-secondary);">Select Technicians</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="selectAllTechs(true)" style="padding: 0.25rem 0.5rem; font-size: 0.6875rem; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-secondary); border-radius: 0.25rem; cursor: pointer;">Select All</button>
                            <button onclick="selectAllTechs(false)" style="padding: 0.25rem 0.5rem; font-size: 0.6875rem; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-secondary); border-radius: 0.25rem; cursor: pointer;">Clear All</button>
                        </div>
                    </div>
                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 0.75rem;">
                        ${techCheckboxes}
                    </div>
                </div>

                <div style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(251, 191, 36, 0.1); border: 1px solid #fbbf24; border-radius: 0.5rem;">
                    <div style="display: flex; align-items: flex-start; gap: 0.5rem;">
                        <span style="font-size: 1rem;">‚ö†Ô∏è</span>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">
                            <strong style="color: var(--text-primary);">This will overwrite existing entries</strong><br>
                            Selected technicians' current week entries will be replaced.
                        </div>
                    </div>
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="copyOnlyEmpty" style="width: 1rem; height: 1rem;">
                        <span style="font-size: 0.8125rem; color: var(--text-primary);">Only copy to empty days (don't overwrite)</span>
                    </label>
                </div>
                <div style="display: flex; gap: 0.75rem;">
                    <button onclick="closeCopyPrevWeekModal()" style="
                        flex: 1;
                        padding: 0.625rem 1rem;
                        border: 1px solid var(--border-color);
                        background: var(--bg-secondary);
                        color: var(--text-primary);
                        border-radius: 0.5rem;
                        font-size: 0.875rem;
                        font-weight: 500;
                        cursor: pointer;
                        font-family: inherit;
                    ">Cancel</button>
                    <button onclick="executeCopyPrevWeek()" id="copyPrevWeekBtn2" style="
                        flex: 1;
                        padding: 0.625rem 1rem;
                        border: none;
                        background: var(--brand-gradient);
                        color: white;
                        border-radius: 0.5rem;
                        font-size: 0.875rem;
                        font-weight: 600;
                        cursor: pointer;
                        font-family: inherit;
                    ">Copy Week</button>
                </div>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            setupModalClose(overlay, closeCopyPrevWeekModal);
        }

        function toggleWorkstreamTechs(workstream) {
            const wsCheckbox = document.querySelector(`.ws-checkbox[data-workstream="${workstream}"]`);
            const techCheckboxes = document.querySelectorAll(`.tech-checkbox[data-workstream="${workstream}"]`);
            techCheckboxes.forEach(cb => cb.checked = wsCheckbox.checked);
        }

        function selectAllTechs(selected) {
            document.querySelectorAll('.tech-checkbox').forEach(cb => cb.checked = selected);
            document.querySelectorAll('.ws-checkbox').forEach(cb => cb.checked = selected);
        }

        function closeCopyPrevWeekModal() {
            const overlay = document.getElementById('copyPrevWeekOverlay');
            if (overlay) overlay.remove();
        }

        async function executeCopyPrevWeek() {
            // Get selected technician IDs
            const selectedTechIds = Array.from(document.querySelectorAll('.tech-checkbox:checked'))
                .map(cb => cb.dataset.techId);

            if (selectedTechIds.length === 0) {
                alert('Please select at least one technician.');
                return;
            }

            const onlyEmpty = document.getElementById('copyOnlyEmpty').checked;
            const btn = document.getElementById('copyPrevWeekBtn2');
            btn.disabled = true;
            btn.textContent = 'Copying...';

            suppressRealtimeEvents(15000);

            try {
                // Calculate previous week dates
                const prevWeekStart = new Date(currentWeekStart);
                prevWeekStart.setDate(prevWeekStart.getDate() - 7);
                const prevWeekEnd = new Date(prevWeekStart);
                prevWeekEnd.setDate(prevWeekEnd.getDate() + 6);

                // Load previous week's entries for selected technicians
                const { data: prevEntries, error: loadError } = await supabaseClient
                    .from('schedule_entries')
                    .select('*')
                    .in('technician_id', selectedTechIds)
                    .gte('date', toLocalDateString(prevWeekStart))
                    .lte('date', toLocalDateString(prevWeekEnd));

                if (loadError) throw loadError;

                if (!prevEntries || prevEntries.length === 0) {
                    alert('No entries found in the previous week for selected technicians.');
                    btn.disabled = false;
                    btn.textContent = 'Copy Week';
                    return;
                }

                // Calculate current week dates
                const currentWeekEnd = new Date(currentWeekStart);
                currentWeekEnd.setDate(currentWeekEnd.getDate() + 6);

                // If not onlyEmpty, delete existing entries for selected technicians in current week
                if (!onlyEmpty) {
                    await supabaseClient
                        .from('schedule_entries')
                        .delete()
                        .in('technician_id', selectedTechIds)
                        .gte('date', toLocalDateString(currentWeekStart))
                        .lte('date', toLocalDateString(currentWeekEnd));
                }

                // Get existing entries if onlyEmpty mode
                let existingDates = new Set();
                if (onlyEmpty) {
                    const { data: existing } = await supabaseClient
                        .from('schedule_entries')
                        .select('technician_id, date')
                        .in('technician_id', selectedTechIds)
                        .gte('date', toLocalDateString(currentWeekStart))
                        .lte('date', toLocalDateString(currentWeekEnd));
                    
                    if (existing) {
                        existing.forEach(e => existingDates.add(`${e.technician_id}-${e.date}`));
                    }
                }

                // Create new entries with shifted dates
                const newEntries = [];
                prevEntries.forEach(entry => {
                    const entryDate = new Date(entry.date);
                    const newDate = new Date(entryDate);
                    newDate.setDate(newDate.getDate() + 7);
                    const newDateStr = toLocalDateString(newDate);

                    // Skip if onlyEmpty and there's already an entry
                    if (onlyEmpty && existingDates.has(`${entry.technician_id}-${newDateStr}`)) {
                        return;
                    }

                    newEntries.push({
                        technician_id: entry.technician_id,
                        date: newDateStr,
                        status: entry.status,
                        status_text: entry.status_text,
                        q_number: entry.q_number,
                        client: entry.client,
                        location: entry.location,
                        task: entry.task,
                        partner: entry.partner,
                        is_night: entry.is_night,
                        job_status: entry.job_status,
                        notes: entry.notes
                    });
                });

                if (newEntries.length === 0) {
                    alert('No entries to copy (all days already have entries).');
                    btn.disabled = false;
                    btn.textContent = 'Copy Week';
                    return;
                }

                // Insert new entries
                const { error: insertError } = await supabaseClient
                    .from('schedule_entries')
                    .insert(newEntries);

                if (insertError) throw insertError;

                closeCopyPrevWeekModal();
                await loadAllData();
                showUpdateToast(`Copied ${newEntries.length} entries for ${selectedTechIds.length} technician(s)`);

            } catch (err) {
                console.error('Error copying previous week:', err);
                alert('Error copying previous week: ' + err.message);
                btn.disabled = false;
                btn.textContent = 'Copy Week';
            }
        }

        // Analytics Dashboard
        async function showStatsModal() {
            const overlay = document.createElement('div');
            overlay.id = 'statsOverlay';
            overlay.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.6);
                backdrop-filter: blur(4px);
                z-index: 200;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 1rem;
            `;

            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--bg-secondary);
                border-radius: 1rem;
                width: 100%;
                max-width: 900px;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            `;

            // Calculate stats
            const stats = calculateStats();
            
            // Fetch canceled jobs from audit log for this week
            const weekStart = new Date(currentWeekStart);
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            let canceledStats = { total: 0, byClient: {}, byWorkstream: {} };
            
            try {
                const { data: canceledJobs } = await supabaseClient
                    .from('audit_log')
                    .select('*')
                    .eq('was_canceled', true)
                    .gte('date', toLocalDateString(weekStart))
                    .lte('date', toLocalDateString(weekEnd));
                
                if (canceledJobs) {
                    canceledStats.total = canceledJobs.length;
                    canceledJobs.forEach(job => {
                        const client = job.job_details?.client || 'Unknown';
                        const tech = TECHNICIANS.find(t => t.id === job.technician_id);
                        const workstream = tech?.workstream || 'Unknown';
                        
                        canceledStats.byClient[client] = (canceledStats.byClient[client] || 0) + 1;
                        canceledStats.byWorkstream[workstream] = (canceledStats.byWorkstream[workstream] || 0) + 1;
                    });
                }
            } catch (err) {
                console.error('Error fetching canceled jobs:', err);
            }

            modal.innerHTML = `
                <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 style="margin: 0; font-size: 1.25rem; color: var(--text-primary);">üìä Analytics Dashboard</h2>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.8125rem; color: var(--text-muted);">Week ${getWeekNumber(currentWeekStart)} ¬∑ ${formatDate(currentWeekStart).month} ${currentWeekStart.getFullYear()}</p>
                    </div>
                    <button onclick="closeStatsModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); padding: 0.5rem;">&times;</button>
                </div>
                
                <div style="padding: 1.5rem;">
                    <!-- Summary Cards -->
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: var(--bg-tertiary); border-radius: 0.75rem; padding: 1rem; text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--brand-primary);">${stats.totalJobs}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">Total Jobs</div>
                        </div>
                        <div style="background: var(--bg-tertiary); border-radius: 0.75rem; padding: 1rem; text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #22c55e;">${stats.liveJobs}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">Live</div>
                        </div>
                        <div style="background: var(--bg-tertiary); border-radius: 0.75rem; padding: 1rem; text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #f59e0b;">${stats.pendingJobs}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">Pending</div>
                        </div>
                        <div style="background: var(--bg-tertiary); border-radius: 0.75rem; padding: 1rem; text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #ef4444;">${stats.inactiveJobs}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">Inactive</div>
                        </div>
                        <div style="background: var(--bg-tertiary); border-radius: 0.75rem; padding: 1rem; text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #f97316;">${canceledStats.total}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">Canceled</div>
                        </div>
                        <div style="background: var(--bg-tertiary); border-radius: 0.75rem; padding: 1rem; text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #6366f1;">${stats.nightJobs}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">Night Shifts</div>
                        </div>
                        <div style="background: var(--bg-tertiary); border-radius: 0.75rem; padding: 1rem; text-align: center; cursor: help;" title="${stats.daysWithWork} tech-days with work out of ${stats.totalPossibleDays} possible (${stats.techCount} technicians √ó ${stats.workdaysInWeek} workdays${stats.workdaysInWeek < 5 ? ' due to bank holiday' : ''}). Excludes Management & Admin.">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--text-primary);">${stats.utilisation}%</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">Utilisation <span style="font-size: 0.625rem; opacity: 0.7;">‚ìò</span></div>
                        </div>
                        <div style="background: var(--bg-tertiary); border-radius: 0.75rem; padding: 1rem; text-align: center; opacity: 0.3;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--text-muted);">‚Äî</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;"></div>
                        </div>
                        <div style="background: var(--bg-tertiary); border-radius: 0.75rem; padding: 1rem; text-align: center; opacity: 0.3;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--text-muted);">‚Äî</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;"></div>
                        </div>
                        <div style="background: var(--bg-tertiary); border-radius: 0.75rem; padding: 1rem; text-align: center; opacity: 0.3;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--text-muted);">‚Äî</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;"></div>
                        </div>
                    </div>

                    <!-- Two Column Layout -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <!-- Workstream Breakdown -->
                        <div style="background: var(--bg-tertiary); border-radius: 0.75rem; padding: 1rem;">
                            <h3 style="margin: 0 0 1rem 0; font-size: 0.875rem; color: var(--text-primary);">Jobs by Workstream</h3>
                            ${renderWorkstreamChart(stats.byWorkstream)}
                        </div>

                        <!-- Client Summary -->
                        <div style="background: var(--bg-tertiary); border-radius: 0.75rem; padding: 1rem;">
                            <h3 style="margin: 0 0 1rem 0; font-size: 0.875rem; color: var(--text-primary);">Jobs by Client</h3>
                            ${renderClientChart(stats.byClient)}
                        </div>
                    </div>

                    <!-- Absence & Leave Section -->
                    <div style="background: var(--bg-tertiary); border-radius: 0.75rem; padding: 1rem; margin-top: 1.5rem;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 0.875rem; color: var(--text-primary);">Absences & Leave This Week</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div style="background: var(--bg-secondary); border-radius: 0.5rem; padding: 0.75rem; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #22c55e;">${stats.leaveCount}</div>
                                <div style="font-size: 0.6875rem; color: var(--text-muted);">üå¥ Leave Days</div>
                            </div>
                            <div style="background: var(--bg-secondary); border-radius: 0.5rem; padding: 0.75rem; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #ef4444;">${stats.sicknessCount}</div>
                                <div style="font-size: 0.6875rem; color: var(--text-muted);">üè• Sick Days</div>
                            </div>
                            <div style="background: var(--bg-secondary); border-radius: 0.5rem; padding: 0.75rem; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #8b5cf6;">${stats.bankHolidayCount}</div>
                                <div style="font-size: 0.6875rem; color: var(--text-muted);">üéâ Bank Holiday</div>
                            </div>
                            <div style="background: var(--bg-secondary); border-radius: 0.5rem; padding: 0.75rem; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;">${stats.trainingCount}</div>
                                <div style="font-size: 0.6875rem; color: var(--text-muted);">üìö Training Days</div>
                            </div>
                        </div>
                        ${stats.peopleOnLeave.length > 0 ? `
                            <div style="margin-bottom: 0.75rem;">
                                <span style="font-size: 0.75rem; color: var(--text-secondary);">On Leave:</span>
                                <span style="font-size: 0.75rem; color: var(--text-primary); margin-left: 0.5rem;">${stats.peopleOnLeave.join(', ')}</span>
                            </div>
                        ` : ''}
                        ${stats.peopleOnSickness.length > 0 ? `
                            <div>
                                <span style="font-size: 0.75rem; color: var(--text-secondary);">Off Sick:</span>
                                <span style="font-size: 0.75rem; color: #ef4444; margin-left: 0.5rem;">${stats.peopleOnSickness.join(', ')}</span>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Technician Workload -->
                    <div style="background: var(--bg-tertiary); border-radius: 0.75rem; padding: 1rem; margin-top: 1.5rem;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 0.875rem; color: var(--text-primary);">Technician Workload</h3>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${renderTechnicianWorkload(stats.byTechnician)}
                        </div>
                    </div>

                    <!-- Daily Breakdown -->
                    <div style="background: var(--bg-tertiary); border-radius: 0.75rem; padding: 1rem; margin-top: 1.5rem;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 0.875rem; color: var(--text-primary);">Jobs by Day</h3>
                        ${renderDailyChart(stats.byDay)}
                    </div>

                    ${canceledStats.total > 0 ? `
                    <!-- Canceled Jobs Breakdown -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem;">
                        <div style="background: var(--bg-tertiary); border-radius: 0.75rem; padding: 1rem;">
                            <h3 style="margin: 0 0 1rem 0; font-size: 0.875rem; color: var(--text-primary);">‚ö†Ô∏è Canceled by Client</h3>
                            ${renderCanceledChart(canceledStats.byClient)}
                        </div>
                        <div style="background: var(--bg-tertiary); border-radius: 0.75rem; padding: 1rem;">
                            <h3 style="margin: 0 0 1rem 0; font-size: 0.875rem; color: var(--text-primary);">‚ö†Ô∏è Canceled by Workstream</h3>
                            ${renderCanceledChart(canceledStats.byWorkstream)}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            setupModalClose(overlay, closeStatsModal);
        }

        function closeStatsModal() {
            const overlay = document.getElementById('statsOverlay');
            if (overlay) overlay.remove();
        }

        function calculateStats() {
            let totalJobs = 0;
            let liveJobs = 0;
            let pendingJobs = 0;
            let inactiveJobs = 0;
            let nightJobs = 0;
            let daysWithWork = 0;
            let leaveCount = 0;
            let sicknessCount = 0;
            let bankHolidayCount = 0;
            let trainingCount = 0;

            const byWorkstream = {};
            const byClient = {};
            const byTechnician = {};
            const byDay = { Mon: 0, Tue: 0, Wed: 0, Thu: 0, Fri: 0, Sat: 0, Sun: 0 };
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const peopleOnLeave = [];
            const peopleOnSickness = [];

            // Workstream to exclude from utilisation only
            const excludedWorkstream = 'Management & Admin';

            // Initialize technician data (all technicians for general stats)
            TECHNICIANS.forEach(tech => {
                byTechnician[tech.name] = { jobs: 0, workstream: tech.workstream };
                if (!byWorkstream[tech.workstream]) {
                    byWorkstream[tech.workstream] = 0;
                }
            });

            // Calculate current week date range
            const weekStart = new Date(currentWeekStart);
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);

            // Track unique tech-days with work (for utilisation - excludes Management & Admin)
            const techDaysWithWork = new Set();
            
            // Track bank holiday tech-days (to subtract from possible days)
            const bankHolidayTechDays = new Set();

            // Process schedule entries for current week
            SCHEDULE_ENTRIES.forEach(entry => {
                const entryDate = new Date(entry.date);
                
                // Check if entry is in current week
                if (entryDate >= weekStart && entryDate <= weekEnd) {
                    const tech = TECHNICIANS.find(t => t.id === entry.technician_id);
                    if (!tech) return;

                    const dayName = dayNames[entryDate.getDay()];
                    const techDayKey = `${entry.technician_id}-${entry.date}`;
                    const isExcludedWorkstream = tech.workstream === excludedWorkstream;

                    // If it's a job (has q_number or client)
                    if (entry.q_number || entry.client) {
                        totalJobs++;
                        
                        // Only count towards utilisation if not excluded workstream
                        if (!isExcludedWorkstream) {
                            techDaysWithWork.add(techDayKey);
                        }
                        
                        if (byTechnician[tech.name]) {
                            byTechnician[tech.name].jobs++;
                        }
                        
                        if (byWorkstream[tech.workstream] !== undefined) {
                            byWorkstream[tech.workstream]++;
                        }

                        // Map day index correctly (Mon = 1, Sun = 0 in JS)
                        const dayIndex = entryDate.getDay();
                        const chartDayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                        const chartDay = chartDayNames[dayIndex];
                        if (chartDay === 'Sun') byDay.Sun++;
                        else if (chartDay === 'Mon') byDay.Mon++;
                        else if (chartDay === 'Tue') byDay.Tue++;
                        else if (chartDay === 'Wed') byDay.Wed++;
                        else if (chartDay === 'Thu') byDay.Thu++;
                        else if (chartDay === 'Fri') byDay.Fri++;
                        else if (chartDay === 'Sat') byDay.Sat++;

                        if (entry.client) {
                            byClient[entry.client] = (byClient[entry.client] || 0) + 1;
                        }

                        if (entry.is_night) nightJobs++;
                        if (entry.job_status === 'live') liveJobs++;
                        else if (entry.job_status === 'pending') pendingJobs++;
                        else if (entry.job_status === 'inactive') inactiveJobs++;
                    } 
                    // Track statuses
                    else if (entry.status_type || entry.status) {
                        const status = entry.status_type || entry.status;
                        const workStatuses = ['office', 'training', 'travel', 'wfh'];
                        
                        // Only count towards utilisation if not excluded workstream
                        if (workStatuses.includes(status) && !isExcludedWorkstream) {
                            techDaysWithWork.add(techDayKey);
                        }
                        
                        if (status === 'leave') {
                            leaveCount++;
                            if (!peopleOnLeave.includes(tech.name)) {
                                peopleOnLeave.push(tech.name);
                            }
                        } else if (status === 'sickness') {
                            sicknessCount++;
                            if (!peopleOnSickness.includes(tech.name)) {
                                peopleOnSickness.push(tech.name);
                            }
                        } else if (status === 'bank_holiday') {
                            bankHolidayCount++;
                            // Only count bank holidays for non-excluded workstreams
                            if (!isExcludedWorkstream) {
                                bankHolidayTechDays.add(techDayKey);
                            }
                        } else if (status === 'training') {
                            trainingCount++;
                        }
                    }
                }
            });

            // Count technicians excluding Management & Admin for utilisation
            const utilisationTechCount = TECHNICIANS.filter(t => t.workstream !== excludedWorkstream).length;
            
            // Calculate workdays (5 minus bank holidays that affect everyone)
            // Count unique dates that have bank holidays
            const bankHolidayDates = new Set();
            SCHEDULE_ENTRIES.forEach(entry => {
                const entryDate = new Date(entry.date);
                if (entryDate >= weekStart && entryDate <= weekEnd) {
                    const status = entry.status_type || entry.status;
                    if (status === 'bank_holiday') {
                        bankHolidayDates.add(entry.date);
                    }
                }
            });
            const workdaysInWeek = 5 - bankHolidayDates.size;

            daysWithWork = techDaysWithWork.size;
            const totalPossibleDays = utilisationTechCount * workdaysInWeek;
            const utilisation = totalPossibleDays > 0 
                ? Math.round((daysWithWork / totalPossibleDays) * 100) 
                : 0;

            return {
                totalJobs,
                liveJobs,
                pendingJobs,
                inactiveJobs,
                nightJobs,
                utilisation,
                daysWithWork,
                totalPossibleDays,
                techCount: utilisationTechCount,
                workdaysInWeek,
                byWorkstream,
                byClient,
                byTechnician,
                byDay,
                leaveCount,
                sicknessCount,
                bankHolidayCount,
                trainingCount,
                peopleOnLeave,
                peopleOnSickness
            };
        }

        function renderWorkstreamChart(data) {
            const entries = Object.entries(data).sort((a, b) => b[1] - a[1]);
            const max = Math.max(...entries.map(e => e[1]), 1);
            
            if (entries.length === 0) {
                return '<div style="color: var(--text-muted); font-size: 0.8125rem;">No data</div>';
            }

            return entries.map(([name, count]) => `
                <div style="margin-bottom: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                        <span style="font-size: 0.75rem; color: var(--text-secondary);">${name}</span>
                        <span style="font-size: 0.75rem; font-weight: 600; color: var(--text-primary);">${count}</span>
                    </div>
                    <div style="height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden;">
                        <div style="height: 100%; width: ${(count / max) * 100}%; background: var(--brand-gradient); border-radius: 4px;"></div>
                    </div>
                </div>
            `).join('');
        }

        function renderClientChart(data) {
            const entries = Object.entries(data).sort((a, b) => b[1] - a[1]).slice(0, 8);
            const max = Math.max(...entries.map(e => e[1]), 1);
            
            if (entries.length === 0) {
                return '<div style="color: var(--text-muted); font-size: 0.8125rem;">No client data</div>';
            }

            const colors = ['#ec4899', '#8b5cf6', '#3b82f6', '#06b6d4', '#10b981', '#f59e0b', '#ef4444', '#6366f1'];

            return entries.map(([name, count], i) => `
                <div style="margin-bottom: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                        <span style="font-size: 0.75rem; color: var(--text-secondary);">${name}</span>
                        <span style="font-size: 0.75rem; font-weight: 600; color: var(--text-primary);">${count}</span>
                    </div>
                    <div style="height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden;">
                        <div style="height: 100%; width: ${(count / max) * 100}%; background: ${colors[i % colors.length]}; border-radius: 4px;"></div>
                    </div>
                </div>
            `).join('');
        }

        function renderCanceledChart(data) {
            const entries = Object.entries(data).sort((a, b) => b[1] - a[1]);
            const max = Math.max(...entries.map(e => e[1]), 1);
            
            if (entries.length === 0) {
                return '<div style="color: var(--text-muted); font-size: 0.8125rem;">No canceled jobs</div>';
            }

            return entries.map(([name, count]) => `
                <div style="margin-bottom: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                        <span style="font-size: 0.75rem; color: var(--text-secondary);">${name}</span>
                        <span style="font-size: 0.75rem; font-weight: 600; color: #f97316;">${count}</span>
                    </div>
                    <div style="height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden;">
                        <div style="height: 100%; width: ${(count / max) * 100}%; background: #f97316; border-radius: 4px;"></div>
                    </div>
                </div>
            `).join('');
        }

        function renderTechnicianWorkload(data) {
            const entries = Object.entries(data).sort((a, b) => b[1].jobs - a[1].jobs);
            const max = Math.max(...entries.map(e => e[1].jobs), 1);
            
            if (entries.length === 0) {
                return '<div style="color: var(--text-muted); font-size: 0.8125rem;">No data</div>';
            }

            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 0.5rem;">
                    ${entries.map(([name, info]) => {
                        const percentage = (info.jobs / 5) * 100; // Assuming 5 days = 100%
                        const barColor = percentage >= 80 ? '#22c55e' : percentage >= 50 ? '#f59e0b' : '#ef4444';
                        return `
                            <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-size: 0.75rem; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${name}</div>
                                    <div style="font-size: 0.625rem; color: var(--text-muted);">${info.workstream}</div>
                                </div>
                                <div style="width: 60px; height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden;">
                                    <div style="height: 100%; width: ${Math.min(percentage, 100)}%; background: ${barColor}; border-radius: 3px;"></div>
                                </div>
                                <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-primary); width: 20px; text-align: right;">${info.jobs}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderDailyChart(data) {
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const max = Math.max(...Object.values(data), 1);

            return `
                <div style="display: flex; align-items: flex-end; justify-content: space-between; height: 120px; gap: 0.5rem;">
                    ${days.map(day => {
                        const count = data[day] || 0;
                        const height = (count / max) * 100;
                        const isWeekend = day === 'Sat' || day === 'Sun';
                        return `
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                                <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-primary);">${count}</div>
                                <div style="width: 100%; height: 80px; display: flex; align-items: flex-end;">
                                    <div style="width: 100%; height: ${height}%; background: ${isWeekend ? '#6366f1' : 'var(--brand-gradient)'}; border-radius: 4px 4px 0 0; min-height: ${count > 0 ? '4px' : '0'};"></div>
                                </div>
                                <div style="font-size: 0.6875rem; color: var(--text-muted);">${day}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Job Drag and Drop
        let draggedJobData = null;

        function handleJobDragStart(event, techId, dayIndex, jobIndex) {
            event.stopPropagation();
            const tech = TECHNICIANS.find(t => t.id === techId);
            const job = tech?.schedule[dayIndex]?.jobs?.[jobIndex];
            if (!job) return;

            draggedJobData = {
                sourceTechId: techId,
                sourceDayIndex: dayIndex,
                jobIndex: jobIndex,
                job: job,
                entryId: job.entryId
            };

            event.target.style.opacity = '0.5';
            event.dataTransfer.effectAllowed = 'copyMove';
            event.dataTransfer.setData('text/plain', JSON.stringify(draggedJobData));
        }

        function handleJobDragEnd(event) {
            event.target.style.opacity = '1';
            draggedJobData = null;
            // Remove all drag-over highlights
            document.querySelectorAll('.day-cell.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
        }

        function handleJobDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            if (!draggedJobData) return;
            
            event.dataTransfer.dropEffect = 'copy';
            event.currentTarget.classList.add('drag-over');
        }

        function handleJobDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        function handleJobDrop(event, targetTechId, targetDayIndex) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('drag-over');

            if (!draggedJobData || !currentUser) return;

            // Don't show popup if dropping on the same cell
            if (draggedJobData.sourceTechId === targetTechId && draggedJobData.sourceDayIndex === targetDayIndex) {
                return;
            }

            // Show move/duplicate popup
            showMoveOrDuplicatePopup(draggedJobData, targetTechId, targetDayIndex);
        }

        function showMoveOrDuplicatePopup(dragData, targetTechId, targetDayIndex) {
            const sourceTech = TECHNICIANS.find(t => t.id === dragData.sourceTechId);
            const targetTech = TECHNICIANS.find(t => t.id === targetTechId);
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

            const overlay = document.createElement('div');
            overlay.id = 'moveOrDuplicateOverlay';
            overlay.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.6);
                backdrop-filter: blur(4px);
                z-index: 200;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--bg-secondary);
                border-radius: 1rem;
                padding: 2rem;
                width: 90%;
                max-width: 400px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            `;

            modal.innerHTML = `
                <h2 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; color: var(--text-primary);">Move or Duplicate Job?</h2>
                <p style="margin: 0 0 1.5rem 0; font-size: 0.875rem; color: var(--text-muted);">
                    <strong style="color: var(--brand-primary);">${dragData.job.q}</strong><br>
                    From: ${sourceTech?.name} (${days[dragData.sourceDayIndex]})<br>
                    To: ${targetTech?.name} (${days[targetDayIndex]})
                </p>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <button onclick="executeMoveJob()" style="
                        width: 100%;
                        padding: 0.875rem 1rem;
                        border: none;
                        background: var(--brand-gradient);
                        color: white;
                        border-radius: 0.5rem;
                        font-size: 0.875rem;
                        font-weight: 600;
                        cursor: pointer;
                        font-family: inherit;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 0.5rem;
                    ">
                        <span>üì¶</span> Move Job
                        <span style="font-weight: 400; opacity: 0.8;">(removes from original)</span>
                    </button>
                    <button onclick="executeDuplicateJob()" style="
                        width: 100%;
                        padding: 0.875rem 1rem;
                        border: 1px solid var(--border-color);
                        background: var(--bg-secondary);
                        color: var(--text-primary);
                        border-radius: 0.5rem;
                        font-size: 0.875rem;
                        font-weight: 600;
                        cursor: pointer;
                        font-family: inherit;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 0.5rem;
                    ">
                        <span>üìã</span> Duplicate Job
                        <span style="font-weight: 400; opacity: 0.8;">(keeps original)</span>
                    </button>
                    <button onclick="closeMoveOrDuplicatePopup()" style="
                        width: 100%;
                        padding: 0.625rem 1rem;
                        border: none;
                        background: transparent;
                        color: var(--text-muted);
                        border-radius: 0.5rem;
                        font-size: 0.8125rem;
                        cursor: pointer;
                        font-family: inherit;
                        margin-top: 0.5rem;
                    ">Cancel</button>
                </div>
            `;

            // Store target info for the button handlers
            modal.dataset.targetTechId = targetTechId;
            modal.dataset.targetDayIndex = targetDayIndex;
            modal.dataset.dragData = JSON.stringify(dragData);

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            setupModalClose(overlay, closeMoveOrDuplicatePopup);
        }

        function closeMoveOrDuplicatePopup() {
            const overlay = document.getElementById('moveOrDuplicateOverlay');
            if (overlay) overlay.remove();
        }

        async function executeMoveJob() {
            const modal = document.querySelector('#moveOrDuplicateOverlay > div');
            const targetTechId = modal.dataset.targetTechId;
            const targetDayIndex = parseInt(modal.dataset.targetDayIndex);
            const dragData = JSON.parse(modal.dataset.dragData);

            closeMoveOrDuplicatePopup();

            // Calculate source date
            const sourceDate = new Date(currentWeekStart);
            sourceDate.setDate(sourceDate.getDate() + dragData.sourceDayIndex);
            const sourceDateStr = toLocalDateString(sourceDate);

            // Calculate target date
            const targetDate = new Date(currentWeekStart);
            targetDate.setDate(targetDate.getDate() + targetDayIndex);
            const dateStr = toLocalDateString(targetDate);

            const sourceTech = TECHNICIANS.find(t => t.id === dragData.sourceTechId);
            const targetTech = TECHNICIANS.find(t => t.id === targetTechId);
            const job = dragData.job;

            suppressRealtimeEvents(5000);

            try {
                // Log to audit table
                await supabaseClient
                    .from('audit_log')
                    .insert([{
                        action: 'job_moved',
                        technician_id: dragData.sourceTechId,
                        technician_name: sourceTech?.name,
                        date: sourceDateStr,
                        job_details: {
                            q_number: job.q,
                            client: job.client,
                            location: job.location,
                            task: job.task,
                            partner: job.partner,
                            is_night: job.isNight,
                            job_status: job.jobStatus
                        },
                        was_canceled: false,
                        notes: `Moved to ${targetTech?.name}`,
                        moved_to_tech_id: targetTechId,
                        moved_to_tech_name: targetTech?.name,
                        moved_to_date: dateStr,
                        performed_by: currentUser?.email
                    }]);

                // Update the entry to new technician and date
                const { error } = await supabaseClient
                    .from('schedule_entries')
                    .update({
                        technician_id: targetTechId,
                        date: dateStr
                    })
                    .eq('id', dragData.entryId);

                if (error) throw error;

                // Refresh source and target cells locally
                if (sourceTech) {
                    await reloadTechnicianDay(sourceTech, dragData.sourceDayIndex, sourceDateStr);
                    updateCell(sourceTech, dragData.sourceDayIndex);
                }
                if (targetTech) {
                    await reloadTechnicianDay(targetTech, targetDayIndex, dateStr);
                    updateCell(targetTech, targetDayIndex);
                }

                // Broadcast cell refresh for both source and target cells
                await broadcastCellRefresh([
                    { techId: dragData.sourceTechId, dateStr: sourceDateStr },
                    { techId: targetTechId, dateStr: dateStr }
                ]);

                showUpdateToast(`Job moved to ${targetTech?.name}`);

            } catch (err) {
                console.error('Error moving job:', err);
                alert('Error moving job: ' + err.message);
            }
        }

        async function executeDuplicateJob() {
            const modal = document.querySelector('#moveOrDuplicateOverlay > div');
            const targetTechId = modal.dataset.targetTechId;
            const targetDayIndex = parseInt(modal.dataset.targetDayIndex);
            const dragData = JSON.parse(modal.dataset.dragData);

            closeMoveOrDuplicatePopup();

            // Calculate target date
            const targetDate = new Date(currentWeekStart);
            targetDate.setDate(targetDate.getDate() + targetDayIndex);
            const dateStr = toLocalDateString(targetDate);

            const job = dragData.job;

            suppressRealtimeEvents(5000);

            try {
                const { error } = await supabaseClient
                    .from('schedule_entries')
                    .insert({
                        technician_id: targetTechId,
                        date: dateStr,
                        entry_type: 'job',
                        q_number: job.q,
                        client: job.client,
                        location: job.location,
                        task: job.task,
                        partner: job.partner,
                        is_night: job.isNight,
                        job_status: job.jobStatus,
                        notes: job.notes
                    });

                if (error) throw error;

                // Refresh target cell locally
                const targetTech = TECHNICIANS.find(t => t.id === targetTechId);
                if (targetTech) {
                    await reloadTechnicianDay(targetTech, targetDayIndex, dateStr);
                    updateCell(targetTech, targetDayIndex);
                }

                // Broadcast cell refresh for target cell
                await broadcastCellRefresh([
                    { techId: targetTechId, dateStr: dateStr }
                ]);

                showUpdateToast(`Job duplicated to ${targetTech?.name}`);

            } catch (err) {
                console.error('Error duplicating job:', err);
                alert('Error duplicating job: ' + err.message);
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // Check if entry modal is open
                const entryModal = document.getElementById('entryModalOverlay');
                if (entryModal) {
                    confirmCloseEntryModal();
                } else {
                    closePanel();
                }
            }
        });

        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Supabase
            try {
                if (window.supabase) {
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log('Supabase connected');
                    
                    // Listen for auth changes
                    supabaseClient.auth.onAuthStateChange((event, session) => {
                        currentUser = session?.user || null;
                        updateAuthUI();
                        updatePresenceUser(); // Update presence when auth changes
                    });

                    // Setup real-time sync
                    setupRealtimeSync();
                } else {
                    console.error('Supabase library not loaded');
                }
            } catch (e) {
                console.error('Error initializing Supabase:', e);
            }
            
            initDarkMode();
            await checkAuth();
            await loadAllData();
        });
    </script>
</body>
</html>
