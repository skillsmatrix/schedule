<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Business Unit Schedule</title>
    <link rel="icon" type="image/x-icon" href="https://mgroupltd.com/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Brand */
            --brand-primary: #E91388;
            --brand-secondary: #F7941D;
            --brand-gradient: linear-gradient(135deg, #E91388 0%, #F7941D 100%);
            
            /* Neutrals - Light Mode */
            --slate-950: #0f172a;
            --slate-900: #1e293b;
            --slate-800: #1e293b;
            --slate-700: #334155;
            --slate-600: #475569;
            --slate-500: #64748b;
            --slate-400: #94a3b8;
            --slate-300: #cbd5e1;
            --slate-200: #e2e8f0;
            --slate-100: #f1f5f9;
            --slate-50: #f8fafc;
            --white: #ffffff;
            
            /* Surfaces */
            --bg-primary: var(--slate-100);
            --bg-secondary: var(--white);
            --bg-tertiary: var(--slate-50);
            --bg-header: var(--slate-900);
            --text-primary: var(--slate-900);
            --text-secondary: var(--slate-600);
            --text-muted: var(--slate-500);
            --border-color: var(--slate-200);
            --border-strong: var(--slate-300);
        }
        
        /* Dark Mode */
        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-header: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --border-strong: #475569;
            
            --slate-50: #1e293b;
            --slate-100: #334155;
            --slate-200: #475569;
            --slate-700: #cbd5e1;
            --slate-800: #e2e8f0;
            --slate-900: #f1f5f9;
            --white: #1e293b;
            
            /* Adjusted status backgrounds for dark mode */
            --status-leave-bg: rgba(16, 185, 129, 0.2);
            --status-training-bg: rgba(139, 92, 246, 0.2);
            --status-sickness-bg: rgba(244, 63, 94, 0.2);
            --status-office-bg: rgba(14, 165, 233, 0.2);
            --status-night-bg: rgba(99, 102, 241, 0.2);
            --status-rest-bg: rgba(245, 158, 11, 0.2);
            --status-wfh-bg: rgba(20, 184, 166, 0.2);
            --status-travel-bg: rgba(236, 72, 153, 0.2);
        }
            
            /* Status - Modern, distinct */
            --status-leave: #10b981;
            --status-leave-bg: #d1fae5;
            --status-training: #8b5cf6;
            --status-training-bg: #ede9fe;
            --status-sickness: #f43f5e;
            --status-sickness-bg: #ffe4e6;
            --status-office: #0ea5e9;
            --status-office-bg: #e0f2fe;
            --status-night: #6366f1;
            --status-night-bg: #e0e7ff;
            --status-rest: #f59e0b;
            --status-rest-bg: #fef3c7;
            --status-wfh: #14b8a6;
            --status-wfh-bg: #ccfbf1;
            --status-travel: #ec4899;
            --status-travel-bg: #fce7f3;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            transition: background 0.3s ease, color 0.3s ease;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* === HEADER === */
        .header {
            background: var(--brand-gradient);
            padding: 1.25rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0;
            width: 100%;
            box-sizing: border-box;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .logo-section h1 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--white);
            letter-spacing: -0.025em;
        }

        .logo-section p {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.8);
            margin-top: 0.125rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .week-navigator {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            padding: 0.375rem;
            border-radius: 0.75rem;
        }

        .week-navigator button {
            width: 2rem;
            height: 2rem;
            border: none;
            background: rgba(255,255,255,0.1);
            color: var(--white);
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            flex-shrink: 0;
        }

        .week-navigator button:hover {
            background: rgba(255,255,255,0.25);
        }

        .week-navigator .week-display {
            padding: 0 0.75rem;
            color: var(--white);
            font-weight: 600;
            font-size: 0.8125rem;
            text-align: center;
            white-space: nowrap;
        }

        .btn-today {
            background: var(--white);
            color: var(--brand-primary);
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .btn-today:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        /* === TOOLBAR === */
        .toolbar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            transition: background 0.3s ease;
        }

        .filters {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .filter-select {
            padding: 0.5rem 0.75rem;
            padding-right: 2rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 0.8125rem;
            font-family: inherit;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            transition: all 0.15s ease;
        }

        .filter-select:hover {
            border-color: var(--border-strong);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(233, 19, 136, 0.1);
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding: 0.5rem 0.75rem 0.5rem 2.25rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 0.8125rem;
            font-family: inherit;
            width: 200px;
            transition: all 0.15s ease;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .search-box input::placeholder {
            color: var(--text-muted);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(233, 19, 136, 0.1);
            width: 260px;
        }

        .search-box::before {
            content: '';
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            width: 1rem;
            height: 1rem;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='M21 21l-4.35-4.35'/%3E%3C/svg%3E");
            background-size: contain;
        }

        .toolbar-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-icon {
            width: 2.25rem;
            height: 2.25rem;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all 0.15s ease;
        }

        .btn-icon:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-strong);
        }

        .btn-icon.active {
            background: var(--brand-primary);
            border-color: var(--brand-primary);
            color: var(--white);
        }

        [data-theme="dark"] .btn-icon.active {
            color: #ffffff;
        }

        /* === LEGEND === */
        .legend {
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            padding: 0.5rem 2rem;
            display: flex;
            gap: 1.5rem;
            align-items: center;
            transition: background 0.3s ease;
        }

        .legend-label {
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .legend-items {
            display: flex;
            gap: 1rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.6875rem;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 0.5rem;
            height: 0.5rem;
            border-radius: 50%;
        }

        /* === SCHEDULE GRID === */
        .schedule-wrapper {
            padding: 1.5rem 2rem;
        }

        .schedule-container {
            background: var(--bg-secondary);
            border-radius: 1rem;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            transition: background 0.3s ease;
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: 200px repeat(5, 1fr);
            min-width: 1000px;
        }

        .schedule-grid.show-weekends {
            grid-template-columns: 200px repeat(7, 1fr);
        }

        /* Header row */
        .grid-header {
            display: contents;
        }

        .grid-header-cell {
            background: var(--bg-header);
            padding: 1rem;
            text-align: center;
            color: #ffffff;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .grid-header-cell:first-child {
            text-align: left;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--slate-400);
            display: flex;
            align-items: center;
        }

        .grid-header-cell.today {
            background: var(--brand-primary);
        }

        .grid-header-cell.weekend {
            background: var(--slate-700);
        }

        [data-theme="dark"] .grid-header-cell.weekend {
            background: #0f172a;
        }

        .day-name {
            font-size: 0.6875rem;
            font-weight: 500;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .day-date {
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1.2;
            margin-top: 0.125rem;
        }

        .day-month {
            font-size: 0.6875rem;
            font-weight: 500;
            opacity: 0.7;
        }

        /* Person rows */
        .person-row {
            display: contents;
        }

        .person-row:nth-child(odd) .person-cell,
        .person-row:nth-child(odd) .day-cell {
            background: var(--slate-50);
        }

        .person-row:hover .person-cell,
        .person-row:hover .day-cell {
            background: rgba(233, 19, 136, 0.03);
        }

        .person-cell {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 100px;
            cursor: pointer;
            transition: all 0.15s ease;
            position: sticky;
            left: 0;
            background: var(--bg-secondary);
            z-index: 5;
        }

        .person-row:nth-child(odd) .person-cell {
            background: var(--bg-tertiary);
        }

        .person-cell:hover {
            background: var(--slate-100) !important;
        }

        .person-name {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-primary);
            line-height: 1.3;
        }

        .person-role {
            font-size: 0.6875rem;
            color: var(--text-muted);
            margin-top: 0.125rem;
        }

        .person-meta {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.375rem;
        }

        .person-tag {
            font-size: 0.625rem;
            padding: 0.125rem 0.375rem;
            background: var(--border-color);
            color: var(--text-secondary);
            border-radius: 0.25rem;
            font-weight: 500;
        }

        /* Day cells */
        .day-cell {
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            border-left: 1px solid var(--border-color);
            min-height: 100px;
            cursor: pointer;
            transition: all 0.15s ease;
            background: var(--bg-secondary);
        }

        .day-cell:hover {
            background: var(--slate-100) !important;
        }

        /* Real-time update highlight */
        .day-cell.cell-updated {
            animation: cellHighlight 1.5s ease-out;
        }

        @keyframes cellHighlight {
            0% {
                background: rgba(233, 19, 136, 0.2);
                box-shadow: inset 0 0 0 2px var(--brand-primary);
            }
            100% {
                background: var(--bg-secondary);
                box-shadow: none;
            }
        }

        .day-cell.weekend {
            background: var(--bg-tertiary);
        }

        .person-row:nth-child(odd) .day-cell {
            background: var(--bg-tertiary);
        }

        .person-row:nth-child(odd) .day-cell.weekend {
            background: var(--slate-100);
        }

        /* === JOB ENTRIES === */
        .job-entry {
            background: var(--bg-secondary);
            border-radius: 0.5rem;
            padding: 0.5rem 0.625rem;
            margin-bottom: 0.375rem;
            border-left: 3px solid var(--brand-primary);
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 0.75rem;
            line-height: 1.4;
        }

        [data-theme="dark"] .job-entry {
            background: var(--slate-100);
        }

        .job-entry:last-child {
            margin-bottom: 0;
        }

        .job-entry:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        /* Full display (1-2 jobs) */
        .job-entry.full .job-q {
            font-weight: 700;
            color: var(--brand-primary);
            font-size: 0.8125rem;
        }

        .job-entry.full .job-location {
            color: var(--text-primary);
            font-weight: 500;
            margin-top: 0.125rem;
        }

        .job-entry.full .job-task {
            color: var(--text-muted);
            font-size: 0.6875rem;
            margin-top: 0.125rem;
        }

        .job-entry.full .job-partner {
            color: var(--text-muted);
            font-size: 0.625rem;
            margin-top: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .job-entry.full .job-partner::before {
            content: 'üë§';
            font-size: 0.625rem;
        }

        /* Compact display (3-4 jobs) */
        .job-entry.compact {
            padding: 0.375rem 0.5rem;
        }

        .job-entry.compact .job-line {
            display: flex;
            gap: 0.375rem;
            align-items: baseline;
        }

        .job-entry.compact .job-q {
            font-weight: 700;
            color: var(--brand-primary);
            font-size: 0.75rem;
        }

        .job-entry.compact .job-location {
            color: var(--text-secondary);
            font-size: 0.6875rem;
        }

        .job-entry.compact .job-task {
            color: var(--text-muted);
            font-size: 0.625rem;
        }

        /* Minimal display (5+ jobs) */
        .jobs-minimal {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }

        .job-chip {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--brand-primary);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .job-chip:hover {
            background: var(--brand-primary);
            color: #ffffff;
            border-color: var(--brand-primary);
        }

        .jobs-overflow {
            background: var(--border-color);
            color: var(--text-secondary);
            border: none;
        }

        /* === STATUS ENTRIES === */
        .status-entry {
            border-radius: 0.5rem;
            padding: 0.625rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            min-height: 80px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .status-entry:hover {
            filter: brightness(0.95);
        }

        .status-entry .status-icon {
            font-size: 1rem;
        }

        .status-entry.work {
            border: 1px solid currentColor;
        }

        .status-entry.non-work {
            border: 2px dashed currentColor;
            opacity: 0.9;
        }

        .status-leave { background: var(--status-leave-bg); color: var(--status-leave); }
        .status-training { background: var(--status-training-bg); color: var(--status-training); }
        .status-sickness { background: var(--status-sickness-bg); color: var(--status-sickness); }
        .status-office { background: var(--status-office-bg); color: var(--status-office); }
        .status-night { background: var(--status-night-bg); color: var(--status-night); }
        .status-rest { background: var(--status-rest-bg); color: var(--status-rest); }
        .status-wfh { background: var(--status-wfh-bg); color: var(--status-wfh); }
        .status-travel { background: var(--status-travel-bg); color: var(--status-travel); }

        /* === SIDE PANEL === */
        .panel-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(2px);
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s ease;
        }

        .panel-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .side-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 420px;
            max-width: 100%;
            height: 100vh;
            background: var(--bg-secondary);
            z-index: 101;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), background 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-xl);
        }

        .side-panel.open {
            transform: translateX(0);
        }

        .panel-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .panel-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .panel-subtitle {
            font-size: 0.8125rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .panel-close {
            width: 2rem;
            height: 2rem;
            border: none;
            background: var(--bg-tertiary);
            border-radius: 0.5rem;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .panel-close:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .panel-section {
            margin-bottom: 1.5rem;
        }

        .panel-section:last-child {
            margin-bottom: 0;
        }

        .panel-section-title {
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }

        .panel-field {
            margin-bottom: 0.75rem;
        }

        .panel-field:last-child {
            margin-bottom: 0;
        }

        .panel-label {
            font-size: 0.6875rem;
            color: var(--text-muted);
            margin-bottom: 0.125rem;
        }

        .panel-value {
            font-size: 0.875rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .panel-jobs-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .panel-job-card {
            background: var(--bg-tertiary);
            border-radius: 0.75rem;
            padding: 1rem;
            border-left: 3px solid var(--brand-primary);
        }

        .panel-job-q {
            font-weight: 700;
            color: var(--brand-primary);
            font-size: 0.9375rem;
        }

        .panel-job-client {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.125rem;
        }

        .panel-job-details {
            margin-top: 0.75rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .panel-job-detail {
            font-size: 0.75rem;
        }

        .panel-job-detail-label {
            color: var(--text-muted);
            font-size: 0.625rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .panel-job-detail-value {
            color: var(--text-primary);
            font-weight: 500;
            margin-top: 0.125rem;
        }

        .panel-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 0.75rem;
        }

        .panel-btn {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.8125rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            font-family: inherit;
        }

        .panel-btn-primary {
            background: var(--brand-gradient);
            color: #ffffff;
            border: none;
        }

        .panel-btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .panel-btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .panel-btn-secondary:hover {
            background: var(--bg-tertiary);
        }

        /* === WORKSTREAM DIVIDERS === */
        .workstream-divider {
            display: contents;
        }

        .workstream-header {
            grid-column: 1 / -1;
            background: var(--border-color);
            padding: 0.5rem 1rem;
            font-size: 0.6875rem;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* === RESPONSIVE === */
        @media (max-width: 1200px) {
            .schedule-grid {
                grid-template-columns: 180px repeat(5, 1fr);
            }

            .schedule-grid.show-weekends {
                grid-template-columns: 180px repeat(7, 1fr);
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 0.75rem 1rem;
                flex-direction: column;
                align-items: stretch;
            }

            .logo-section {
                text-align: center;
            }

            .logo-section h1 {
                font-size: 1rem;
            }

            .logo-section p {
                font-size: 0.6875rem;
            }

            .header-actions {
                justify-content: center;
                width: 100%;
            }

            .week-navigator {
                flex: 1;
                justify-content: center;
                max-width: none;
            }

            .week-navigator .week-display {
                font-size: 0.75rem;
                padding: 0 0.5rem;
            }

            .week-navigator button {
                width: 1.75rem;
                height: 1.75rem;
                font-size: 0.875rem;
            }

            .btn-today {
                padding: 0.375rem 0.625rem;
                font-size: 0.6875rem;
            }

            .toolbar {
                padding: 0.5rem 1rem;
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }

            .filters {
                flex-wrap: wrap;
                gap: 0.375rem;
            }

            .filter-select {
                flex: 1;
                min-width: 100px;
                font-size: 0.75rem;
                padding: 0.375rem 0.5rem;
            }

            .search-box {
                width: 100%;
            }

            .search-box input {
                width: 100%;
                font-size: 0.75rem;
            }

            .search-box input:focus {
                width: 100%;
            }

            .toolbar-actions {
                justify-content: flex-end;
            }

            .legend {
                padding: 0.375rem 1rem;
                gap: 0.75rem;
                overflow-x: auto;
            }

            .legend-items {
                gap: 0.5rem;
            }

            .legend-item {
                font-size: 0.625rem;
                white-space: nowrap;
            }

            .schedule-wrapper {
                padding: 0.5rem;
            }

            /* Mobile grid - compact with rotated names */
            .schedule-grid {
                grid-template-columns: 60px repeat(5, minmax(70px, 1fr));
                min-width: auto;
            }

            .schedule-grid.show-weekends {
                grid-template-columns: 60px repeat(7, minmax(55px, 1fr));
            }

            .grid-header-cell {
                padding: 0.5rem 0.25rem;
            }

            .grid-header-cell:first-child {
                font-size: 0.5rem;
            }

            .day-name {
                font-size: 0.5rem;
            }

            .day-date {
                font-size: 1rem;
            }

            .day-month {
                font-size: 0.5rem;
            }

            /* Rotated person names for mobile */
            .person-cell {
                padding: 0.375rem;
                min-height: 80px;
                writing-mode: vertical-rl;
                text-orientation: mixed;
                transform: rotate(180deg);
                justify-content: flex-end;
                align-items: center;
            }

            .person-name {
                font-size: 0.6875rem;
                white-space: nowrap;
            }

            .person-role {
                display: none;
            }

            .person-meta {
                display: none;
            }

            /* Compact day cells */
            .day-cell {
                padding: 0.25rem;
                min-height: 80px;
            }

            /* Mobile job entries */
            .job-entry {
                padding: 0.25rem 0.375rem;
                font-size: 0.625rem;
                border-left-width: 2px;
            }

            .job-entry.full .job-q {
                font-size: 0.6875rem;
            }

            .job-entry.full .job-location {
                font-size: 0.5625rem;
            }

            .job-entry.full .job-task,
            .job-entry.full .job-partner {
                display: none;
            }

            .job-entry.compact .job-q {
                font-size: 0.625rem;
            }

            .job-entry.compact .job-location,
            .job-entry.compact .job-task {
                display: none;
            }

            /* Mobile job chips */
            .job-chip {
                padding: 0.125rem 0.25rem;
                font-size: 0.5625rem;
            }

            /* Mobile status entries */
            .status-entry {
                padding: 0.375rem;
                min-height: 60px;
                font-size: 0.625rem;
                flex-direction: column;
                gap: 0.125rem;
            }

            .status-entry .status-icon {
                font-size: 0.875rem;
            }

            .status-entry span:not(.status-icon) {
                font-size: 0.5rem;
                line-height: 1.2;
            }

            /* Workstream header */
            .workstream-header {
                padding: 0.375rem 0.5rem;
                font-size: 0.5625rem;
            }

            .side-panel {
                width: 100%;
            }
        }

        /* Extra small screens */
        @media (max-width: 480px) {
            .header {
                padding: 0.5rem 0.75rem;
            }

            .week-navigator {
                padding: 0.25rem;
            }

            .week-navigator .week-display {
                font-size: 0.6875rem;
            }

            .schedule-grid {
                grid-template-columns: 50px repeat(5, minmax(55px, 1fr));
            }

            .schedule-grid.show-weekends {
                grid-template-columns: 50px repeat(7, minmax(45px, 1fr));
            }

            .person-cell {
                min-height: 70px;
            }

            .person-name {
                font-size: 0.625rem;
            }

            .day-cell {
                min-height: 70px;
            }

            .job-entry.full .job-location {
                display: none;
            }

            .job-entry.full .job-q {
                font-size: 0.625rem;
            }
        }

        /* === SCROLLBAR === */
        .schedule-container::-webkit-scrollbar {
            height: 8px;
        }

        .schedule-container::-webkit-scrollbar-track {
            background: var(--slate-100);
        }

        .schedule-container::-webkit-scrollbar-thumb {
            background: var(--slate-300);
            border-radius: 4px;
        }

        .schedule-container::-webkit-scrollbar-thumb:hover {
            background: var(--slate-400);
        }

        /* === TOAST ANIMATIONS === */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo-section">
            <h1>Water Business Unit Schedule</h1>
            <p>Resource deployment & planning</p>
        </div>
        <div class="header-actions">
            <div class="week-navigator">
                <button onclick="changeWeek(-1)" aria-label="Previous week">‚Äπ</button>
                <div class="week-display" id="weekDisplay">Week 49 ¬∑ December 2025</div>
                <button onclick="changeWeek(1)" aria-label="Next week">‚Ä∫</button>
            </div>
            <button class="btn-today" onclick="goToToday()">Today</button>
            <button class="btn-today" id="authBtn" style="background: rgba(255,255,255,0.2); color: white;">üîê Sign In</button>
        </div>
    </header>

    <!-- Toolbar -->
    <div class="toolbar">
        <div class="filters">
            <select class="filter-select" id="workstreamFilter" onchange="renderSchedule()">
                <option value="all">All Workstreams</option>
                <option value="Project Delivery">Project Delivery</option>
                <option value="Clean Water">Clean Water</option>
                <option value="Waste Water">Waste Water</option>
                <option value="Contingent Resources">Contingent</option>
                <option value="Management & Admin">Management</option>
            </select>
            <select class="filter-select" id="clientFilter" onchange="renderSchedule()">
                <option value="all">All Clients</option>
                <!-- Populated dynamically -->
            </select>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search name, Q number, location, role..." oninput="renderSchedule()">
            </div>
        </div>
        <div class="toolbar-actions">
            <button class="btn-icon" id="csvUploadBtn" onclick="showCSVModal()" title="Upload CSV" style="display: none;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17,8 12,3 7,8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
            </button>
            <button class="btn-icon" id="addTechBtn" onclick="showAddTechnicianModal()" title="Add Technician" style="display: none;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
            </button>
            <button class="btn-icon" id="toggleDarkMode" onclick="toggleDarkMode()" title="Toggle dark mode">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="darkModeIcon">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                </svg>
            </button>
            <button class="btn-icon active" id="toggleWeekends" onclick="toggleWeekends()" title="Toggle weekends">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Legend -->
    <div class="legend">
        <span class="legend-label">Job Status</span>
        <div class="legend-items">
            <div class="legend-item"><div class="legend-dot" style="background: #6366f1"></div>Night</div>
            <div class="legend-item"><div class="legend-dot" style="background: #ef4444"></div>Inactive</div>
            <div class="legend-item"><div class="legend-dot" style="background: #f59e0b"></div>Pending</div>
            <div class="legend-item"><div class="legend-dot" style="background: #22c55e"></div>Live</div>
        </div>
    </div>

    <!-- Schedule -->
    <div class="schedule-wrapper">
        <div class="schedule-container" style="overflow-x: auto;">
            <div class="schedule-grid" id="scheduleGrid">
                <!-- Rendered by JS -->
            </div>
        </div>
    </div>

    <!-- Side Panel -->
    <div class="panel-overlay" id="panelOverlay" onclick="closePanel()"></div>
    <div class="side-panel" id="sidePanel">
        <div class="panel-header">
            <div>
                <div class="panel-title" id="panelTitle">Technician Details</div>
                <div class="panel-subtitle" id="panelSubtitle">Monday, 1 December</div>
            </div>
            <button class="panel-close" onclick="closePanel()" aria-label="Close">√ó</button>
        </div>
        <div class="panel-body" id="panelBody">
            <!-- Dynamic content -->
        </div>
        <div class="panel-footer" id="panelFooter">
            <!-- Dynamic buttons -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://tcjaegtublrlkyxveloh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjamFlZ3R1YmxybGt5eHZlbG9oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzNzc4MzMsImV4cCI6MjA4Mzk1MzgzM30.4aNJQZ2REe_njrdVyhefDomnrKQo2zMo-iDJnGhxRXI';
        
        let supabaseClient = null;

        // Status configuration
        const STATUS_CONFIG = {
            leave: { icon: 'üå¥', label: 'Annual Leave', isWork: false },
            training: { icon: 'üìö', label: 'Training', isWork: true },
            sickness: { icon: 'üè•', label: 'Sickness', isWork: false },
            office: { icon: 'üè¢', label: 'Office', isWork: true },
            night: { icon: 'üåô', label: 'Night Work', isWork: true },
            rest: { icon: '‚òÄÔ∏è', label: 'Rest Day', isWork: false },
            wfh: { icon: 'üè†', label: 'WFH', isWork: true },
            travel: { icon: 'üöó', label: 'Travel', isWork: true },
            bank_holiday: { icon: 'üéâ', label: 'Bank Holiday', isWork: false }
        };

        // Sample data - will be replaced by Supabase
        let TECHNICIANS = [];
        let CLIENTS = [];
        let ROLES = [];
        let isLoading = true;
        let currentUser = null;

        // Default clients (A-Z order)
        const DEFAULT_CLIENTS = [
            'Affinity Water',
            'Ancala Water',
            'Anglian Water',
            'Cambridge Water',
            'Guernsey Water',
            'Jersey Water',
            'Northumbrian Water',
            'Portsmouth Water',
            'Scottish Water',
            'Severn Trent Water',
            'South East Water',
            'South West Water',
            'Southern Water',
            'Sutton & East Surrey',
            'Thames Water',
            'United Utilities',
            'Welsh Water'
        ];

        // Default roles in hierarchy order (highest to lowest)
        const DEFAULT_ROLES = [
            'Contract Director',
            'Contingent Resource Manager',
            'Delivery Manager',
            'Technical Support ‚Äì Instrumentation',
            'Project Manager',
            'Project Engineer',
            'Systems Engineer',
            'Lead Project Coordinator',
            'Project Coordinator',
            'Data Analyst',
            'Senior Supervisor',
            'Supervisor',
            'Supervisor ‚Äì Civil/Mechanical',
            'Electrician',
            'ICA Technician',
            'EC&I Technician',
            'Logging Tech',
            'M&E',
            'M&E Technician',
            'Mechanical Technician',
            'Metering Tech',
            'C&I Technician',
            'Civil & Mechanical Tech',
            'Degree Apprentice',
            'Assistant Technician'
        ];

        // Role hierarchy for sorting (lower index = higher rank)
        function getRoleRank(role) {
            const index = ROLES.indexOf(role);
            if (index === -1) {
                // Unknown role goes to the end
                return ROLES.length + 1;
            }
            return index;
        }

        // Load clients from Supabase
        async function loadClients() {
            if (!supabaseClient) return DEFAULT_CLIENTS;
            
            const { data, error } = await supabaseClient
                .from('clients')
                .select('name')
                .order('name', { ascending: true });
            
            if (error || !data || data.length === 0) {
                // If no clients table or empty, seed with defaults
                return DEFAULT_CLIENTS;
            }
            return data.map(c => c.name);
        }

        // Load roles from Supabase
        async function loadRoles() {
            if (!supabaseClient) return DEFAULT_ROLES;
            
            const { data, error } = await supabaseClient
                .from('roles')
                .select('name, rank')
                .order('rank', { ascending: true });
            
            if (error || !data || data.length === 0) {
                // If no roles table or empty, use defaults
                return DEFAULT_ROLES;
            }
            return data.map(r => r.name);
        }

        async function addClient(clientName) {
            if (!supabaseClient || !clientName.trim()) return false;
            
            const { error } = await supabaseClient
                .from('clients')
                .insert([{ name: clientName.trim() }]);
            
            if (error) {
                console.error('Error adding client:', error);
                return false;
            }
            
            // Reload clients
            CLIENTS = await loadClients();
            updateClientDropdowns();
            return true;
        }

        async function addRole(roleName) {
            if (!supabaseClient || !roleName.trim()) return false;
            
            // Add at the end of the hierarchy
            const newRank = ROLES.length;
            
            const { error } = await supabaseClient
                .from('roles')
                .insert([{ name: roleName.trim(), rank: newRank }]);
            
            if (error) {
                console.error('Error adding role:', error);
                return false;
            }
            
            // Reload roles
            ROLES = await loadRoles();
            return true;
        }

        function updateClientDropdowns() {
            // Update filter dropdown
            const filterDropdown = document.getElementById('clientFilter');
            if (filterDropdown) {
                const currentValue = filterDropdown.value;
                filterDropdown.innerHTML = '<option value="all">All Clients</option>' +
                    CLIENTS.map(c => `<option value="${c}">${c}</option>`).join('');
                filterDropdown.value = currentValue;
            }
        }

        // Load data from Supabase
        async function loadTechnicians() {
            if (!supabaseClient) {
                console.error('Supabase not initialized');
                return [];
            }
            const { data, error } = await supabaseClient
                .from('technicians')
                .select('*')
                .order('workstream', { ascending: true })
                .order('name', { ascending: true });
            
            if (error) {
                console.error('Error loading technicians:', error);
                return [];
            }
            return data || [];
        }

        async function loadScheduleEntries(startDate, endDate) {
            if (!supabaseClient) {
                console.error('Supabase not initialized');
                return [];
            }
            const { data, error } = await supabaseClient
                .from('schedule_entries')
                .select('*')
                .gte('date', startDate.toISOString().split('T')[0])
                .lte('date', endDate.toISOString().split('T')[0]);
            
            if (error) {
                console.error('Error loading schedule:', error);
                return [];
            }
            return data || [];
        }

        // Transform Supabase data to app format
        function buildScheduleData(technicians, entries) {
            return technicians.map(tech => {
                const schedule = {};
                
                // Initialize all days
                for (let i = 0; i < 7; i++) {
                    schedule[i] = { jobs: [] };
                }
                
                // Build date strings for the week to compare against
                const weekDates = [];
                for (let i = 0; i < 7; i++) {
                    const d = new Date(currentWeekStart);
                    d.setDate(d.getDate() + i);
                    weekDates.push(toLocalDateString(d));
                }
                
                // Group entries by day
                entries
                    .filter(e => e.technician_id === tech.id)
                    .forEach(entry => {
                        // entry.date comes as YYYY-MM-DD string from database
                        const entryDateStr = entry.date.split('T')[0]; // Handle if it has time component
                        const dayIndex = weekDates.indexOf(entryDateStr);
                        
                        if (dayIndex >= 0 && dayIndex < 7) {
                            if (entry.entry_type === 'status') {
                                schedule[dayIndex] = { 
                                    status: entry.status_type, 
                                    text: entry.status_text 
                                };
                            } else if (entry.entry_type === 'job') {
                                if (!schedule[dayIndex].jobs) {
                                    schedule[dayIndex] = { jobs: [] };
                                }
                                schedule[dayIndex].jobs.push({
                                    q: entry.q_number,
                                    client: entry.client,
                                    location: entry.location,
                                    task: entry.task,
                                    partner: entry.partner,
                                    isNight: entry.is_night || false,
                                    jobStatus: entry.job_status || 'live'
                                });
                            }
                        }
                    });
                
                return {
                    id: tech.id,
                    name: tech.name,
                    role: tech.role,
                    postcode: tech.postcode,
                    workstream: tech.workstream,
                    lineManager: tech.line_manager,
                    schedule
                };
            });
        }

        async function loadAllData() {
            isLoading = true;
            showLoadingState();
            
            const endDate = new Date(currentWeekStart);
            endDate.setDate(endDate.getDate() + 6);
            
            const [technicians, entries, clients, roles] = await Promise.all([
                loadTechnicians(),
                loadScheduleEntries(currentWeekStart, endDate),
                loadClients(),
                loadRoles()
            ]);
            
            CLIENTS = clients;
            ROLES = roles;
            updateClientDropdowns();
            
            TECHNICIANS = buildScheduleData(technicians, entries);
            isLoading = false;
            renderSchedule();
        }

        function showLoadingState() {
            const grid = document.getElementById('scheduleGrid');
            grid.innerHTML = `
                <div style="grid-column: 1 / -1; padding: 3rem; text-align: center; color: var(--text-muted);">
                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚è≥</div>
                    <div>Loading schedule...</div>
                </div>
            `;
        }

        // Auth functions
        async function checkAuth() {
            if (!supabaseClient) return;
            const { data: { session } } = await supabaseClient.auth.getSession();
            currentUser = session?.user || null;
            updateAuthUI();
        }

        async function signIn(email, password) {
            if (!supabaseClient) {
                alert('Database connection not available');
                return false;
            }
            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email,
                password
            });
            
            if (error) {
                alert('Login failed: ' + error.message);
                return false;
            }
            
            currentUser = data.user;
            updateAuthUI();
            return true;
        }

        async function signOut() {
            if (!supabaseClient) return;
            await supabaseClient.auth.signOut();
            currentUser = null;
            updateAuthUI();
        }

        function updateAuthUI() {
            const authBtn = document.getElementById('authBtn');
            const addTechBtn = document.getElementById('addTechBtn');
            const csvUploadBtn = document.getElementById('csvUploadBtn');
            
            if (currentUser) {
                authBtn.innerHTML = `‚úì ${currentUser.email.split('@')[0]}`;
                authBtn.onclick = signOut;
                authBtn.title = 'Click to sign out';
                authBtn.style.background = 'rgba(255,255,255,0.9)';
                authBtn.style.color = 'var(--brand-primary)';
                if (addTechBtn) addTechBtn.style.display = 'flex';
                if (csvUploadBtn) csvUploadBtn.style.display = 'flex';
            } else {
                authBtn.innerHTML = 'üîê Sign In';
                authBtn.onclick = showLoginModal;
                authBtn.title = 'Sign in to edit';
                authBtn.style.background = 'rgba(255,255,255,0.2)';
                authBtn.style.color = 'white';
                if (addTechBtn) addTechBtn.style.display = 'none';
                if (csvUploadBtn) csvUploadBtn.style.display = 'none';
            }
        }

        function showLoginModal() {
            // Create modal
            const overlay = document.createElement('div');
            overlay.id = 'loginOverlay';
            overlay.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.6);
                backdrop-filter: blur(4px);
                z-index: 200;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--bg-secondary);
                border-radius: 1rem;
                padding: 2rem;
                width: 90%;
                max-width: 360px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            `;

            modal.innerHTML = `
                <h2 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; color: var(--text-primary);">Sign In</h2>
                <p style="margin: 0 0 1.5rem 0; font-size: 0.875rem; color: var(--text-muted);">Enter your credentials to edit the schedule</p>
                <form id="loginForm">
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Email</label>
                        <input type="email" id="loginEmail" required style="
                            width: 100%;
                            padding: 0.625rem 0.75rem;
                            border: 1px solid var(--border-color);
                            border-radius: 0.5rem;
                            font-size: 0.875rem;
                            font-family: inherit;
                            background: var(--bg-secondary);
                            color: var(--text-primary);
                            box-sizing: border-box;
                        " placeholder="you@example.com">
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Password</label>
                        <input type="password" id="loginPassword" required style="
                            width: 100%;
                            padding: 0.625rem 0.75rem;
                            border: 1px solid var(--border-color);
                            border-radius: 0.5rem;
                            font-size: 0.875rem;
                            font-family: inherit;
                            background: var(--bg-secondary);
                            color: var(--text-primary);
                            box-sizing: border-box;
                        " placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <div style="display: flex; gap: 0.75rem;">
                        <button type="button" onclick="closeLoginModal()" style="
                            flex: 1;
                            padding: 0.625rem 1rem;
                            border: 1px solid var(--border-color);
                            background: var(--bg-secondary);
                            color: var(--text-primary);
                            border-radius: 0.5rem;
                            font-size: 0.875rem;
                            font-weight: 500;
                            cursor: pointer;
                            font-family: inherit;
                        ">Cancel</button>
                        <button type="submit" style="
                            flex: 1;
                            padding: 0.625rem 1rem;
                            border: none;
                            background: var(--brand-gradient);
                            color: white;
                            border-radius: 0.5rem;
                            font-size: 0.875rem;
                            font-weight: 600;
                            cursor: pointer;
                            font-family: inherit;
                        ">Sign In</button>
                    </div>
                </form>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // Focus email input
            document.getElementById('loginEmail').focus();

            // Handle form submit
            document.getElementById('loginForm').onsubmit = async (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                const success = await signIn(email, password);
                if (success) {
                    closeLoginModal();
                }
            };

            // Close on overlay click
            overlay.onclick = (e) => {
                if (e.target === overlay) closeLoginModal();
            };

            // Close on Escape
            document.addEventListener('keydown', handleLoginEscape);
        }

        function handleLoginEscape(e) {
            if (e.key === 'Escape') closeLoginModal();
        }

        function closeLoginModal() {
            const overlay = document.getElementById('loginOverlay');
            if (overlay) overlay.remove();
            document.removeEventListener('keydown', handleLoginEscape);
        }

        // ==================== CRUD FUNCTIONS ====================

        // Add new technician
        function showAddTechnicianModal() {
            if (!currentUser) {
                alert('Please sign in to add technicians');
                return;
            }
            showTechnicianModal(null);
        }

        // Edit existing technician
        function showEditTechnicianModal(techId) {
            if (!currentUser) {
                alert('Please sign in to edit');
                return;
            }
            const tech = TECHNICIANS.find(t => t.id === techId);
            if (tech) showTechnicianModal(tech);
        }

        function showTechnicianModal(tech = null) {
            const isEdit = tech !== null;
            
            const overlay = document.createElement('div');
            overlay.id = 'techModalOverlay';
            overlay.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.6);
                backdrop-filter: blur(4px);
                z-index: 200;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--bg-secondary);
                border-radius: 1rem;
                padding: 2rem;
                width: 90%;
                max-width: 480px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.2);
                max-height: 90vh;
                overflow-y: auto;
            `;

            const workstreamOptions = ['Project Delivery', 'Clean Water', 'Waste Water', 'Contingent Resources', 'Management & Admin']
                .map(ws => `<option value="${ws}" ${tech?.workstream === ws ? 'selected' : ''}>${ws}</option>`)
                .join('');

            modal.innerHTML = `
                <h2 style="margin: 0 0 1.5rem 0; font-size: 1.25rem; color: var(--text-primary);">${isEdit ? 'Edit Technician' : 'Add New Technician'}</h2>
                <form id="techForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Name *</label>
                            <input type="text" id="techName" required value="${tech?.name || ''}" style="
                                width: 100%;
                                padding: 0.625rem 0.75rem;
                                border: 1px solid var(--border-color);
                                border-radius: 0.5rem;
                                font-size: 0.875rem;
                                font-family: inherit;
                                background: var(--bg-secondary);
                                color: var(--text-primary);
                                box-sizing: border-box;
                            " placeholder="John Smith">
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Role</label>
                            <select id="techRole" onchange="handleRoleChange()" style="
                                width: 100%;
                                padding: 0.625rem 0.75rem;
                                border: 1px solid var(--border-color);
                                border-radius: 0.5rem;
                                font-size: 0.875rem;
                                font-family: inherit;
                                background: var(--bg-secondary);
                                color: var(--text-primary);
                                box-sizing: border-box;
                            ">
                                <option value="">Select role...</option>
                                ${ROLES.map(r => `<option value="${r}" ${tech?.role === r ? 'selected' : ''}>${r}</option>`).join('')}
                                ${tech?.role && !ROLES.includes(tech.role) ? `<option value="${tech.role}" selected>${tech.role}</option>` : ''}
                                <option value="__add_new__">+ Add New Role...</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Postcode</label>
                            <input type="text" id="techPostcode" value="${tech?.postcode || ''}" style="
                                width: 100%;
                                padding: 0.625rem 0.75rem;
                                border: 1px solid var(--border-color);
                                border-radius: 0.5rem;
                                font-size: 0.875rem;
                                font-family: inherit;
                                background: var(--bg-secondary);
                                color: var(--text-primary);
                                box-sizing: border-box;
                            " placeholder="SW1A">
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Line Manager</label>
                            <input type="text" id="techManager" value="${tech?.lineManager || ''}" style="
                                width: 100%;
                                padding: 0.625rem 0.75rem;
                                border: 1px solid var(--border-color);
                                border-radius: 0.5rem;
                                font-size: 0.875rem;
                                font-family: inherit;
                                background: var(--bg-secondary);
                                color: var(--text-primary);
                                box-sizing: border-box;
                            " placeholder="Manager Name">
                        </div>
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Workstream *</label>
                        <select id="techWorkstream" required style="
                            width: 100%;
                            padding: 0.625rem 0.75rem;
                            border: 1px solid var(--border-color);
                            border-radius: 0.5rem;
                            font-size: 0.875rem;
                            font-family: inherit;
                            background: var(--bg-secondary);
                            color: var(--text-primary);
                            box-sizing: border-box;
                        ">
                            <option value="">Select workstream...</option>
                            ${workstreamOptions}
                        </select>
                    </div>
                    <div style="display: flex; gap: 0.75rem;">
                        ${isEdit ? `<button type="button" onclick="deleteTechnician('${tech.id}')" style="
                            padding: 0.625rem 1rem;
                            border: 1px solid #f43f5e;
                            background: transparent;
                            color: #f43f5e;
                            border-radius: 0.5rem;
                            font-size: 0.875rem;
                            font-weight: 500;
                            cursor: pointer;
                            font-family: inherit;
                        ">Delete</button>` : ''}
                        <div style="flex: 1;"></div>
                        <button type="button" onclick="closeTechModal()" style="
                            padding: 0.625rem 1rem;
                            border: 1px solid var(--border-color);
                            background: var(--bg-secondary);
                            color: var(--text-primary);
                            border-radius: 0.5rem;
                            font-size: 0.875rem;
                            font-weight: 500;
                            cursor: pointer;
                            font-family: inherit;
                        ">Cancel</button>
                        <button type="submit" style="
                            padding: 0.625rem 1.25rem;
                            border: none;
                            background: var(--brand-gradient);
                            color: white;
                            border-radius: 0.5rem;
                            font-size: 0.875rem;
                            font-weight: 600;
                            cursor: pointer;
                            font-family: inherit;
                        ">${isEdit ? 'Save Changes' : 'Add Technician'}</button>
                    </div>
                </form>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            document.getElementById('techName').focus();

            document.getElementById('techForm').onsubmit = async (e) => {
                e.preventDefault();
                await saveTechnician(tech?.id);
            };

            overlay.onclick = (e) => {
                if (e.target === overlay) closeTechModal();
            };
        }

        function closeTechModal() {
            const overlay = document.getElementById('techModalOverlay');
            if (overlay) overlay.remove();
        }

        function handleRoleChange() {
            const roleSelect = document.getElementById('techRole');
            
            if (roleSelect.value === '__add_new__') {
                const newRole = prompt('Enter new role name:');
                if (newRole && newRole.trim()) {
                    addRole(newRole.trim()).then(success => {
                        if (success) {
                            // Add the new option to the current dropdown
                            const option = document.createElement('option');
                            option.value = newRole.trim();
                            option.textContent = newRole.trim();
                            roleSelect.insertBefore(option, roleSelect.querySelector('option[value="__add_new__"]'));
                            roleSelect.value = newRole.trim();
                        } else {
                            roleSelect.value = '';
                        }
                    });
                } else {
                    roleSelect.value = '';
                }
            }
        }

        async function saveTechnician(techId = null) {
            const techData = {
                name: document.getElementById('techName').value,
                role: document.getElementById('techRole').value,
                postcode: document.getElementById('techPostcode').value,
                line_manager: document.getElementById('techManager').value,
                workstream: document.getElementById('techWorkstream').value
            };

            let error;
            if (techId) {
                // Update existing
                const result = await supabaseClient
                    .from('technicians')
                    .update(techData)
                    .eq('id', techId);
                error = result.error;
            } else {
                // Insert new
                const result = await supabaseClient
                    .from('technicians')
                    .insert([techData]);
                error = result.error;
            }

            if (error) {
                alert('Error saving technician: ' + error.message);
                return;
            }

            closeTechModal();
            closePanel();
            await loadAllData();
        }

        async function deleteTechnician(techId) {
            if (!confirm('Are you sure you want to delete this technician? This will also delete all their schedule entries.')) {
                return;
            }

            const { error } = await supabaseClient
                .from('technicians')
                .delete()
                .eq('id', techId);

            if (error) {
                alert('Error deleting technician: ' + error.message);
                return;
            }

            closeTechModal();
            closePanel();
            await loadAllData();
        }

        // ==================== SCHEDULE ENTRY CRUD ====================

        function showAddEntryModal(techId, dayIndex, isNightWork = false) {
            if (!currentUser) {
                alert('Please sign in to edit the schedule');
                return;
            }
            showEntryModal(techId, dayIndex, null, false, isNightWork);
        }

        function showEditEntryModal(techId, dayIndex, entryType = 'job') {
            if (!currentUser) {
                alert('Please sign in to edit');
                return;
            }
            const tech = TECHNICIANS.find(t => t.id === techId);
            const dayData = tech?.schedule[dayIndex];
            showEntryModal(techId, dayIndex, dayData, true);
        }

        function showEntryModal(techId, dayIndex, existingData = null, isEditMode = false, isNightWork = false) {
            const tech = TECHNICIANS.find(t => t.id === techId);
            if (!tech) return;

            const date = new Date(currentWeekStart);
            date.setDate(date.getDate() + dayIndex);
            // Use local date format to avoid timezone issues
            const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;

            const isStatus = existingData?.status || false;
            const existingIsNight = existingData?.jobs?.[0]?.isNight || false;
            
            // Build partner dropdown from current technicians
            const partnerOptions = TECHNICIANS
                .filter(t => t.id !== techId)
                .map(t => `<option value="${t.name}">${t.name}</option>`)
                .join('');
            
            const overlay = document.createElement('div');
            overlay.id = 'entryModalOverlay';
            overlay.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.6);
                backdrop-filter: blur(4px);
                z-index: 200;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            const modal = document.createElement('div');
            modal.id = 'entryModal';
            modal.style.cssText = `
                background: var(--bg-secondary);
                border-radius: 1rem;
                padding: 2rem;
                width: 90%;
                max-width: 480px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                max-height: 90vh;
                overflow-y: auto;
            `;

            const statusOptions = Object.entries(STATUS_CONFIG)
                .filter(([key]) => key !== 'night') // Remove night from status options
                .map(([key, val]) => `<option value="${key}" ${existingData?.status === key ? 'selected' : ''}>${val.icon} ${val.label}</option>`)
                .join('');

            const clientOptions = CLIENTS
                .map(c => `<option value="${c}">${c}</option>`)
                .join('') + '<option value="__add_new__">+ Add New Client...</option>';

            const titleText = isEditMode ? 'Edit Entry' : 'Add Entry';

            modal.innerHTML = `
                <h2 style="margin: 0 0 0.25rem 0; font-size: 1.25rem; color: var(--text-primary);">${titleText}</h2>
                <p style="margin: 0 0 1.5rem 0; font-size: 0.875rem; color: var(--text-muted);">${tech.name} - ${formatDate(date).full}</p>
                
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
                    <button type="button" id="tabJob" onclick="switchEntryTab('job')" style="
                        flex: 1;
                        padding: 0.625rem 1rem;
                        border: 1px solid var(--border-color);
                        background: ${!isStatus ? 'var(--brand-primary)' : 'var(--bg-secondary)'};
                        color: ${!isStatus ? 'white' : 'var(--text-primary)'};
                        border-radius: 0.5rem;
                        font-size: 0.875rem;
                        font-weight: 500;
                        cursor: pointer;
                        font-family: inherit;
                    ">Job</button>
                    <button type="button" id="tabStatus" onclick="switchEntryTab('status')" style="
                        flex: 1;
                        padding: 0.625rem 1rem;
                        border: 1px solid var(--border-color);
                        background: ${isStatus ? 'var(--brand-primary)' : 'var(--bg-secondary)'};
                        color: ${isStatus ? 'white' : 'var(--text-primary)'};
                        border-radius: 0.5rem;
                        font-size: 0.875rem;
                        font-weight: 500;
                        cursor: pointer;
                        font-family: inherit;
                    ">Status</button>
                </div>

                <form id="entryForm">
                    <input type="hidden" id="entryTechId" value="${techId}">
                    <input type="hidden" id="entryDate" value="${dateStr}">
                    <input type="hidden" id="entryDayIndex" value="${dayIndex}">
                    <input type="hidden" id="entryIsEditMode" value="${isEditMode}">
                    
                    <div id="jobFields" style="display: ${!isStatus ? 'block' : 'none'};">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: ${existingIsNight ? '#312e81' : 'var(--bg-tertiary)'}; border-radius: 0.5rem; border: 1px solid ${existingIsNight ? '#6366f1' : 'var(--border-color)'};" id="nightWorkLabel">
                                <input type="checkbox" id="entryIsNight" ${existingIsNight ? 'checked' : ''} onchange="toggleNightWorkStyle()" style="width: 1rem; height: 1rem; accent-color: #6366f1;">
                                <span style="font-size: 1rem;">üåô</span>
                                <span style="font-size: 0.875rem; font-weight: 500; color: ${existingIsNight ? '#a5b4fc' : 'var(--text-primary)'};" id="nightWorkText">Night Work</span>
                            </label>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Q Number</label>
                                <input type="text" id="entryQNumber" value="${existingData?.jobs?.[0]?.q || ''}" style="
                                    width: 100%;
                                    padding: 0.625rem 0.75rem;
                                    border: 1px solid var(--border-color);
                                    border-radius: 0.5rem;
                                    font-size: 0.875rem;
                                    font-family: inherit;
                                    background: var(--bg-secondary);
                                    color: var(--text-primary);
                                    box-sizing: border-box;
                                " placeholder="Q12345">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Client</label>
                                <select id="entryClient" onchange="toggleOtherClient()" style="
                                    width: 100%;
                                    padding: 0.625rem 0.75rem;
                                    border: 1px solid var(--border-color);
                                    border-radius: 0.5rem;
                                    font-size: 0.875rem;
                                    font-family: inherit;
                                    background: var(--bg-secondary);
                                    color: var(--text-primary);
                                    box-sizing: border-box;
                                ">
                                    <option value="">Select...</option>
                                    ${clientOptions}
                                </select>
                            </div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Location</label>
                            <input type="text" id="entryLocation" value="${existingData?.jobs?.[0]?.location || ''}" style="
                                width: 100%;
                                padding: 0.625rem 0.75rem;
                                border: 1px solid var(--border-color);
                                border-radius: 0.5rem;
                                font-size: 0.875rem;
                                font-family: inherit;
                                background: var(--bg-secondary);
                                color: var(--text-primary);
                                box-sizing: border-box;
                            " placeholder="Site name or address">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Task</label>
                                <input type="text" id="entryTask" value="${existingData?.jobs?.[0]?.task || ''}" style="
                                    width: 100%;
                                    padding: 0.625rem 0.75rem;
                                    border: 1px solid var(--border-color);
                                    border-radius: 0.5rem;
                                    font-size: 0.875rem;
                                    font-family: inherit;
                                    background: var(--bg-secondary);
                                    color: var(--text-primary);
                                    box-sizing: border-box;
                                " placeholder="What are they doing?">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Partner</label>
                                <select id="entryPartner" style="
                                    width: 100%;
                                    padding: 0.625rem 0.75rem;
                                    border: 1px solid var(--border-color);
                                    border-radius: 0.5rem;
                                    font-size: 0.875rem;
                                    font-family: inherit;
                                    background: var(--bg-secondary);
                                    color: var(--text-primary);
                                    box-sizing: border-box;
                                ">
                                    <option value="">None</option>
                                    ${partnerOptions}
                                </select>
                            </div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Job Status</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <label style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 0.375rem; padding: 0.5rem; border-radius: 0.5rem; cursor: pointer; border: 2px solid ${existingData?.jobs?.[0]?.jobStatus === 'inactive' ? '#ef4444' : 'var(--border-color)'}; background: ${existingData?.jobs?.[0]?.jobStatus === 'inactive' ? 'rgba(239,68,68,0.1)' : 'transparent'};" id="statusInactiveLabel">
                                    <input type="radio" name="jobStatus" value="inactive" ${existingData?.jobs?.[0]?.jobStatus === 'inactive' ? 'checked' : ''} onchange="updateJobStatusStyle()" style="display: none;">
                                    <span style="width: 10px; height: 10px; border-radius: 50%; background: #ef4444;"></span>
                                    <span style="font-size: 0.75rem; font-weight: 500;">Inactive</span>
                                </label>
                                <label style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 0.375rem; padding: 0.5rem; border-radius: 0.5rem; cursor: pointer; border: 2px solid ${existingData?.jobs?.[0]?.jobStatus === 'pending' ? '#f59e0b' : 'var(--border-color)'}; background: ${existingData?.jobs?.[0]?.jobStatus === 'pending' ? 'rgba(245,158,11,0.1)' : 'transparent'};" id="statusPendingLabel">
                                    <input type="radio" name="jobStatus" value="pending" ${existingData?.jobs?.[0]?.jobStatus === 'pending' ? 'checked' : ''} onchange="updateJobStatusStyle()" style="display: none;">
                                    <span style="width: 10px; height: 10px; border-radius: 50%; background: #f59e0b;"></span>
                                    <span style="font-size: 0.75rem; font-weight: 500;">Pending</span>
                                </label>
                                <label style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 0.375rem; padding: 0.5rem; border-radius: 0.5rem; cursor: pointer; border: 2px solid ${(existingData?.jobs?.[0]?.jobStatus === 'live' || !existingData?.jobs?.[0]?.jobStatus) ? '#22c55e' : 'var(--border-color)'}; background: ${(existingData?.jobs?.[0]?.jobStatus === 'live' || !existingData?.jobs?.[0]?.jobStatus) ? 'rgba(34,197,94,0.1)' : 'transparent'};" id="statusLiveLabel">
                                    <input type="radio" name="jobStatus" value="live" ${(existingData?.jobs?.[0]?.jobStatus === 'live' || !existingData?.jobs?.[0]?.jobStatus) ? 'checked' : ''} onchange="updateJobStatusStyle()" style="display: none;">
                                    <span style="width: 10px; height: 10px; border-radius: 50%; background: #22c55e;"></span>
                                    <span style="font-size: 0.75rem; font-weight: 500;">Live</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div id="statusFields" style="display: ${isStatus ? 'block' : 'none'};">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Status Type</label>
                            <select id="entryStatusType" style="
                                width: 100%;
                                padding: 0.625rem 0.75rem;
                                border: 1px solid var(--border-color);
                                border-radius: 0.5rem;
                                font-size: 0.875rem;
                                font-family: inherit;
                                background: var(--bg-secondary);
                                color: var(--text-primary);
                                box-sizing: border-box;
                            ">
                                <option value="">Select status...</option>
                                ${statusOptions}
                            </select>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Notes (optional)</label>
                            <input type="text" id="entryStatusText" value="${existingData?.text || ''}" style="
                                width: 100%;
                                padding: 0.625rem 0.75rem;
                                border: 1px solid var(--border-color);
                                border-radius: 0.5rem;
                                font-size: 0.875rem;
                                font-family: inherit;
                                background: var(--bg-secondary);
                                color: var(--text-primary);
                                box-sizing: border-box;
                            " placeholder="Additional details...">
                        </div>
                    </div>

                    <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                        ${isEditMode ? `<button type="button" onclick="clearDayEntries('${techId}', ${dayIndex})" style="
                            padding: 0.625rem 1rem;
                            border: 1px solid #f43f5e;
                            background: transparent;
                            color: #f43f5e;
                            border-radius: 0.5rem;
                            font-size: 0.875rem;
                            font-weight: 500;
                            cursor: pointer;
                            font-family: inherit;
                        ">Clear Day</button>` : ''}
                        <div style="flex: 1;"></div>
                        <button type="button" onclick="closeEntryModal()" style="
                            padding: 0.625rem 1rem;
                            border: 1px solid var(--border-color);
                            background: var(--bg-secondary);
                            color: var(--text-primary);
                            border-radius: 0.5rem;
                            font-size: 0.875rem;
                            font-weight: 500;
                            cursor: pointer;
                            font-family: inherit;
                        ">Cancel</button>
                        <button type="submit" style="
                            padding: 0.625rem 1.25rem;
                            border: none;
                            background: var(--brand-gradient);
                            color: white;
                            border-radius: 0.5rem;
                            font-size: 0.875rem;
                            font-weight: 600;
                            cursor: pointer;
                            font-family: inherit;
                        ">Save</button>
                    </div>
                </form>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // Set client value if editing
            if (existingData?.jobs?.[0]?.client) {
                const clientSelect = document.getElementById('entryClient');
                const clientValue = existingData.jobs[0].client;
                // Check if it's in our clients list
                if (CLIENTS.includes(clientValue)) {
                    clientSelect.value = clientValue;
                } else {
                    // Client not in list - might be a legacy value, just set it
                    clientSelect.value = clientValue;
                }
            }

            // Set partner value if editing
            if (existingData?.jobs?.[0]?.partner) {
                document.getElementById('entryPartner').value = existingData.jobs[0].partner;
            }

            document.getElementById('entryForm').onsubmit = async (e) => {
                e.preventDefault();
                await saveEntry();
            };

            overlay.onclick = (e) => {
                if (e.target === overlay) closeEntryModal();
            };
        }

        function toggleNightWorkStyle() {
            const checkbox = document.getElementById('entryIsNight');
            const label = document.getElementById('nightWorkLabel');
            const text = document.getElementById('nightWorkText');
            
            if (checkbox.checked) {
                label.style.background = '#312e81';
                label.style.borderColor = '#6366f1';
                text.style.color = '#a5b4fc';
            } else {
                label.style.background = 'var(--bg-tertiary)';
                label.style.borderColor = 'var(--border-color)';
                text.style.color = 'var(--text-primary)';
            }
        }

        function updateJobStatusStyle() {
            const statuses = ['inactive', 'pending', 'live'];
            const colors = { inactive: '#ef4444', pending: '#f59e0b', live: '#22c55e' };
            
            statuses.forEach(status => {
                const label = document.getElementById(`status${status.charAt(0).toUpperCase() + status.slice(1)}Label`);
                const radio = document.querySelector(`input[name="jobStatus"][value="${status}"]`);
                
                if (radio.checked) {
                    label.style.borderColor = colors[status];
                    label.style.background = `rgba(${status === 'inactive' ? '239,68,68' : status === 'pending' ? '245,158,11' : '34,197,94'},0.1)`;
                } else {
                    label.style.borderColor = 'var(--border-color)';
                    label.style.background = 'transparent';
                }
            });
        }

        function toggleOtherClient() {
            const clientSelect = document.getElementById('entryClient');
            
            if (clientSelect.value === '__add_new__') {
                // Prompt for new client name
                const newClient = prompt('Enter new client name:');
                if (newClient && newClient.trim()) {
                    // Add to database and update dropdowns
                    addClient(newClient.trim()).then(success => {
                        if (success) {
                            // Add the new option to the current dropdown
                            const option = document.createElement('option');
                            option.value = newClient.trim();
                            option.textContent = newClient.trim();
                            clientSelect.insertBefore(option, clientSelect.querySelector('option[value="__add_new__"]'));
                            clientSelect.value = newClient.trim();
                        } else {
                            clientSelect.value = '';
                        }
                    });
                } else {
                    clientSelect.value = '';
                }
            }
        }

        function switchEntryTab(tab) {
            const jobFields = document.getElementById('jobFields');
            const statusFields = document.getElementById('statusFields');
            const tabJob = document.getElementById('tabJob');
            const tabStatus = document.getElementById('tabStatus');

            if (tab === 'job') {
                jobFields.style.display = 'block';
                statusFields.style.display = 'none';
                tabJob.style.background = 'var(--brand-primary)';
                tabJob.style.color = 'white';
                tabStatus.style.background = 'var(--bg-secondary)';
                tabStatus.style.color = 'var(--text-primary)';
            } else {
                jobFields.style.display = 'none';
                statusFields.style.display = 'block';
                tabStatus.style.background = 'var(--brand-primary)';
                tabStatus.style.color = 'white';
                tabJob.style.background = 'var(--bg-secondary)';
                tabJob.style.color = 'var(--text-primary)';
            }
        }

        function closeEntryModal() {
            const overlay = document.getElementById('entryModalOverlay');
            if (overlay) overlay.remove();
        }

        async function saveEntry() {
            const techId = document.getElementById('entryTechId').value;
            const dateStr = document.getElementById('entryDate').value;
            const isEditMode = document.getElementById('entryIsEditMode').value === 'true';

            // Only clear existing entries if we're in edit mode
            if (isEditMode) {
                await supabaseClient
                    .from('schedule_entries')
                    .delete()
                    .eq('technician_id', techId)
                    .eq('date', dateStr);
            }

            const jobFields = document.getElementById('jobFields');
            const isJob = jobFields.style.display !== 'none';

            let entryData;
            
            if (isJob) {
                const qNumber = document.getElementById('entryQNumber').value;
                const client = document.getElementById('entryClient').value;
                const location = document.getElementById('entryLocation').value;
                const task = document.getElementById('entryTask').value;
                const partner = document.getElementById('entryPartner').value;
                const isNight = document.getElementById('entryIsNight').checked;
                const jobStatus = document.querySelector('input[name="jobStatus"]:checked')?.value || 'live';

                if (!qNumber && !location && !task) {
                    closeEntryModal();
                    closePanel();
                    await loadAllData();
                    return;
                }

                entryData = {
                    technician_id: techId,
                    date: dateStr,
                    entry_type: 'job',
                    q_number: qNumber,
                    client: client,
                    location: location,
                    task: task,
                    partner: partner || null,
                    is_night: isNight,
                    job_status: jobStatus
                };
            } else {
                const statusType = document.getElementById('entryStatusType').value;
                const statusText = document.getElementById('entryStatusText').value;

                if (!statusType) {
                    closeEntryModal();
                    closePanel();
                    await loadAllData();
                    return;
                }

                entryData = {
                    technician_id: techId,
                    date: dateStr,
                    entry_type: 'status',
                    status_type: statusType,
                    status_text: statusText || null
                };
            }

            const { error } = await supabaseClient
                .from('schedule_entries')
                .insert([entryData]);

            if (error) {
                alert('Error saving entry: ' + error.message);
                return;
            }

            closeEntryModal();
            closePanel();
            await loadAllData();
        }

        async function clearDayEntries(techId, dayIndex) {
            if (!confirm('Clear all entries for this day?')) return;

            const date = new Date(currentWeekStart);
            date.setDate(date.getDate() + dayIndex);
            const dateStr = toLocalDateString(date);

            const { error } = await supabaseClient
                .from('schedule_entries')
                .delete()
                .eq('technician_id', techId)
                .eq('date', dateStr);

            if (error) {
                alert('Error clearing entries: ' + error.message);
                return;
            }

            closeEntryModal();
            closePanel();
            await loadAllData();
        }

        // ==================== BULK ENTRY ====================

        let bulkEntryState = {
            dayIndex: null,
            dateStr: null,
            statusType: null,
            statusText: null,
            workstream: 'all',
            techsToProcess: [],
            currentTechIndex: 0
        };

        function showBulkEntryModal(dayIndex) {
            if (!currentUser) return;

            const date = new Date(currentWeekStart);
            date.setDate(date.getDate() + dayIndex);
            const dateStr = toLocalDateString(date);

            bulkEntryState.dayIndex = dayIndex;
            bulkEntryState.dateStr = dateStr;

            const overlay = document.createElement('div');
            overlay.id = 'bulkEntryOverlay';
            overlay.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.6);
                backdrop-filter: blur(4px);
                z-index: 200;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--bg-secondary);
                border-radius: 1rem;
                padding: 2rem;
                width: 90%;
                max-width: 400px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            `;

            const workstreamOptions = ['all', 'Project Delivery', 'Clean Water', 'Waste Water', 'Contingent Resources', 'Management & Admin']
                .map(ws => `<option value="${ws}">${ws === 'all' ? 'All Workstreams' : ws}</option>`)
                .join('');

            const bulkStatusOptions = [
                { value: 'leave', label: 'üå¥ Annual Leave' },
                { value: 'training', label: 'üìö Training' },
                { value: 'office', label: 'üè¢ Office' },
                { value: 'sickness', label: 'üè• Sickness' },
                { value: 'wfh', label: 'üè† WFH' },
                { value: 'rest', label: '‚òÄÔ∏è Rest Day' },
                { value: 'bank_holiday', label: 'üéâ Bank Holiday' }
            ].map(s => `<option value="${s.value}">${s.label}</option>`).join('');

            modal.innerHTML = `
                <h2 style="margin: 0 0 0.25rem 0; font-size: 1.25rem; color: var(--text-primary);">Bulk Add Status</h2>
                <p style="margin: 0 0 1.5rem 0; font-size: 0.875rem; color: var(--text-muted);">${formatDate(date).full}</p>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Workstream</label>
                    <select id="bulkWorkstream" style="
                        width: 100%;
                        padding: 0.625rem 0.75rem;
                        border: 1px solid var(--border-color);
                        border-radius: 0.5rem;
                        font-size: 0.875rem;
                        font-family: inherit;
                        background: var(--bg-secondary);
                        color: var(--text-primary);
                        box-sizing: border-box;
                    ">
                        ${workstreamOptions}
                    </select>
                </div>

                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Status</label>
                    <select id="bulkStatusType" style="
                        width: 100%;
                        padding: 0.625rem 0.75rem;
                        border: 1px solid var(--border-color);
                        border-radius: 0.5rem;
                        font-size: 0.875rem;
                        font-family: inherit;
                        background: var(--bg-secondary);
                        color: var(--text-primary);
                        box-sizing: border-box;
                    ">
                        <option value="">Select status...</option>
                        ${bulkStatusOptions}
                    </select>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem;">Notes (optional)</label>
                    <input type="text" id="bulkStatusText" style="
                        width: 100%;
                        padding: 0.625rem 0.75rem;
                        border: 1px solid var(--border-color);
                        border-radius: 0.5rem;
                        font-size: 0.875rem;
                        font-family: inherit;
                        background: var(--bg-secondary);
                        color: var(--text-primary);
                        box-sizing: border-box;
                    " placeholder="e.g. Christmas Day">
                </div>

                <div style="display: flex; gap: 0.75rem; margin-bottom: 0.75rem;">
                    <button type="button" onclick="closeBulkEntryModal()" style="
                        flex: 1;
                        padding: 0.625rem 1rem;
                        border: 1px solid var(--border-color);
                        background: var(--bg-secondary);
                        color: var(--text-primary);
                        border-radius: 0.5rem;
                        font-size: 0.875rem;
                        font-weight: 500;
                        cursor: pointer;
                        font-family: inherit;
                    ">Cancel</button>
                    <button type="button" onclick="startBulkEntry()" style="
                        flex: 1;
                        padding: 0.625rem 1rem;
                        border: none;
                        background: var(--brand-gradient);
                        color: white;
                        border-radius: 0.5rem;
                        font-size: 0.875rem;
                        font-weight: 600;
                        cursor: pointer;
                        font-family: inherit;
                    ">Apply Status</button>
                </div>
                <button type="button" onclick="startBulkClear()" style="
                    width: 100%;
                    padding: 0.625rem 1rem;
                    border: 1px solid #f43f5e;
                    background: rgba(244, 63, 94, 0.1);
                    color: #f43f5e;
                    border-radius: 0.5rem;
                    font-size: 0.875rem;
                    font-weight: 500;
                    cursor: pointer;
                    font-family: inherit;
                ">üóëÔ∏è Clear Day for Selected Workstream</button>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            overlay.onclick = (e) => {
                if (e.target === overlay) closeBulkEntryModal();
            };
        }

        function closeBulkEntryModal() {
            const overlay = document.getElementById('bulkEntryOverlay');
            if (overlay) overlay.remove();
        }

        async function startBulkEntry() {
            const statusType = document.getElementById('bulkStatusType').value;
            if (!statusType) {
                alert('Please select a status');
                return;
            }

            bulkEntryState.statusType = statusType;
            bulkEntryState.statusText = document.getElementById('bulkStatusText').value;
            bulkEntryState.workstream = document.getElementById('bulkWorkstream').value;

            // Get technicians to process
            let techs = TECHNICIANS;
            if (bulkEntryState.workstream !== 'all') {
                techs = techs.filter(t => t.workstream === bulkEntryState.workstream);
            }

            bulkEntryState.techsToProcess = techs;
            bulkEntryState.currentTechIndex = 0;

            closeBulkEntryModal();
            await processNextBulkEntry();
        }

        async function startBulkClear() {
            const workstream = document.getElementById('bulkWorkstream').value;
            const workstreamLabel = workstream === 'all' ? 'ALL technicians' : `all ${workstream} technicians`;
            
            if (!confirm(`Are you sure you want to clear all entries for ${workstreamLabel} on this day?\n\nThis cannot be undone.`)) {
                return;
            }

            // Get technicians to clear
            let techs = TECHNICIANS;
            if (workstream !== 'all') {
                techs = techs.filter(t => t.workstream === workstream);
            }

            const techIds = techs.map(t => t.id);
            
            const { error } = await supabaseClient
                .from('schedule_entries')
                .delete()
                .eq('date', bulkEntryState.dateStr)
                .in('technician_id', techIds);

            if (error) {
                alert('Error clearing entries: ' + error.message);
                return;
            }

            closeBulkEntryModal();
            await loadAllData();
            alert(`Cleared entries for ${techs.length} technician(s)`);
        }

        async function processNextBulkEntry() {
            if (bulkEntryState.currentTechIndex >= bulkEntryState.techsToProcess.length) {
                // All done
                await loadAllData();
                return;
            }

            const tech = bulkEntryState.techsToProcess[bulkEntryState.currentTechIndex];
            const dayData = tech.schedule[bulkEntryState.dayIndex];
            const hasExistingData = dayData?.status || (dayData?.jobs && dayData.jobs.length > 0);

            if (hasExistingData) {
                // Show conflict modal
                showConflictModal(tech, dayData);
            } else {
                // No conflict, just add
                await addBulkEntryForTech(tech.id);
                bulkEntryState.currentTechIndex++;
                await processNextBulkEntry();
            }
        }

        function showConflictModal(tech, dayData) {
            const overlay = document.createElement('div');
            overlay.id = 'conflictOverlay';
            overlay.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.6);
                backdrop-filter: blur(4px);
                z-index: 210;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--bg-secondary);
                border-radius: 1rem;
                padding: 2rem;
                width: 90%;
                max-width: 400px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            `;

            // Describe existing entry
            let existingDesc = '';
            if (dayData.status) {
                const config = STATUS_CONFIG[dayData.status];
                existingDesc = `<div style="padding: 0.75rem; background: var(--bg-tertiary); border-radius: 0.5rem; margin-bottom: 1rem;">
                    <span style="font-size: 1.25rem;">${config?.icon || 'üìã'}</span>
                    <span style="margin-left: 0.5rem;">${dayData.text || config?.label || dayData.status}</span>
                </div>`;
            } else if (dayData.jobs && dayData.jobs.length > 0) {
                existingDesc = `<div style="padding: 0.75rem; background: var(--bg-tertiary); border-radius: 0.5rem; margin-bottom: 1rem;">
                    <strong>${dayData.jobs.length} job(s):</strong><br>
                    ${dayData.jobs.map(j => `‚Ä¢ ${j.q} - ${j.location}`).join('<br>')}
                </div>`;
            }

            const remaining = bulkEntryState.techsToProcess.length - bulkEntryState.currentTechIndex - 1;

            modal.innerHTML = `
                <h2 style="margin: 0 0 0.25rem 0; font-size: 1.25rem; color: var(--text-primary);">Conflict Found</h2>
                <p style="margin: 0 0 1rem 0; font-size: 0.875rem; color: var(--text-muted);">${tech.name} already has an entry</p>
                
                ${existingDesc}
                
                <p style="font-size: 0.8125rem; color: var(--text-muted); margin-bottom: 1rem;">${remaining} more technician${remaining !== 1 ? 's' : ''} remaining</p>

                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button type="button" onclick="handleConflict('replace')" style="
                        flex: 1;
                        min-width: 100px;
                        padding: 0.625rem 0.75rem;
                        border: 1px solid #f59e0b;
                        background: rgba(245,158,11,0.1);
                        color: #f59e0b;
                        border-radius: 0.5rem;
                        font-size: 0.8125rem;
                        font-weight: 500;
                        cursor: pointer;
                        font-family: inherit;
                    ">Replace</button>
                    <button type="button" onclick="handleConflict('skip')" style="
                        flex: 1;
                        min-width: 100px;
                        padding: 0.625rem 0.75rem;
                        border: 1px solid var(--border-color);
                        background: var(--bg-secondary);
                        color: var(--text-primary);
                        border-radius: 0.5rem;
                        font-size: 0.8125rem;
                        font-weight: 500;
                        cursor: pointer;
                        font-family: inherit;
                    ">Skip</button>
                    <button type="button" onclick="handleConflict('replaceAll')" style="
                        flex: 1;
                        min-width: 100px;
                        padding: 0.625rem 0.75rem;
                        border: none;
                        background: #f59e0b;
                        color: white;
                        border-radius: 0.5rem;
                        font-size: 0.8125rem;
                        font-weight: 600;
                        cursor: pointer;
                        font-family: inherit;
                    ">Replace All</button>
                    <button type="button" onclick="handleConflict('skipAll')" style="
                        flex: 1;
                        min-width: 100px;
                        padding: 0.625rem 0.75rem;
                        border: 1px solid var(--border-color);
                        background: var(--bg-tertiary);
                        color: var(--text-secondary);
                        border-radius: 0.5rem;
                        font-size: 0.8125rem;
                        font-weight: 500;
                        cursor: pointer;
                        font-family: inherit;
                    ">Skip All</button>
                </div>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }

        function closeConflictModal() {
            const overlay = document.getElementById('conflictOverlay');
            if (overlay) overlay.remove();
        }

        async function handleConflict(action) {
            closeConflictModal();

            const tech = bulkEntryState.techsToProcess[bulkEntryState.currentTechIndex];

            if (action === 'replace') {
                await deleteTechDayEntries(tech.id);
                await addBulkEntryForTech(tech.id);
                bulkEntryState.currentTechIndex++;
                await processNextBulkEntry();
            } else if (action === 'skip') {
                bulkEntryState.currentTechIndex++;
                await processNextBulkEntry();
            } else if (action === 'replaceAll') {
                // Replace this one and all remaining conflicts
                await deleteTechDayEntries(tech.id);
                await addBulkEntryForTech(tech.id);
                bulkEntryState.currentTechIndex++;
                
                // Process remaining with auto-replace
                while (bulkEntryState.currentTechIndex < bulkEntryState.techsToProcess.length) {
                    const t = bulkEntryState.techsToProcess[bulkEntryState.currentTechIndex];
                    await deleteTechDayEntries(t.id);
                    await addBulkEntryForTech(t.id);
                    bulkEntryState.currentTechIndex++;
                }
                await loadAllData();
            } else if (action === 'skipAll') {
                // Skip this one and all remaining conflicts
                bulkEntryState.currentTechIndex++;
                
                // Process remaining, skipping any with existing data
                while (bulkEntryState.currentTechIndex < bulkEntryState.techsToProcess.length) {
                    const t = bulkEntryState.techsToProcess[bulkEntryState.currentTechIndex];
                    const dayData = t.schedule[bulkEntryState.dayIndex];
                    const hasData = dayData?.status || (dayData?.jobs && dayData.jobs.length > 0);
                    
                    if (!hasData) {
                        await addBulkEntryForTech(t.id);
                    }
                    bulkEntryState.currentTechIndex++;
                }
                await loadAllData();
            }
        }

        async function deleteTechDayEntries(techId) {
            await supabaseClient
                .from('schedule_entries')
                .delete()
                .eq('technician_id', techId)
                .eq('date', bulkEntryState.dateStr);
        }

        async function addBulkEntryForTech(techId) {
            const entryData = {
                technician_id: techId,
                date: bulkEntryState.dateStr,
                entry_type: 'status',
                status_type: bulkEntryState.statusType,
                status_text: bulkEntryState.statusText || null
            };

            await supabaseClient
                .from('schedule_entries')
                .insert([entryData]);
        }

        // ==================== COPY PREVIOUS ====================

        async function findPreviousDayData(techId, currentDayIndex) {
            const tech = TECHNICIANS.find(t => t.id === techId);
            if (!tech) return null;

            // First check days before in current week (going backwards)
            for (let i = currentDayIndex - 1; i >= 0; i--) {
                const dayData = tech.schedule[i];
                if ((dayData?.jobs?.length > 0) || dayData?.status) {
                    return { dayIndex: i, data: dayData, fromPreviousWeek: false };
                }
            }

            // If nothing found, check previous week from database
            const prevWeekStart = new Date(currentWeekStart);
            prevWeekStart.setDate(prevWeekStart.getDate() - 7);
            const prevWeekEnd = new Date(currentWeekStart);
            prevWeekEnd.setDate(prevWeekEnd.getDate() - 1);

            const { data: prevEntries, error } = await supabaseClient
                .from('schedule_entries')
                .select('*')
                .eq('technician_id', techId)
                .gte('date', toLocalDateString(prevWeekStart))
                .lte('date', toLocalDateString(prevWeekEnd))
                .order('date', { ascending: false });

            if (error || !prevEntries || prevEntries.length === 0) {
                return null;
            }

            // Group by date and return the most recent day's data
            const entriesByDate = {};
            prevEntries.forEach(entry => {
                const dateStr = entry.date.split('T')[0];
                if (!entriesByDate[dateStr]) {
                    entriesByDate[dateStr] = { jobs: [] };
                }
                if (entry.entry_type === 'status') {
                    entriesByDate[dateStr] = { status: entry.status_type, text: entry.status_text };
                } else if (entry.entry_type === 'job') {
                    entriesByDate[dateStr].jobs.push({
                        q: entry.q_number,
                        client: entry.client,
                        location: entry.location,
                        task: entry.task,
                        partner: entry.partner,
                        isNight: entry.is_night || false,
                        jobStatus: entry.job_status || 'live'
                    });
                }
            });

            // Get most recent date with data
            const dates = Object.keys(entriesByDate).sort().reverse();
            if (dates.length > 0) {
                return { dateStr: dates[0], data: entriesByDate[dates[0]], fromPreviousWeek: true };
            }

            return null;
        }

        async function copyPreviousEntry(techId, dayIndex) {
            const previous = await findPreviousDayData(techId, dayIndex);
            if (!previous) {
                alert('No previous entry found to copy');
                return;
            }

            const date = new Date(currentWeekStart);
            date.setDate(date.getDate() + dayIndex);
            const dateStr = toLocalDateString(date);

            const entriesToInsert = [];

            if (previous.data.status) {
                // Copy status
                entriesToInsert.push({
                    technician_id: techId,
                    date: dateStr,
                    entry_type: 'status',
                    status_type: previous.data.status,
                    status_text: previous.data.text || null
                });
            } else if (previous.data.jobs && previous.data.jobs.length > 0) {
                // Copy ALL jobs from that day
                for (const job of previous.data.jobs) {
                    entriesToInsert.push({
                        technician_id: techId,
                        date: dateStr,
                        entry_type: 'job',
                        q_number: job.q,
                        client: job.client,
                        location: job.location,
                        task: job.task,
                        partner: job.partner || null,
                        is_night: job.isNight || false,
                        job_status: job.jobStatus || 'live'
                    });
                }
            }

            if (entriesToInsert.length === 0) {
                alert('No entries to copy');
                return;
            }

            const { error } = await supabaseClient
                .from('schedule_entries')
                .insert(entriesToInsert);

            if (error) {
                alert('Error copying entries: ' + error.message);
                return;
            }

            closePanel();
            await loadAllData();
        }

        // Check if there's any previous entry (for showing copy button)
        function hasPreviousEntry(techId, currentDayIndex) {
            const tech = TECHNICIANS.find(t => t.id === techId);
            if (!tech) return false;

            // Check days before in current week
            for (let i = currentDayIndex - 1; i >= 0; i--) {
                const dayData = tech.schedule[i];
                if ((dayData?.jobs?.length > 0) || dayData?.status) {
                    return true;
                }
            }
            
            // For now, also show if it's Monday (could have data from last week)
            // The actual check happens async when they click copy
            if (currentDayIndex === 0) {
                return true; // Show button, will check previous week when clicked
            }

            return false;
        }

        // ==================== CSV UPLOAD ====================

        function showCSVModal() {
            if (!currentUser) return;

            const overlay = document.createElement('div');
            overlay.id = 'csvModalOverlay';
            overlay.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.6);
                backdrop-filter: blur(4px);
                z-index: 200;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            const modal = document.createElement('div');
            modal.style.cssText = `
                background: var(--bg-secondary);
                border-radius: 1rem;
                padding: 2rem;
                width: 90%;
                max-width: 500px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            `;

            modal.innerHTML = `
                <h2 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; color: var(--text-primary);">CSV Upload</h2>
                <p style="margin: 0 0 1.5rem 0; font-size: 0.875rem; color: var(--text-muted);">Bulk upload technicians or schedule entries</p>
                
                <div style="display: grid; gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="padding: 1.25rem; border: 1px solid var(--border-color); border-radius: 0.75rem; background: var(--bg-tertiary);">
                        <h3 style="margin: 0 0 0.5rem 0; font-size: 1rem; color: var(--text-primary);">üìã Technicians</h3>
                        <p style="margin: 0 0 1rem 0; font-size: 0.8125rem; color: var(--text-muted);">Upload names, roles, postcodes, managers, workstreams</p>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="downloadTechTemplate()" style="
                                flex: 1;
                                padding: 0.5rem;
                                border: 1px solid var(--border-color);
                                background: var(--bg-secondary);
                                color: var(--text-primary);
                                border-radius: 0.5rem;
                                font-size: 0.75rem;
                                cursor: pointer;
                                font-family: inherit;
                            ">‚¨áÔ∏è Template</button>
                            <label style="
                                flex: 1;
                                padding: 0.5rem;
                                border: none;
                                background: var(--brand-gradient);
                                color: white;
                                border-radius: 0.5rem;
                                font-size: 0.75rem;
                                cursor: pointer;
                                font-family: inherit;
                                text-align: center;
                                font-weight: 500;
                            ">
                                ‚¨ÜÔ∏è Upload
                                <input type="file" accept=".csv" onchange="uploadTechCSV(this)" style="display: none;">
                            </label>
                        </div>
                    </div>

                    <div style="padding: 1.25rem; border: 1px solid var(--border-color); border-radius: 0.75rem; background: var(--bg-tertiary);">
                        <h3 style="margin: 0 0 0.5rem 0; font-size: 1rem; color: var(--text-primary);">üìÖ Schedule Entries</h3>
                        <p style="margin: 0 0 1rem 0; font-size: 0.8125rem; color: var(--text-muted);">Upload jobs with dates, locations, tasks, partners</p>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="downloadScheduleTemplate()" style="
                                flex: 1;
                                padding: 0.5rem;
                                border: 1px solid var(--border-color);
                                background: var(--bg-secondary);
                                color: var(--text-primary);
                                border-radius: 0.5rem;
                                font-size: 0.75rem;
                                cursor: pointer;
                                font-family: inherit;
                            ">‚¨áÔ∏è Template</button>
                            <label style="
                                flex: 1;
                                padding: 0.5rem;
                                border: none;
                                background: var(--brand-gradient);
                                color: white;
                                border-radius: 0.5rem;
                                font-size: 0.75rem;
                                cursor: pointer;
                                font-family: inherit;
                                text-align: center;
                                font-weight: 500;
                            ">
                                ‚¨ÜÔ∏è Upload
                                <input type="file" accept=".csv" onchange="uploadScheduleCSV(this)" style="display: none;">
                            </label>
                        </div>
                    </div>
                </div>

                <button onclick="closeCSVModal()" style="
                    width: 100%;
                    padding: 0.625rem 1rem;
                    border: 1px solid var(--border-color);
                    background: var(--bg-secondary);
                    color: var(--text-primary);
                    border-radius: 0.5rem;
                    font-size: 0.875rem;
                    font-weight: 500;
                    cursor: pointer;
                    font-family: inherit;
                ">Close</button>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            overlay.onclick = (e) => {
                if (e.target === overlay) closeCSVModal();
            };
        }

        function closeCSVModal() {
            const overlay = document.getElementById('csvModalOverlay');
            if (overlay) overlay.remove();
        }

        function downloadTechTemplate() {
            const csv = 'Name,Role,Postcode,Line Manager,Workstream\nJohn Smith,Electrician,SW1A,Jane Doe,Project Delivery\nJane Doe,Operations Manager,E14,,Management/Admin';
            downloadCSV(csv, 'technicians_template.csv');
        }

        function downloadScheduleTemplate() {
            // Get dates for current week in DD/MM/YY format
            const dates = [];
            const isoDateMap = {};
            for (let i = 0; i < 7; i++) {
                const d = new Date(currentWeekStart);
                d.setDate(d.getDate() + i);
                const formatted = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getFullYear()).slice(-2)}`;
                dates.push(formatted);
                isoDateMap[formatted] = d.toISOString().split('T')[0];
            }
            
            const header = 'Field,' + dates.join(',');
            const rows = [
                header,
                'Name,John Smith,John Smith,John Smith,John Smith,John Smith,,',
                'Q Number,Q12345,Q12345,Q12345,Q12345,Q12345,,',
                'Client,Thames Water,Thames Water,Thames Water,Thames Water,Thames Water,,',
                'Location,Beckton STW,Beckton STW,Beckton STW,Beckton STW,Beckton STW,,',
                'Task,Panel Install,Panel Install,Panel Install,Panel Install,Panel Install,,',
                'Partner,,,,,,,',
                'Job Status,live,live,live,live,live,,',
                'Night Work,no,no,no,no,no,,',
                'Name,Jane Doe,Jane Doe,,,,,',
                'Q Number,Q12346,Q12346,,,,,',
                'Client,Southern Water,Southern Water,,,,,',
                'Location,Testwood,Testwood,,,,,',
                'Task,Pump Service,Pump Service,,,,,',
                'Partner,John Smith,John Smith,,,,,',
                'Job Status,pending,pending,,,,,',
                'Night Work,no,no,,,,,'
            ];
            
            const csv = rows.join('\n');
            downloadCSV(csv, 'schedule_template.csv');
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        async function uploadTechCSV(input) {
            const file = input.files[0];
            if (!file) return;

            const text = await file.text();
            const lines = text.trim().split('\n');
            const header = lines[0].toLowerCase();
            
            if (!header.includes('name') || !header.includes('workstream')) {
                alert('Invalid CSV format. Please use the template.');
                return;
            }

            const techs = [];
            for (let i = 1; i < lines.length; i++) {
                const cols = parseCSVLine(lines[i]);
                if (cols.length >= 5 && cols[0].trim()) {
                    techs.push({
                        name: cols[0].trim(),
                        role: cols[1]?.trim() || '',
                        postcode: cols[2]?.trim() || '',
                        line_manager: cols[3]?.trim() || null,
                        workstream: cols[4]?.trim() || 'Project Delivery'
                    });
                }
            }

            if (techs.length === 0) {
                alert('No valid technicians found in CSV');
                return;
            }

            const { error } = await supabaseClient
                .from('technicians')
                .insert(techs);

            if (error) {
                alert('Error uploading technicians: ' + error.message);
                return;
            }

            alert(`Successfully uploaded ${techs.length} technician(s)`);
            closeCSVModal();
            await loadAllData();
        }

        async function uploadScheduleCSV(input) {
            const file = input.files[0];
            if (!file) return;

            const text = await file.text();
            const lines = text.trim().split('\n');
            const headerCols = parseCSVLine(lines[0]);
            
            // First column is "Field", rest are dates
            const dateCols = headerCols.slice(1).map(d => {
                // Parse DD/MM/YY or DD/MM/YYYY format to ISO
                const cleaned = d.trim();
                if (!cleaned) return null;
                
                const parts = cleaned.split('/');
                if (parts.length === 3) {
                    let year = parts[2];
                    if (year.length === 2) year = '20' + year;
                    return `${year}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
                }
                // Try ISO format
                if (cleaned.match(/^\d{4}-\d{2}-\d{2}$/)) return cleaned;
                return null;
            });

            // Get all technicians for name lookup
            const { data: allTechs } = await supabaseClient
                .from('technicians')
                .select('id, name');
            
            const techMap = {};
            allTechs?.forEach(t => techMap[t.name.toLowerCase().trim()] = t.id);

            const entries = [];
            const notFound = new Set();
            
            // Process in groups of 8 rows (one person block)
            let i = 1; // Skip header
            while (i < lines.length) {
                // Read 8 rows for one person
                const block = {};
                const fieldOrder = ['name', 'q_number', 'client', 'location', 'task', 'partner', 'job_status', 'night_work'];
                
                for (let j = 0; j < 8 && (i + j) < lines.length; j++) {
                    const cols = parseCSVLine(lines[i + j]);
                    const fieldName = cols[0]?.toLowerCase().replace(/\s+/g, '_').trim();
                    
                    // Map various field name formats
                    let mappedField = fieldName;
                    if (fieldName === 'qnumber' || fieldName === 'q_number' || fieldName === 'q') mappedField = 'q_number';
                    if (fieldName === 'jobstatus' || fieldName === 'job_status' || fieldName === 'status') mappedField = 'job_status';
                    if (fieldName === 'nightwork' || fieldName === 'night_work' || fieldName === 'night') mappedField = 'night_work';
                    
                    if (fieldOrder.includes(mappedField)) {
                        block[mappedField] = cols.slice(1); // Values for each date
                    }
                }
                
                // Skip if no name found
                if (!block.name || block.name.every(n => !n?.trim())) {
                    i += 8;
                    continue;
                }

                // Process each date column
                for (let col = 0; col < dateCols.length; col++) {
                    const dateStr = dateCols[col];
                    if (!dateStr) continue;
                    
                    const name = block.name?.[col]?.trim();
                    if (!name) continue;
                    
                    const techId = techMap[name.toLowerCase()];
                    if (!techId) {
                        notFound.add(name);
                        continue;
                    }
                    
                    const qNumber = block.q_number?.[col]?.trim();
                    const client = block.client?.[col]?.trim();
                    const location = block.location?.[col]?.trim();
                    const task = block.task?.[col]?.trim();
                    
                    // Skip if no meaningful data for this date
                    if (!qNumber && !location && !task) continue;
                    
                    const partner = block.partner?.[col]?.trim() || null;
                    const jobStatus = block.job_status?.[col]?.trim()?.toLowerCase() || 'live';
                    const isNight = ['yes', 'y', '1', 'true'].includes(block.night_work?.[col]?.trim()?.toLowerCase());
                    
                    entries.push({
                        technician_id: techId,
                        date: dateStr,
                        entry_type: 'job',
                        q_number: qNumber || '',
                        client: client || '',
                        location: location || '',
                        task: task || '',
                        partner: partner,
                        job_status: jobStatus,
                        is_night: isNight
                    });
                }
                
                i += 8;
            }

            if (notFound.size > 0) {
                alert(`Warning: Could not find technicians: ${Array.from(notFound).join(', ')}\n\nMake sure technicians are added first.`);
            }

            if (entries.length === 0) {
                alert('No valid schedule entries found in CSV');
                return;
            }

            const { error } = await supabaseClient
                .from('schedule_entries')
                .insert(entries);

            if (error) {
                alert('Error uploading schedule: ' + error.message);
                return;
            }

            alert(`Successfully uploaded ${entries.length} schedule entry(ies)`);
            closeCSVModal();
            await loadAllData();
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        // Real-time sync
        function setupRealtimeSync() {
            if (!supabaseClient) return;

            // Subscribe to technicians changes
            supabaseClient
                .channel('technicians-changes')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'technicians' },
                    (payload) => {
                        console.log('Technicians changed:', payload);
                        handleTechnicianChange(payload);
                    }
                )
                .subscribe();

            // Subscribe to schedule_entries changes
            supabaseClient
                .channel('schedule-changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'schedule_entries' },
                    (payload) => {
                        console.log('Schedule changed:', payload);
                        handleScheduleChange(payload);
                    }
                )
                .subscribe();
        }

        function handleTechnicianChange(payload) {
            const { eventType, new: newRecord, old: oldRecord } = payload;
            
            if (eventType === 'INSERT') {
                // Add new technician to the list
                const newTech = {
                    id: newRecord.id,
                    name: newRecord.name,
                    role: newRecord.role,
                    postcode: newRecord.postcode,
                    workstream: newRecord.workstream,
                    lineManager: newRecord.line_manager,
                    schedule: {}
                };
                for (let i = 0; i < 7; i++) {
                    newTech.schedule[i] = { jobs: [] };
                }
                TECHNICIANS.push(newTech);
                renderSchedule();
                showUpdateToast('New technician added');
            } else if (eventType === 'UPDATE') {
                // Update existing technician
                const tech = TECHNICIANS.find(t => t.id === newRecord.id);
                if (tech) {
                    tech.name = newRecord.name;
                    tech.role = newRecord.role;
                    tech.postcode = newRecord.postcode;
                    tech.workstream = newRecord.workstream;
                    tech.lineManager = newRecord.line_manager;
                    renderSchedule();
                    showUpdateToast('Technician updated');
                }
            } else if (eventType === 'DELETE') {
                // Remove technician
                const index = TECHNICIANS.findIndex(t => t.id === oldRecord.id);
                if (index !== -1) {
                    TECHNICIANS.splice(index, 1);
                    renderSchedule();
                    showUpdateToast('Technician removed');
                }
            }
        }

        async function handleScheduleChange(payload) {
            const { eventType, new: newRecord, old: oldRecord } = payload;
            
            console.log('Schedule change event:', eventType, 'new:', newRecord, 'old:', oldRecord);
            
            // Get the affected technician and date
            // For DELETE, oldRecord might only have 'id' unless REPLICA IDENTITY FULL is set
            const techId = newRecord?.technician_id || oldRecord?.technician_id;
            const dateStr = (newRecord?.date || oldRecord?.date)?.split('T')[0];
            
            console.log('Parsed techId:', techId, 'dateStr:', dateStr);
            
            // If we don't have techId or dateStr (happens with DELETE if REPLICA IDENTITY not set)
            // Fall back to reloading all data
            if (!techId || !dateStr) {
                console.log('Missing techId or dateStr, doing full reload');
                await loadAllData();
                showUpdateToast('Schedule updated');
                return;
            }
            
            const tech = TECHNICIANS.find(t => t.id === techId);
            if (!tech) {
                console.log('Tech not found, doing full reload');
                await loadAllData();
                return;
            }
            
            // Calculate which day index this affects
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(currentWeekStart);
                d.setDate(d.getDate() + i);
                weekDates.push(toLocalDateString(d));
            }
            const dayIndex = weekDates.indexOf(dateStr);
            
            console.log('Week dates:', weekDates, 'dayIndex:', dayIndex);
            
            // If the change is not in the current week, ignore it
            if (dayIndex < 0 || dayIndex > 6) {
                console.log('Date not in current week, ignoring');
                return;
            }
            
            if (eventType === 'DELETE') {
                // Reload just this day's data for this technician
                await reloadTechnicianDay(tech, dayIndex, dateStr);
                updateCell(tech, dayIndex);
                showUpdateToast('Entry removed');
            } else {
                // INSERT or UPDATE - reload this day's data
                await reloadTechnicianDay(tech, dayIndex, dateStr);
                updateCell(tech, dayIndex);
                showUpdateToast(eventType === 'INSERT' ? 'New entry added' : 'Entry updated');
            }
        }

        async function reloadTechnicianDay(tech, dayIndex, dateStr) {
            // Fetch all entries for this technician on this date
            const { data: entries, error } = await supabaseClient
                .from('schedule_entries')
                .select('*')
                .eq('technician_id', tech.id)
                .eq('date', dateStr);
            
            if (error) {
                console.error('Error reloading day:', error);
                return;
            }
            
            // Reset the day
            tech.schedule[dayIndex] = { jobs: [] };
            
            // Rebuild the day's data
            entries?.forEach(entry => {
                if (entry.entry_type === 'status') {
                    tech.schedule[dayIndex] = { 
                        status: entry.status_type, 
                        text: entry.status_text 
                    };
                } else if (entry.entry_type === 'job') {
                    if (!tech.schedule[dayIndex].jobs) {
                        tech.schedule[dayIndex] = { jobs: [] };
                    }
                    tech.schedule[dayIndex].jobs.push({
                        q: entry.q_number,
                        client: entry.client,
                        location: entry.location,
                        task: entry.task,
                        partner: entry.partner,
                        isNight: entry.is_night || false,
                        jobStatus: entry.job_status || 'live'
                    });
                }
            });
        }

        function updateCell(tech, dayIndex) {
            // Find the specific cell in the DOM and update just that cell
            const rows = document.querySelectorAll('.person-row');
            
            for (const row of rows) {
                const nameEl = row.querySelector('.person-name');
                if (nameEl && nameEl.textContent === tech.name) {
                    // Found the row - now find the right day cell
                    const dayCells = row.querySelectorAll('.day-cell');
                    const cell = dayCells[dayIndex];
                    
                    if (cell) {
                        // Update just this cell's content with a highlight animation
                        cell.innerHTML = renderDayCell(tech.schedule[dayIndex], tech, dayIndex);
                        cell.classList.add('cell-updated');
                        setTimeout(() => cell.classList.remove('cell-updated'), 1500);
                    }
                    break;
                }
            }
        }

        function showUpdateToast(message = 'Schedule updated') {
            // Remove existing toast if any
            const existingToast = document.getElementById('updateToast');
            if (existingToast) existingToast.remove();

            // Create toast
            const toast = document.createElement('div');
            toast.id = 'updateToast';
            toast.innerHTML = `üîÑ ${message}`;
            toast.style.cssText = `
                position: fixed;
                bottom: 2rem;
                right: 2rem;
                background: var(--brand-primary);
                color: white;
                padding: 0.75rem 1.25rem;
                border-radius: 0.5rem;
                font-size: 0.875rem;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(toast);

            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // State - start on current week
        const today = new Date();
        const dayOfWeek = today.getDay();
        let currentWeekStart = new Date(today);
        currentWeekStart.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
        currentWeekStart.setHours(0, 0, 0, 0);
        
        let showWeekends = true;
        let darkMode = false;

        // Dark mode toggle
        function toggleDarkMode() {
            darkMode = !darkMode;
            document.documentElement.setAttribute('data-theme', darkMode ? 'dark' : 'light');
            document.getElementById('toggleDarkMode').classList.toggle('active', darkMode);
            
            // Update icon
            const icon = document.getElementById('darkModeIcon');
            if (darkMode) {
                icon.innerHTML = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
            } else {
                icon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
            }
            
            // Save preference
            localStorage.setItem('darkMode', darkMode);
        }

        // Check for saved dark mode preference
        function initDarkMode() {
            const saved = localStorage.getItem('darkMode');
            if (saved === 'true') {
                toggleDarkMode();
            }
        }

        // Helpers
        function formatDate(date) {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return {
                dayName: days[date.getDay()],
                dayNum: date.getDate(),
                month: months[date.getMonth()],
                full: `${days[date.getDay()]}, ${date.getDate()} ${months[date.getMonth()]}`
            };
        }

        // Convert date to YYYY-MM-DD string in local timezone (avoids DST issues)
        function toLocalDateString(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function getWeekNumber(date) {
            const firstDay = new Date(date.getFullYear(), 0, 1);
            const pastDays = (date - firstDay) / 86400000;
            return Math.ceil((pastDays + firstDay.getDay() + 1) / 7);
        }

        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        // Navigation
        function changeWeek(delta) {
            currentWeekStart.setDate(currentWeekStart.getDate() + (delta * 7));
            loadAllData();
        }

        function goToToday() {
            const today = new Date();
            const day = today.getDay();
            currentWeekStart = new Date(today);
            currentWeekStart.setDate(today.getDate() - (day === 0 ? 6 : day - 1));
            loadAllData();
        }

        function toggleWeekends() {
            showWeekends = !showWeekends;
            document.getElementById('toggleWeekends').classList.toggle('active', showWeekends);
            renderSchedule();
        }

        // Render job cells with smart layout
        function renderDayCell(dayData, tech, dayIndex) {
            if (!dayData) return '';

            // Status entry
            if (dayData.status) {
                const config = STATUS_CONFIG[dayData.status];
                const workClass = config.isWork ? 'work' : 'non-work';
                return `
                    <div class="status-entry ${workClass} status-${dayData.status}" onclick="openPanel('${tech.id}', ${dayIndex})">
                        <span class="status-icon">${config.icon}</span>
                        <span>${dayData.text || config.label}</span>
                    </div>
                `;
            }

            // Jobs
            const jobs = dayData.jobs || [];
            if (jobs.length === 0) return '';

            // Job status colors
            const getJobStatusColor = (status) => {
                switch(status) {
                    case 'inactive': return '#ef4444';
                    case 'pending': return '#f59e0b';
                    case 'live': 
                    default: return '#22c55e';
                }
            };

            // 1-2 jobs: Full display
            if (jobs.length <= 2) {
                return jobs.map(job => {
                    const statusColor = getJobStatusColor(job.jobStatus);
                    const nightBg = job.isNight ? 'background: #312e81;' : '';
                    const borderColor = job.isNight ? '#6366f1' : statusColor;
                    return `
                    <div class="job-entry full ${job.isNight ? 'night-job' : ''}" onclick="openPanel('${tech.id}', ${dayIndex})" style="${nightBg} border-left-color: ${borderColor};">
                        <div class="job-q" style="${job.isNight ? 'color: #a5b4fc;' : ''}">${job.isNight ? 'üåô ' : ''}<span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: ${statusColor}; margin-right: 4px;"></span>${job.q}</div>
                        <div class="job-location" style="${job.isNight ? 'color: #c7d2fe;' : ''}">${job.location}</div>
                        <div class="job-task" style="${job.isNight ? 'color: #a5b4fc;' : ''}">${job.task}</div>
                        ${job.partner ? `<div class="job-partner" style="${job.isNight ? 'color: #818cf8;' : ''}">${job.partner}</div>` : ''}
                    </div>
                `}).join('');
            }

            // 3-4 jobs: Compact display
            if (jobs.length <= 4) {
                return jobs.map(job => {
                    const statusColor = getJobStatusColor(job.jobStatus);
                    const nightBg = job.isNight ? 'background: #312e81;' : '';
                    const borderColor = job.isNight ? '#6366f1' : statusColor;
                    return `
                    <div class="job-entry compact ${job.isNight ? 'night-job' : ''}" onclick="openPanel('${tech.id}', ${dayIndex})" style="${nightBg} border-left-color: ${borderColor};">
                        <div class="job-line">
                            <span class="job-q" style="${job.isNight ? 'color: #a5b4fc;' : ''}">${job.isNight ? 'üåô ' : ''}<span style="display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: ${statusColor}; margin-right: 3px;"></span>${job.q}</span>
                            <span class="job-location" style="${job.isNight ? 'color: #c7d2fe;' : ''}">${job.location}</span>
                        </div>
                        <div class="job-task" style="${job.isNight ? 'color: #a5b4fc;' : ''}">${job.task}</div>
                    </div>
                `}).join('');
            }

            // 5+ jobs: Chip display
            const visibleJobs = jobs.slice(0, 5);
            const overflow = jobs.length - 5;
            return `
                <div class="jobs-minimal" onclick="openPanel('${tech.id}', ${dayIndex})">
                    ${visibleJobs.map(job => {
                        const statusColor = getJobStatusColor(job.jobStatus);
                        return `
                        <div class="job-chip" style="${job.isNight ? 'background: #312e81; color: #a5b4fc;' : ''} border-left: 3px solid ${statusColor};">${job.isNight ? 'üåô' : ''}${job.q}</div>
                    `}).join('')}
                    ${overflow > 0 ? `<div class="job-chip jobs-overflow">+${overflow}</div>` : ''}
                </div>
            `;
        }

        // Main render
        function renderSchedule() {
            const grid = document.getElementById('scheduleGrid');
            const workstreamFilter = document.getElementById('workstreamFilter').value;
            const clientFilter = document.getElementById('clientFilter').value;
            const search = document.getElementById('searchInput').value.toLowerCase();

            // Update week display
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('weekDisplay').textContent = `Week ${getWeekNumber(currentWeekStart)} ¬∑ ${months[currentWeekStart.getMonth()]} ${currentWeekStart.getFullYear()}`;

            // Grid columns
            const numDays = showWeekends ? 7 : 5;
            grid.className = `schedule-grid${showWeekends ? ' show-weekends' : ''}`;

            // Build header
            let html = '<div class="grid-header">';
            html += '<div class="grid-header-cell">Technician</div>';

            for (let i = 0; i < numDays; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + i);
                const f = formatDate(date);
                const todayClass = isToday(date) ? ' today' : '';
                const weekendClass = (i >= 5) ? ' weekend' : '';
                const clickHandler = currentUser ? `onclick="showBulkEntryModal(${i})"` : '';
                const cursorStyle = currentUser ? 'cursor: pointer;' : '';
                html += `
                    <div class="grid-header-cell${todayClass}${weekendClass}" ${clickHandler} style="${cursorStyle}" title="${currentUser ? 'Click to add bulk status' : ''}">
                        <div class="day-name">${f.dayName}</div>
                        <div class="day-date">${f.dayNum}</div>
                        <div class="day-month">${f.month}</div>
                    </div>
                `;
            }
            html += '</div>';

            // Filter technicians
            let techs = TECHNICIANS.filter(t => {
                if (workstreamFilter !== 'all' && t.workstream !== workstreamFilter) return false;
                
                // Enhanced search - check name, role, and all jobs
                if (search) {
                    const nameMatch = t.name.toLowerCase().includes(search);
                    const roleMatch = t.role?.toLowerCase().includes(search);
                    const postcodeMatch = t.postcode?.toLowerCase().includes(search);
                    
                    // Search in all jobs
                    let jobMatch = false;
                    for (let day in t.schedule) {
                        const jobs = t.schedule[day]?.jobs || [];
                        for (const job of jobs) {
                            if (job.q?.toLowerCase().includes(search) ||
                                job.location?.toLowerCase().includes(search) ||
                                job.task?.toLowerCase().includes(search) ||
                                job.client?.toLowerCase().includes(search) ||
                                job.partner?.toLowerCase().includes(search)) {
                                jobMatch = true;
                                break;
                            }
                        }
                        if (jobMatch) break;
                    }
                    
                    if (!nameMatch && !roleMatch && !postcodeMatch && !jobMatch) return false;
                }
                
                if (clientFilter !== 'all') {
                    let hasClient = false;
                    for (let day in t.schedule) {
                        const jobs = t.schedule[day]?.jobs || [];
                        if (jobs.some(j => j.client === clientFilter)) hasClient = true;
                    }
                    if (!hasClient) return false;
                }
                return true;
            });

            // Group by workstream
            const workstreams = ['Project Delivery', 'Clean Water', 'Waste Water', 'Contingent Resources', 'Management & Admin'];
            const grouped = {};
            workstreams.forEach(ws => grouped[ws] = []);
            techs.forEach(t => {
                if (grouped[t.workstream]) grouped[t.workstream].push(t);
            });

            // Sort each workstream group by role hierarchy, then by name
            workstreams.forEach(ws => {
                grouped[ws].sort((a, b) => {
                    const rankA = getRoleRank(a.role);
                    const rankB = getRoleRank(b.role);
                    if (rankA !== rankB) return rankA - rankB;
                    // Same role rank, sort by name A-Z
                    return a.name.localeCompare(b.name);
                });
            });

            // Render rows
            let hasData = false;
            workstreams.forEach(ws => {
                if (grouped[ws].length === 0) return;
                if (workstreamFilter !== 'all' && workstreamFilter !== ws) return;

                hasData = true;
                html += `<div class="workstream-divider"><div class="workstream-header">${ws}</div></div>`;

                grouped[ws].forEach(tech => {
                    html += `<div class="person-row">`;
                    html += `
                        <div class="person-cell" onclick="openPanel('${tech.id}')">
                            <div class="person-name">${tech.name}</div>
                            <div class="person-role">${tech.role}</div>
                            <div class="person-meta">
                                <span class="person-tag">${tech.postcode}</span>
                            </div>
                        </div>
                    `;

                    for (let i = 0; i < numDays; i++) {
                        const weekendClass = (i >= 5) ? ' weekend' : '';
                        html += `<div class="day-cell${weekendClass}" onclick="openPanel('${tech.id}', ${i})">${renderDayCell(tech.schedule[i], tech, i)}</div>`;
                    }

                    html += '</div>';
                });
            });

            grid.innerHTML = html;

            // Show empty state if no data
            if (!hasData && !isLoading) {
                grid.innerHTML += `
                    <div style="grid-column: 1 / -1; padding: 3rem; text-align: center; color: var(--text-muted);">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìã</div>
                        <div style="font-size: 1rem; font-weight: 600; margin-bottom: 0.25rem;">No technicians found</div>
                        <div style="font-size: 0.875rem;">Add technicians in Supabase to get started</div>
                    </div>
                `;
            }
        }

        // Panel
        function openPanel(techId, dayIndex = null) {
            const tech = TECHNICIANS.find(t => t.id === techId);
            if (!tech) return;

            const panel = document.getElementById('sidePanel');
            const overlay = document.getElementById('panelOverlay');
            const title = document.getElementById('panelTitle');
            const subtitle = document.getElementById('panelSubtitle');
            const body = document.getElementById('panelBody');
            const footer = document.getElementById('panelFooter');

            title.textContent = tech.name;

            if (dayIndex !== null) {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + dayIndex);
                subtitle.textContent = formatDate(date).full;

                const dayData = tech.schedule[dayIndex];
                const hasData = dayData?.status || (dayData?.jobs && dayData.jobs.length > 0);

                if (dayData?.status) {
                    const config = STATUS_CONFIG[dayData.status];
                    body.innerHTML = `
                        <div class="panel-section">
                            <div class="panel-section-title">Status</div>
                            <div class="status-entry ${config.isWork ? 'work' : 'non-work'} status-${dayData.status}" style="margin: 0;">
                                <span class="status-icon">${config.icon}</span>
                                <span>${dayData.text || config.label}</span>
                            </div>
                        </div>
                        <div class="panel-section">
                            <div class="panel-section-title">Technician</div>
                            <div class="panel-field">
                                <div class="panel-label">Role</div>
                                <div class="panel-value">${tech.role}</div>
                            </div>
                            <div class="panel-field">
                                <div class="panel-label">Workstream</div>
                                <div class="panel-value">${tech.workstream}</div>
                            </div>
                            <div class="panel-field">
                                <div class="panel-label">Line Manager</div>
                                <div class="panel-value">${tech.lineManager || '‚Äî'}</div>
                            </div>
                        </div>
                    `;
                } else if (dayData?.jobs && dayData.jobs.length > 0) {
                    const getJobColor = (job) => {
                        if (job.isNight) {
                            // Night jobs - use indigo background but show status color for the badge
                            const statusColor = job.jobStatus === 'inactive' ? '#ef4444' : job.jobStatus === 'pending' ? '#f59e0b' : '#22c55e';
                            return { bg: '#312e81', border: '#6366f1', text: '#c7d2fe', statusColor: statusColor };
                        }
                        switch(job.jobStatus) {
                            case 'inactive': return { bg: 'rgba(239,68,68,0.1)', border: '#ef4444', text: 'var(--text-primary)', statusColor: '#ef4444' };
                            case 'pending': return { bg: 'rgba(245,158,11,0.1)', border: '#f59e0b', text: 'var(--text-primary)', statusColor: '#f59e0b' };
                            case 'live':
                            default: return { bg: 'rgba(34,197,94,0.1)', border: '#22c55e', text: 'var(--text-primary)', statusColor: '#22c55e' };
                        }
                    };
                    body.innerHTML = `
                        <div class="panel-section">
                            <div class="panel-section-title">Jobs (${dayData.jobs.length})</div>
                            <div class="panel-jobs-list">
                                ${dayData.jobs.map(job => {
                                    const colors = getJobColor(job);
                                    const statusText = job.jobStatus === 'inactive' ? 'Inactive' : job.jobStatus === 'pending' ? 'Pending' : 'Live';
                                    const statusLabel = job.isNight ? `üåô Night ¬∑ ${statusText}` : statusText;
                                    return `
                                    <div class="panel-job-card" style="background: ${colors.bg}; border-left: 3px solid ${colors.border};">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div class="panel-job-q" style="color: ${job.isNight ? '#a5b4fc' : 'var(--brand-primary)'};">${job.isNight ? 'üåô ' : ''}${job.q}</div>
                                            <span style="font-size: 0.625rem; padding: 0.125rem 0.5rem; border-radius: 1rem; background: ${colors.statusColor}; color: white; font-weight: 600;">${statusLabel}</span>
                                        </div>
                                        <div class="panel-job-client" style="color: ${colors.text};">${job.client}</div>
                                        <div class="panel-job-details">
                                            <div class="panel-job-detail">
                                                <div class="panel-job-detail-label" style="${job.isNight ? 'color: #a5b4fc;' : ''}">Location</div>
                                                <div class="panel-job-detail-value" style="color: ${colors.text};">${job.location}</div>
                                            </div>
                                            <div class="panel-job-detail">
                                                <div class="panel-job-detail-label" style="${job.isNight ? 'color: #a5b4fc;' : ''}">Task</div>
                                                <div class="panel-job-detail-value" style="color: ${colors.text};">${job.task}</div>
                                            </div>
                                            ${job.partner ? `
                                            <div class="panel-job-detail" style="grid-column: span 2;">
                                                <div class="panel-job-detail-label" style="${job.isNight ? 'color: #a5b4fc;' : ''}">Working With</div>
                                                <div class="panel-job-detail-value" style="color: ${colors.text};">${job.partner}</div>
                                            </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                        <div class="panel-section">
                            <div class="panel-section-title">Technician</div>
                            <div class="panel-field">
                                <div class="panel-label">Base Postcode</div>
                                <div class="panel-value">${tech.postcode}</div>
                            </div>
                            <div class="panel-field">
                                <div class="panel-label">Line Manager</div>
                                <div class="panel-value">${tech.lineManager || '‚Äî'}</div>
                            </div>
                        </div>
                    `;
                } else {
                    body.innerHTML = `
                        <div class="panel-section">
                            <div class="panel-section-title">No Schedule</div>
                            <p style="color: var(--text-muted); font-size: 0.875rem;">No jobs or status assigned for this day.</p>
                        </div>
                    `;
                }

                // Footer with edit buttons
                if (currentUser) {
                    // Check if there's previous entry for this tech
                    const showCopyBtn = hasPreviousEntry(tech.id, dayIndex);
                    const copyPrevBtn = showCopyBtn ? `<button class="panel-btn panel-btn-secondary" onclick="copyPreviousEntry('${tech.id}', ${dayIndex})" title="Copy previous day's entries">üìã Copy</button>` : '';
                    
                    if (hasData) {
                        footer.innerHTML = `
                            <button class="panel-btn panel-btn-secondary" onclick="showAddEntryModal('${tech.id}', ${dayIndex})">+ Add</button>
                            <button class="panel-btn panel-btn-secondary" onclick="showEditEntryModal('${tech.id}', ${dayIndex})">Edit</button>
                            ${copyPrevBtn}
                            <button class="panel-btn panel-btn-primary" onclick="showEditTechnicianModal('${tech.id}')">Tech</button>
                        `;
                    } else {
                        footer.innerHTML = `
                            <button class="panel-btn panel-btn-secondary" onclick="showAddEntryModal('${tech.id}', ${dayIndex})">Add Entry</button>
                            ${copyPrevBtn}
                            <button class="panel-btn panel-btn-primary" onclick="showEditTechnicianModal('${tech.id}')">Tech</button>
                        `;
                    }
                } else {
                    footer.innerHTML = `
                        <button class="panel-btn panel-btn-secondary" onclick="showLoginModal()">Sign in to edit</button>
                    `;
                }
            } else {
                subtitle.textContent = tech.role;
                body.innerHTML = `
                    <div class="panel-section">
                        <div class="panel-section-title">Details</div>
                        <div class="panel-field">
                            <div class="panel-label">Workstream</div>
                            <div class="panel-value">${tech.workstream}</div>
                        </div>
                        <div class="panel-field">
                            <div class="panel-label">Base Postcode</div>
                            <div class="panel-value">${tech.postcode}</div>
                        </div>
                        <div class="panel-field">
                            <div class="panel-label">Line Manager</div>
                            <div class="panel-value">${tech.lineManager || '‚Äî'}</div>
                        </div>
                    </div>
                `;

                // Footer for technician view
                if (currentUser) {
                    footer.innerHTML = `
                        <button class="panel-btn panel-btn-primary" onclick="showEditTechnicianModal('${tech.id}')">Edit Technician</button>
                    `;
                } else {
                    footer.innerHTML = `
                        <button class="panel-btn panel-btn-secondary" onclick="showLoginModal()">Sign in to edit</button>
                    `;
                }
            }

            panel.classList.add('open');
            overlay.classList.add('open');
        }

        function closePanel() {
            document.getElementById('sidePanel').classList.remove('open');
            document.getElementById('panelOverlay').classList.remove('open');
        }

        // Keyboard
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closePanel();
        });

        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Supabase
            try {
                if (window.supabase) {
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log('Supabase connected');
                    
                    // Listen for auth changes
                    supabaseClient.auth.onAuthStateChange((event, session) => {
                        currentUser = session?.user || null;
                        updateAuthUI();
                    });

                    // Setup real-time sync
                    setupRealtimeSync();
                } else {
                    console.error('Supabase library not loaded');
                }
            } catch (e) {
                console.error('Error initializing Supabase:', e);
            }
            
            initDarkMode();
            await checkAuth();
            await loadAllData();
        });
    </script>
</body>
</html>
